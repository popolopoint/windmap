<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>コース作るくん v5.5.1</title>
<style>
:root{ --red:#ff3b30; --blue:#0000ff; --yellow:#ffff00; --green:#00aa00; --purple:#9900ff; --pink:#ff00ff; --teal:#00ffff; }
body { font-family: sans-serif; margin:10px; color:#222; background:#f4f4f9; }
h2 { margin:0; font-size:18px; }
#version { position:absolute; right:12px; top:12px; color:#666; font-size:12px; }

/* 入力・コントロール */
.card { background:white; padding:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:10px; }
.flex { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
input, select { font-size: 18px; padding: 8px; border-radius:6px; border:1px solid #ccc; }
.big-input { font-size: 24px; width: 100px; font-weight: bold; }
label { font-size:12px; color:#666; display:block; }

/* ボタン */
button { font-size: 18px; padding: 10px; border-radius:6px; border:none; color:white; cursor:pointer; font-weight:bold; }
#calcBtn { background: #1976d2; flex-grow:1; font-size:24px; }
#btnShareAll { background:#555; }
.btn-nudge { background:#444; width:44px; height:44px; padding:0; }

/* 地点ボタン */
.pointBox { border-radius:50%; width:50px; height:50px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; font-size: 1.2em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

/* マップ */
#map { width:100%; height:450px; border-radius:8px; margin-top:10px; }

/* 履歴エリア */
#historyArea { margin-top:8px; }
.hist-btn { background:#888; font-size:12px; padding:5px 10px; margin-right:5px; }

#sausageSettings, #jwsaSettings { display:none; }
</style>
</head>
<body>

<div id="version">v5.5.1</div>
<h2>コース作るくん</h2>

<div class="card">
  <div class="flex">
    <div><label>風向(°)</label><input type="number" id="wind" class="big-input" value="0"></div>
    <div><label>距離(m)</label><input type="number" id="dist" class="big-input" value="500"></div>
    <div><label>角度(°)</label><input type="number" id="theta" class="big-input" value="5"></div>
    <div><label>コース</label>
      <select id="courseSelect" style="font-size:20px;">
        <option value="mcourse">Ｍ</option>
        <option value="figure8">F8</option>
        <option value="sausage">ソーセージ</option>
        <option value="5jibe">5J</option>
        <option value="jwsa">JWSA</option>
      </select>
    </div>
  </div>

  <div id="sausageSettings" class="flex" style="margin-top:8px;">
    <div><label>上(m)</label><input type="number" id="upDist" value="1000" style="width:80px;"></div>
    <div><label>下(m)</label><input type="number" id="downDist" value="50" style="width:80px;"></div>
  </div>
</div>

<div class="card">
  <div class="flex" style="justify-content: space-between;">
    <div>
      <label>基準にする地点を選択</label>
      <select id="originPoint" style="border:2px solid var(--red); font-weight:bold;">
        <option value="A">A点を設定</option>
        <option value="B">B点を設定</option>
        <option value="C">C点を設定</option>
        <option value="D">D点を設定</option>
        <option value="E">E点を設定</option>
        <option value="S">S点を設定</option>
      </select>
    </div>
    <button id="btnSetCurrent" style="background:var(--red);">現在地を適用</button>
  </div>
  <div style="font-size:11px; color:#888; margin-top:4px;">※「B点を設定」にして現在地を押すと、そこがB点になるようにA点を逆算します</div>
</div>

<div class="card">
  <div class="flex">
    <div style="display:grid; grid-template-columns: repeat(3, 44px); gap:2px;">
      <div></div><button class="btn-nudge" onclick="nudgeA(1,0)">↑</button><div></div>
      <button class="btn-nudge" onclick="nudgeA(0,-1)">←</button>
      <button class="btn-nudge" style="background:var(--red);" onclick="alert('中心: A点')">A</button>
      <button class="btn-nudge" onclick="nudgeA(0,1)">→</button>
      <div></div><button class="btn-nudge" onclick="nudgeA(-1,0)">↓</button><div></div>
    </div>
    <div style="flex-grow:1; display:flex; flex-direction:column; gap:5px;">
      <div class="flex">
        <button id="calcBtn">計算</button>
        <button id="btnShareAll">一括送信</button>
      </div>
      <div id="historyArea">
        <span style="font-size:11px;">履歴:</span>
        <button class="hist-btn" onclick="loadHist(0)" id="h0">-</button>
        <button class="hist-btn" onclick="loadHist(1)" id="h1">-</button>
        <button class="hist-btn" onclick="loadHist(2)" id="h2">-</button>
      </div>
    </div>
  </div>
  <div style="margin-top:8px; font-size:13px;">
    A: <input type="number" id="latA" step="any" style="width:100px; font-size:12px;"> 
    <input type="number" id="lngA" step="any" style="width:100px; font-size:12px;">
  </div>
</div>

<div id="coordsContainer" class="flex" style="justify-content:center; margin-bottom:10px;">
  <div class="pointBox" id="btnA" style="background:var(--red);">A</div>
  <div class="pointBox" id="btnB" style="background:var(--blue);">B</div>
  <div class="pointBox" id="btnC" style="background:var(--yellow); color:#000;">C</div>
  <div class="pointBox" id="btnD" style="background:var(--green);">D</div>
  <div class="pointBox" id="btnE" style="background:var(--purple);">E</div>
  <div class="pointBox" id="btnS" style="background:var(--blue); display:none;">S</div>
</div>

<div id="map"></div>

<script>
let map, circles={}, markersLabel={}, polylines=[], points={A:null,B:null,C:null,D:null,E:null,F:null,G:null,S:null};
const COLORS = { A:'#ff3b30', B:'#0000ff', C:'#ffff00', D:'#00aa00', E:'#9900ff', S:'#0000ff' };
let history = JSON.parse(localStorage.getItem('windmap_hist') || '[]');

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat:26.33,lng:127.91 }, zoom:14 });
  updateHistDisplay();

  // 連携受取
  const p = new URLSearchParams(window.location.search);
  if(p.get('heading')) document.getElementById('wind').value = p.get('heading');
  if(p.get('lat') && p.get('lng')) {
    updateAPoint(parseFloat(p.get('lat')), parseFloat(p.get('lng')));
    calculateCourse(true);
  }

  map.addListener('click', (e) => setPointByMode(e.latLng.lat(), e.latLng.lng()));
}

function updateAPoint(lat, lng) {
  document.getElementById('latA').value = lat.toFixed(6);
  document.getElementById('lngA').value = lng.toFixed(6);
  points.A = {lat, lng};
}

// v5.5.1 目玉機能: 指定した地点(Bなど)からAを逆算する
function setPointByMode(lat, lng) {
  const mode = document.getElementById('originPoint').value;
  if(mode === 'A') {
    updateAPoint(lat, lng);
  } else {
    // 逆計算ロジック
    const wind = parseFloat(document.getElementById('wind').value) || 0;
    const dist = parseFloat(document.getElementById('dist').value) || 0;
    const theta = parseFloat(document.getElementById('theta').value) || 0;
    const isPort = true; // 基本ポートで計算して後で調整
    
    // A点から各点への方位を算出
    let bearingToTarget = 0;
    let distToTarget = dist;

    if(mode==='B') bearingToTarget = isPort ? wind+90+theta : wind+270-theta;
    if(mode==='C') bearingToTarget = wind; // 単純化のためCは風上直上とする(ソーセージ等)
    if(mode==='S') bearingToTarget = isPort ? wind+90+theta : wind+270-theta;

    // 逆方向に移動してA点を割り出す
    const backBearing = (bearingToTarget + 180) % 360;
    const calculatedA = movePoint(lat, lng, distToTarget, backBearing);
    updateAPoint(calculatedA.lat, calculatedA.lng);
  }
  calculateCourse(true);
}

function movePoint(lat,lng,dist,bearing){
  const R=6378137, brng=(bearing%360)*Math.PI/180;
  const φ1=lat*Math.PI/180, λ1=lng*Math.PI/180, δ=dist/R;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(brng));
  const λ2=λ1+Math.atan2(Math.sin(brng)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return {lat: φ2*180/Math.PI, lng: λ2*180/Math.PI};
}

// v5.3.1 微調整機能 (1クリック1メートル)
function nudgeA(dn, de) {
  const lat = parseFloat(document.getElementById('latA').value);
  const lng = parseFloat(document.getElementById('lngA').value);
  if(isNaN(lat)) return;
  const newLat = lat + (dn * 0.000009);
  const newLng = lng + (de * 0.000009 / Math.cos(lat * Math.PI / 180));
  updateAPoint(newLat, newLng);
  calculateCourse(true);
}

function calculateCourse(isPort){
  const latA=parseFloat(document.getElementById('latA').value), lngA=parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA)) return;
  
  const wind=parseFloat(document.getElementById('wind').value)||0, dist=parseFloat(document.getElementById('dist').value)||0;
  const theta=parseFloat(document.getElementById('theta').value)||0, course=document.getElementById('courseSelect').value;

  polylines.forEach(p => p.setMap(null)); polylines = [];
  Object.keys(points).forEach(k => { if(circles[k])circles[k].setMap(null); if(markersLabel[k])markersLabel[k].setMap(null); });
  
  points.A = {lat:latA, lng:lngA};
  const isSau = (course==='sausage'), isJW = (course==='jwsa');

  document.getElementById('btnS').style.display = isSau ? 'flex' : 'none';
  document.getElementById('btnD').style.display = (isSau || isJW) ? 'none' : 'flex';
  document.getElementById('btnE').style.display = (isSau || isJW) ? 'none' : 'flex';

  if(isSau){
    const bS = wind + (isPort?90+theta:270-theta);
    points.S = movePoint(points.A.lat, points.A.lng, dist, bS);
    const mid = {lat:(points.A.lat+points.S.lat)/2, lng:(points.A.lng+points.S.lng)/2};
    points.B = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('upDist').value), wind);
    points.C = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('downDist').value), (wind+180)%360);
    polylines.push(new google.maps.Polyline({path:[points.A, points.S, points.B, points.C, points.A], strokeColor:'#444', strokeWeight:2, map}));
  } else {
    points.B = movePoint(points.A.lat, points.A.lng, dist, isPort?wind+90+theta:wind+270-theta);
    points.C = movePoint(points.B.lat, points.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
    points.D = movePoint(points.C.lat, points.C.lng, dist, isPort?wind+90+theta:wind+270-theta);
    points.E = movePoint(points.D.lat, points.D.lng, dist, isPort?wind+270-theta:wind+90+theta);
    polylines.push(new google.maps.Polyline({path:[points.A,points.B,points.C,points.D,points.E], strokeColor:'#444', strokeWeight:2, map}));
  }
  
  Object.keys(points).forEach(k => { if(points[k]) drawPoint(k, points[k], COLORS[k]); });
  saveToHist();
}

function drawPoint(label,pos,color){
  circles[label] = new google.maps.Circle({ map, center:pos, radius:12, strokeColor:color, fillColor:color, fillOpacity:0.6 });
  markersLabel[label] = new google.maps.Marker({ position:pos, map, label:{text:label, color:'#fff', fontWeight:"bold"} });
}

// v5.3.1 履歴管理
function saveToHist(){
  const data = { wind:document.getElementById('wind').value, dist:document.getElementById('dist').value, latA:document.getElementById('latA').value, lngA:document.getElementById('lngA').value, course:document.getElementById('courseSelect').value };
  if(JSON.stringify(history[0]) === JSON.stringify(data)) return;
  history.unshift(data);
  history = history.slice(0,3);
  localStorage.setItem('windmap_hist', JSON.stringify(history));
  updateHistDisplay();
}

function updateHistDisplay(){
  history.forEach((h, i) => {
    const btn = document.getElementById('h'+i);
    btn.textContent = `${h.course} / ${h.wind}°`;
  });
}

function loadHist(i){
  const h = history[i]; if(!h) return;
  document.getElementById('wind').value = h.wind;
  document.getElementById('dist').value = h.dist;
  document.getElementById('courseSelect').value = h.course;
  updateAPoint(parseFloat(h.latA), parseFloat(h.lngA));
  calculateCourse(true);
}

document.getElementById('btnSetCurrent').onclick = () => {
  navigator.geolocation.getCurrentPosition(p => setPointByMode(p.coords.latitude, p.coords.longitude));
};
document.getElementById('calcBtn').onclick = () => calculateCourse(true);
document.getElementById('btnShareAll').onclick = () => {
  let t = "【コース座標】\n";
  Object.keys(points).forEach(k => { if(points[k]) t += `${k}: ${points[k].lat.toFixed(6)},${points[k].lng.toFixed(6)}\n`; });
  navigator.share ? navigator.share({text:t}) : alert(t);
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>
</body>
</html>
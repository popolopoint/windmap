<!DOCTYPE html>
<html>
<head>
    <title>hoseidon-v3.1.7-çœŸã®é¢¨å‘è£œæ­£ã©ã‚“H</title>
    <style>
        /* =======================================================
           v3.1.6: ãƒœã‚¿ãƒ³ã¨ã‚¿ã‚¤ãƒˆãƒ«ä»¥å¤–ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’ç´„2å€ã«èª¿æ•´
           ======================================================= */
        body { 
            font-size: 250%; /* åŸºæº–ã‚µã‚¤ã‚ºã‚’v3.1.4ã®250%ã«æˆ»ã™ */
            margin: 10px;
        }
        h1 {
            margin-bottom: 20px;
        }
        #map { height: 65vh; width: 100%; margin-top: 20px; }
        
        /* â˜…â˜…â˜… 1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± (ã‚¿ã‚¤ãƒˆãƒ«ä»¥å¤–ã®æ–‡å­—ã‚’æ‹¡å¤§) â˜…â˜…â˜… */
        .version-info {
            font-size: 1.0em; /* ä»¥å‰ã® 0.4em ã‹ã‚‰2å€ã«æ‹¡å¤§ */
            font-weight: normal;
            color: #666;
            margin-left: 10px;
        }
        
        /* â˜…â˜…â˜… 2. Bç‚¹é¸æŠã®ãƒ©ãƒ™ãƒ«æ–‡å­— (æ‹¡å¤§) â˜…â˜…â˜… */
        #bPointSelection {
            font-size: 1.2em; /* ä»¥å‰ã® 0.4em ã‹ã‚‰2å€ã«æ‹¡å¤§ */
            margin-bottom: 30px;
        }

        /* -------------------------------------------------------
           ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« (ã‚µã‚¤ã‚ºç¶­æŒ)
           ------------------------------------------------------- */
        /* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        #setLocationButton, #captureHeadingButton, #startCompassButton, #captureWindHButton, #copyWindHButton, #sendWindHButton { 
            padding: 20px 30px; 
            font-size: 1.8em; /* ã‚µã‚¤ã‚ºã¯ç¶­æŒ */
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin-bottom: 20px; 
            
            display: block; 
            width: 90%;     
            margin-left: auto; 
            margin-right: auto;
            text-align: center;
        }





/* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’å«ã‚€ãƒ©ãƒ™ãƒ«å…¨ä½“ã®è¨­å®š */
#bPointSelection label {
    display: flex;
    align-items: center;    /* ç¸¦æ–¹å‘ã®ä¸­å¤®æƒãˆ */
    font-size: 1.0em;       /* æ–‡å­—ã‚µã‚¤ã‚º */
    margin-bottom: 30px;    /* é¸æŠè‚¢é–“ã®ä½™ç™½ï¼ˆé‡ãªã‚Šé˜²æ­¢ï¼‰ */
    cursor: pointer;
    line-height: 1.2;       /* è¡Œã®é«˜ã•ã‚’å®‰å®šã•ã›ã‚‹ */
}

/* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆ3å€ã‚µã‚¤ã‚ºï¼‰ã®èª¿æ•´ */
#bPointSelection input[type="radio"] {
    transform: scale(3.0);
    transform-origin: center; /* æ‹¡å¤§ã®åŸºæº–ã‚’ä¸­å¿ƒã«è¨­å®š */
    margin-right: 35px;      /* å³å´ã®æ–‡å­—ã¨ã®é–“éš” */
    margin-left: 20px;       /* å·¦å´ã®ä½™ç™½ */
    
    /* ä¸‹å¯„ã›ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã®å¾®èª¿æ•´ */
    vertical-align: middle; 
    position: relative;
    top: -2px;               /* æ‹¡å¤§ã«ã‚ˆã‚‹è¦‹ãŸç›®ã®ã‚ºãƒ¬ã‚’æ•°ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã§å¾®èª¿æ•´ */
}


        /* å€‹åˆ¥ãƒœã‚¿ãƒ³ã®ã‚«ãƒ©ãƒ•ãƒ«ãªè‰²è¨­å®š (å¤‰æ›´ãªã—) */
        #setLocationButton { background-color: #d9534f; color: white; } 
        #startCompassButton { background-color: #ffc107; color: black; } 
        #captureHeadingButton { background-color: #28a745; color: white; } 
        #captureWindHButton { background-color: #5e2b97; color: white; } 
        #copyWindHButton { background-color: #e83e8c; color: white; } 
        #sendWindHButton { background-color: #6610f2; color: white; } 

        /* -------------------------------------------------------
           çµæœè¡¨ç¤ºçª“ã®ã‚¹ã‚¿ã‚¤ãƒ« (æ‹¡å¤§)
           ------------------------------------------------------- */
        #result { 
            margin-top: 20px; padding: 20px; border: 1px solid #007bff; 
            background-color: #e9f5ff; border-radius: 5px; 
            font-size: 0.8em; /* ä»¥å‰ã® 0.4em ã‹ã‚‰2å€ã«æ‹¡å¤§ */
            margin-bottom: 20px;
        }
        #result h3 { color: #007bff; font-size: 1.0em; } 
        
        /* ã‚»ãƒ³ã‚µãƒ¼çª“ã¨é¢¨å‘Hçª“ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        #sensorContainer { display: flex; gap: 20px; margin-top: 20px; margin-bottom: 20px; }

        /* ã‚»ãƒ³ã‚µãƒ¼çª“ã®ã‚¹ã‚¿ã‚¤ãƒ« (æ‹¡å¤§) */
        #compassWindow {
            flex: 1;
            padding: 20px;
            border: 2px solid #5cb85c;
            background-color: #f0fff0;
            border-radius: 5px;
            text-align: center;
            font-size: 1.0em; /* ä»¥å‰ã® 0.8em ã‹ã‚‰2å€ã«æ‹¡å¤§ */
        }
        
        /* é¢¨å‘Hè¡¨ç¤ºçª“ã®ã‚¹ã‚¿ã‚¤ãƒ« (æ‹¡å¤§) */
        #windHWindow {
            flex: 1;
            padding: 20px;
            border: 2px solid #000;
            background-color: #f7f7f7;
            border-radius: 5px;
            text-align: center;
            font-size: 1.0em; /* ä»¥å‰ã® 0.8em ã‹ã‚‰2å€ã«æ‹¡å¤§ */
        }
        
        /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–¹ä½ (æœªè£œæ­£) */
        #headingRealtime { 
            font-size: 1.5em;
            color: #4CAF50; font-weight: bold; 
        }
        /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–¹ä½ (è£œæ­£æ¸ˆã¿) */
        #headingCorrected { 
            font-size: 1.5em; 
            color: #007bff; font-weight: bold; margin-top: 5px; 
        }
        #recordedErrorDisplay { font-weight: bold; color: #FF6347; }
        
        /* é¢¨å‘Hã®æœ€çµ‚çµæœè¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        #windHResultDisplay {
            font-size: 1.5em; 
            color: #d9534f;
            font-weight: bold;
            margin-top: 10px;
        }
        /* ------------------------------------------------------- */



/* ã€ŒAç‚¹ã¨Bç‚¹ã‚’è¨­å®šå¾Œâ€¦ã€ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’2å€ã«ã™ã‚‹ */
.initial-prompt {
    font-size: 1.5em;    /* 2å€ã®å¤§ãã• */
    font-weight: bold;   /* å¤ªå­—ã«ã™ã‚‹ */
    line-height: 1.5;    /* è¡Œé–“ã‚’åºƒã’ã¦èª­ã¿ã‚„ã™ãã™ã‚‹ */
    color: #333;         /* æ–‡å­—è‰²ã‚’å°‘ã—æ¿ƒãã™ã‚‹ */
    margin: 20px 0;      /* ä¸Šä¸‹ã«ä½™ç™½ã‚’ä½œã‚‹ */
}

/* å¤ªå­—éƒ¨åˆ†ï¼ˆ**ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®ã‚’è¨˜éŒ²**ï¼‰ã‚’ã•ã‚‰ã«å¼·èª¿ã™ã‚‹å ´åˆ */
.initial-prompt strong {
    color: #ff0000;      /* ã“ã“ã ã‘èµ¤è‰²ã«ã™ã‚‹ */
    text-decoration: underline; /* ä¸‹ç·šã‚’å¼•ã */
}




/* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–¹ä½ã‚„è¨ˆç®—çµæœãŒå«ã¾ã‚Œã‚‹ã‚¨ãƒªã‚¢å…¨ä½“ã‚’ä¸€æ‹¬æ‹¡å¤§ */
#result {
    font-size: 1.0em;    /* å…¨ä½“ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’2å€ã« */
    line-height: 1.6;    /* è¡Œé–“ã‚’åºƒã’ã¦é‡ãªã‚Šã‚’é˜²æ­¢ */
}

/* ãã®ä¸­ã®åŒºåˆ‡ã‚Šç·šï¼ˆ---ï¼‰ã‚‚å°‘ã—å¤ªãã—ã¦è¦‹ã‚„ã™ãã™ã‚‹ */
#result hr {
    border: 1px solid #ccc;
    margin: 20px 0;
}

/* è£œæ­£æ¸ˆã¿é¢¨å‘ã®å¤§ããªè¦‹å‡ºã—éƒ¨åˆ†ï¼ˆğŸ¯ã®è¡Œãªã©ï¼‰ */
#result h3, #result .status-area {
    font-size: 1.2em;    /* 2å€ã«ã—ãŸä¸Šã§ã•ã‚‰ã«1.2å€ï¼ˆè¨ˆ2.4å€ï¼‰ã«å¼·èª¿ */
    color: #000080;      /* æ¿ƒã„ç´ºè‰²ã§è¦‹ã‚„ã™ã */
}

/* ã€Œæ–¹ä½ã‚’æ±ºå®šã—ã¦...ã€ãªã©ã®å¼·èª¿æ–‡å­—ï¼ˆ** **ã®éƒ¨åˆ†ï¼‰ã‚’èµ¤ãç›®ç«‹ãŸã›ã‚‹ */
#result strong {
    color: #ff0000;
    font-size: 1.1em;
}





    </style>
</head>
<body>
    <h1>
        çœŸã®é¢¨å‘è£œæ­£ã©ã‚“H
        <span class="version-info">(hoseidon-v3.1.7) by Popolo</span>
    </h1>

    <button id="setLocationButton">ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«</button>
    
    <div id="bPointSelection">
        <strong>Bç‚¹ (ç›®çš„åœ°) ã®é¸æŠ:</strong>



        <label><input type="radio" name="b_option" value="kinjo" checked> é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="gushikawa"> å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="tap"> åœ°å›³ä¸Šã§ã‚¿ãƒƒãƒ—</label>
    </div>
   


<p id="bTapInstruction" style="display:none; color: red; font-weight: bold;">**åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦Bç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„**</p>

    <div id="result">
        <p class="initial-prompt">


Aç‚¹ã¨Bç‚¹ã‚’è¨­å®šå¾Œã€ã€Œæ–¹ä½æ±ºå®šã€ã§ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®ã‚’è¨˜éŒ²</p>
    </div>





    <button id="startCompassButton">æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’é–‹å§‹</button>
    <button id="captureHeadingButton" disabled>Bç‚¹ã«å‘ã‘ã‚¿ãƒƒãƒ—</button>
    
    <button id="captureWindHButton" disabled>é¢¨å‘Hã«å‘ã‘ã‚¿ãƒƒãƒ—</button>
    
    <button id="copyWindHButton" disabled>çœŸã®é¢¨å‘Hã‚’ã‚³ãƒ”ãƒ¼</button>
    <button id="sendWindHButton" disabled>çœŸã®é¢¨å‘Hã‚’é€ã‚‹</button>
    

    <div id="sensorContainer">
        <div id="compassWindow">
            <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–¹ä½ (æœªè£œæ­£ / è£œæ­£æ¸ˆã¿)</strong>
            <p id="headingRealtime">--</p>
            <p id="headingCorrected">---</p>
            <p style="font-size: 1.5em; margin-top: 10px;">
                **è¨˜éŒ²ã•ã‚ŒãŸèª¤å·®**: <span id="recordedErrorDisplay">æœªè¨˜éŒ²</span>
            </p>
            <p style="font-size: 1.5em;" id="compassStatus">ã‚»ãƒ³ã‚µãƒ¼ã¯åœæ­¢ä¸­ã§ã™ã€‚</p>
        </div>

        <div id="windHWindow">
            <strong>ğŸ¯ è£œæ­£æ¸ˆã¿ é¢¨å‘H (çœŸæ–¹ä½)</strong>
            <p id="windHResultDisplay">---</p>
            <p style="font-size: 1.0em;">
                ï¼ˆã€Œé¢¨å‘Hã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
            </p>
        </div>
    </div>


    <div id="map"></div>

    <script>
        const API_KEY = "AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk"; 

        const B_POINTS = { kinjo: { lat: 26.4454055, lng: 127.9209787, name: "é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€ (Bç‚¹)" },
            gushikawa: { lat: 26.3803176, lng: 127.8751869, name: "å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€ (Bç‚¹)" }
        };
        
        let map;
        let currentOriginA = null; 
        let currentDestinationB = null;
        let mapTapMode = false;
        
        let markerA = null;
        let markerB = null;
        let polyline = null;

        let lastReadHeading = null; 
        let isCompassRunning = false; 
        let recordedError = null; 
        let correctedWindHeadingResult = null; 


        // --- ã‚»ãƒ³ã‚µãƒ¼é–¢é€£ã®é–¢æ•° ---
        
        function toggleCompass() {
            const statusDiv = document.getElementById('compassStatus');
            const startButton = document.getElementById('startCompassButton');
            const captureButton = document.getElementById('captureHeadingButton');
            const windHButton = document.getElementById('captureWindHButton'); 
            const copyButton = document.getElementById('copyWindHButton'); 
            const sendButton = document.getElementById('sendWindHButton'); 

            if (isCompassRunning) {
                window.removeEventListener('deviceorientation', handleOrientation);
                isCompassRunning = false;
                startButton.textContent = 'æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’é–‹å§‹';
                statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ã¯åœæ­¢ä¸­ã§ã™ã€‚';
                captureButton.disabled = true;
                windHButton.disabled = true; 
                copyButton.disabled = true; 
                sendButton.disabled = true; 
                document.getElementById('headingRealtime').textContent = '--';
                document.getElementById('headingCorrected').textContent = '---';
            } else {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startSensorLogic(startButton, statusDiv, captureButton, windHButton, copyButton, sendButton);
                            } else {
                                statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            }
                        })
                        .catch(console.error);
                } else {
                    startSensorLogic(startButton, statusDiv, captureButton, windHButton, copyButton, sendButton);
                }
            }
        }
        
        function startSensorLogic(startButton, statusDiv, captureButton, windHButton, copyButton, sendButton) {
            window.addEventListener('deviceorientation', handleOrientation);
            isCompassRunning = true;
            startButton.textContent = 'æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã‚’åœæ­¢';
            statusDiv.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ç¨¼åƒä¸­ã€‚';
            captureButton.disabled = false;
            windHButton.disabled = false; 
            
            if (correctedWindHeadingResult === null) {
                 copyButton.disabled = true;
                 sendButton.disabled = true; 
            } else {
                 copyButton.disabled = false; 
                 sendButton.disabled = false; 
            }
        }

        function handleOrientation(event) {
            if (event.alpha === null) return;
            lastReadHeading = (360 - event.alpha + 360) % 360; 
            
            document.getElementById('headingRealtime').textContent = `${lastReadHeading.toFixed(1)}Â°`;
            
            if (recordedError !== null) {
                let correctedHeading = lastReadHeading - recordedError;
                correctedHeading = (correctedHeading % 360 + 360) % 360; 

                document.getElementById('headingCorrected').textContent = `${correctedHeading.toFixed(1)}Â°`;
                document.getElementById('compassStatus').textContent = `ã‚»ãƒ³ã‚µãƒ¼ç¨¼åƒä¸­ï¼ˆèª¤å·® ${recordedError.toFixed(2)}Â° è£œæ­£æ¸ˆã¿ï¼‰`;
            } else {
                document.getElementById('headingCorrected').textContent = '---';
                document.getElementById('compassStatus').textContent = 'ã‚»ãƒ³ã‚µãƒ¼ç¨¼åƒä¸­ï¼ˆèª¤å·®æœªè¨˜éŒ²ã®ãŸã‚è£œæ­£ãªã—ï¼‰';
            }
        }
        
        function captureWindHeading() {
            const windHDisplay = document.getElementById('windHResultDisplay');
            const copyButton = document.getElementById('copyWindHButton');
            const sendButton = document.getElementById('sendWindHButton'); 

            if (lastReadHeading === null || !isCompassRunning) {
                windHDisplay.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ã‚’èµ·å‹•ã—ã€å€¤ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚';
                copyButton.disabled = true;
                sendButton.disabled = true;
                return;
            }
            
            const rawWindHeading = lastReadHeading;
            
            if (recordedError === null) {
                windHDisplay.innerHTML = `èª¤å·®æœªè¨˜éŒ²: ${rawWindHeading.toFixed(1)}Â°<br> (è£œæ­£ãªã—)`;
                document.getElementById('windHWindow').style.borderColor = 'red';
                copyButton.disabled = true;
                sendButton.disabled = true;
                return;
            }

            let correctedWindHeading = rawWindHeading - recordedError;
            correctedWindHeading = (correctedWindHeading % 360 + 360) % 360;

            correctedWindHeadingResult = correctedWindHeading;
            copyButton.disabled = false;
            sendButton.disabled = false; 

            windHDisplay.innerHTML = `${correctedWindHeading.toFixed(1)}Â°`;
            document.getElementById('windHWindow').style.borderColor = '#007bff'; 
            
            document.getElementById('result').innerHTML = `
                <h3>âœ… é¢¨å‘Hã®æ–¹ä½å–å¾—å®Œäº†</h3>






                <p>æœªè£œæ­£å€¤: ${rawWindHeading.toFixed(1)}Â°</p>
                <p>è¨˜éŒ²ã•ã‚ŒãŸèª¤å·®: ${recordedError.toFixed(2)}Â°</p>
                <p><strong>çœŸã®é¢¨å‘H (è£œæ­£å¾Œ):</strong> <span style="font-size: 1.5em; color: #d9534f;">${correctedWindHeading.toFixed(1)}Â°</span></p>
            `;
        }
        
        function copyWindH() {
            if (correctedWindHeadingResult === null) {
                alert('å…ˆã«ã€Œé¢¨å‘Hã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ–¹ä½ã‚’æ±ºå®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const textToCopy = correctedWindHeadingResult.toFixed(1);

            navigator.clipboard.writeText(textToCopy).then(() => {
                const copyButton = document.getElementById('copyWindHButton');
                const originalText = 'è£œæ­£æ¸ˆã¿é¢¨å‘Hã‚’ã‚³ãƒ”ãƒ¼';
                
                copyButton.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†!';
                copyButton.style.backgroundColor = '#28a745';

                setTimeout(() => {
                    copyButton.textContent = originalText;
                    copyButton.style.backgroundColor = '#5cb85c';
                }, 1500);

            }).catch(err => {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
            });
        }

      









        
         /**
 * è£œæ­£æ¸ˆã¿é¢¨å‘Hã¨Aç‚¹ã®ç·¯åº¦çµŒåº¦ã‚’ã€åˆ¥ã‚¢ãƒ—ãƒª(windmap_latest.html=æœ€æ–°ç‰ˆ)ã«é€ä¿¡ãƒ»é€£æºã™ã‚‹
 */
function sendWindH() {
    if (correctedWindHeadingResult === null) {
        alert('å…ˆã«ã€Œé¢¨å‘Hã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ–¹ä½ã‚’æ±ºå®šã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (currentOriginA === null) {
        alert('å…ˆã«ã€Œç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«è¨­å®šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€Aç‚¹ã®ç·¯åº¦çµŒåº¦ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚');
        return; 
    }

    const valueToSend = correctedWindHeadingResult.toFixed(1);
    
    // â˜…é€ä¿¡å…ˆã‚’å›ºå®šåã€Œwindmap_latest.htmlã€ã«ã—ã¾ã™
    let targetUrl = `windmap_latest.html?heading=${valueToSend}`;

    try {
        const lat = currentOriginA.lat().toFixed(6); 
        const lng = currentOriginA.lng().toFixed(6); 
        targetUrl += `&lat=${lat}&lng=${lng}`;
    } catch (e) {
        alert('Aç‚¹ã®ç·¯åº¦çµŒåº¦å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        return;
    }

    // æœ€æ–°ç‰ˆã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ windmap_latest.html ã‚’é–‹ã
    window.open(targetUrl, '_blank');
    
    const sendButton = document.getElementById('sendWindHButton');
    sendButton.textContent = 'âœ… é€ä¿¡ã—ã¾ã—ãŸï¼';
    setTimeout(() => { sendButton.textContent = 'çœŸã®é¢¨å‘Hã‚’é€ã‚‹'; }, 1500);
}



























        /**
         * Bç‚¹ã«ã‚¹ãƒãƒ›ã‚’å‘ã‘ã¦æ–¹ä½ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€èª¤å·®ã‚’è¨ˆç®—ãƒ»è¨˜éŒ²ã™ã‚‹
         */
        function captureHeading() {
            if (lastReadHeading === null || !currentOriginA || !currentDestinationB) {
                 document.getElementById('result').innerHTML = `<h3>âŒ è¨˜éŒ²å¤±æ•—</h3><p style="color: red;">Aç‚¹/Bç‚¹ã®è¨­å®šã¾ãŸã¯ã‚»ãƒ³ã‚µãƒ¼å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
                 return;
            }

            const capturedValue = lastReadHeading;
            const trueBearing = calculateBearing(currentOriginA.lat(), currentOriginA.lng(), currentDestinationB.lat(), currentDestinationB.lng());
            
            let error = capturedValue - trueBearing;
            if (error > 180) { error -= 360; } else if (error < -180) { error += 360; }
            
            recordedError = error; 
            document.getElementById('recordedErrorDisplay').textContent = `${recordedError.toFixed(2)}Â°`;
            
            let bName = markerB ? markerB.getTitle() : 'ã‚¿ãƒƒãƒ—ä½ç½®';

            document.getElementById('result').innerHTML = `
                <h3>âœ… ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼ˆèª¤å·®ã‚’è¨˜éŒ²ï¼‰</h3>
                <p><strong>Aç‚¹ã‹ã‚‰è¦‹ãŸBç‚¹ã®æ–¹ä½ (çœŸã®æ–¹ä½):</strong> 
                <span style="color: #337ab7; font-weight: bold;">${trueBearing.toFixed(2)}Â°</span></p>
                <p><strong>è¨˜éŒ²ã•ã‚ŒãŸæ–¹ä½ (æ±ºå®šå€¤):</strong> 
                <span style="color:#d9534f">${capturedValue.toFixed(2)}Â°</span></p>
                <p style="font-size: 2.0em; color: #FF6347; font-weight: bold;">
                    ğŸ§­ è¨˜éŒ²ã•ã‚ŒãŸã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®: ${error.toFixed(2)}Â°
                </p>
            `;
            handleOrientation({ alpha: (360 - capturedValue) % 360 }); 
        }

        function calculateBearing(startLat, startLng, endLat, endLng) {
            const R_startLat = startLat * (Math.PI / 180);
            const R_endLat = endLat * (Math.PI / 180);
            const deltaLng = (endLng - startLng) * (Math.PI / 180);

            const y = Math.sin(deltaLng) * Math.cos(R_endLat);
            const x = Math.cos(R_startLat) * Math.sin(R_endLat) - 
                      Math.sin(R_startLat) * Math.cos(R_endLat) * Math.cos(deltaLng);

            let bearingRad = Math.atan2(y, x);
            let bearingDeg = bearingRad * (180 / Math.PI);

            return (bearingDeg + 360) % 360;
        }
        
        // --- ãƒãƒƒãƒ—æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
        
        function initMap() {
             map = new google.maps.Map(document.getElementById('map'), {
                 zoom: 12, center: B_POINTS.kinjo,
             });


             document.getElementById('setLocationButton').addEventListener('click', findCurrentLocation);
             document.getElementById('startCompassButton').addEventListener('click', toggleCompass);
             document.getElementById('captureHeadingButton').addEventListener('click', captureHeading); 
             document.getElementById('captureWindHButton').addEventListener('click', captureWindHeading); 
             document.getElementById('copyWindHButton').addEventListener('click', copyWindH); 
             document.getElementById('sendWindHButton').addEventListener('click', sendWindH); 
             
             document.getElementsByName('b_option').forEach(radio => {
                 radio.addEventListener('change', handleBSelectionChange);
             });
             map.addListener('click', handleMapClick);

             setDestinationB(B_POINTS.kinjo);
        }
        
        function handleBSelectionChange(event) {
            const selectedValue = event.target.value;
            document.getElementById('bTapInstruction').style.display = 'none';
            mapTapMode = false;
            
            if (selectedValue === 'tap') {
                document.getElementById('bTapInstruction').style.display = 'block';
                currentDestinationB = null;
                mapTapMode = true;
            } else {
                setDestinationB(B_POINTS[selectedValue]);
            }
            if (currentOriginA) { displayCalculatedBearing(); }
        }
        
        function handleMapClick(event) {
            if (mapTapMode) {
                setDestinationB({ lat: event.latLng.lat(), lng: event.latLng.lng(), name: "ãƒãƒƒãƒ—ã‚¿ãƒƒãƒ—ä½ç½® (Bç‚¹)" });
                mapTapMode = false;
                document.querySelector('input[name="b_option"][value="tap"]').checked = true;
                if (currentOriginA) { displayCalculatedBearing(); }
            }
        }
        
        function setDestinationB(coords) {
            currentDestinationB = new google.maps.LatLng(coords.lat, coords.lng);
            if (markerB) { markerB.setPosition(currentDestinationB); markerB.setTitle(coords.name); } 
            else { markerB = new google.maps.Marker({ position: currentDestinationB, map: map, title: coords.name, label: 'B', }); }
            if (currentOriginA) { updateMapDisplay(); } else { map.setCenter(currentDestinationB); }
        }
        
        function findCurrentLocation() {
            document.getElementById('result').innerHTML = '<p class="loading">ç¾åœ¨åœ°ã‚’æ¤œå‡ºä¸­ã§ã™...</p>';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentOriginA = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        if (markerA) { markerA.setPosition(currentOriginA); } 
                        else {
                            markerA = new google.maps.Marker({
                                position: currentOriginA, map: map, title: "ç¾åœ¨ä½ç½® (Aç‚¹)", label: 'A',
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#007bff', fillOpacity: 1, strokeWeight: 0, }
                            });
                        }
                        updateMapDisplay();
                        document.getElementById('setLocationButton').textContent = 'ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã« (æ›´æ–°)';
                        document.getElementById('result').innerHTML = `<h3>âœ… Aç‚¹è¨­å®šå®Œäº†</h3><p>ç¾åœ¨ä½ç½®ãŒAç‚¹ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã—ãŸã€‚</p>`;
                        displayCalculatedBearing(); 

                    },
                    (error) => { document.getElementById('result').innerHTML = `<h3>âŒ Aç‚¹è¨­å®šå¤±æ•—</h3><p style="color: red;">ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ã€‚</p>`; }
                );
            } else { document.getElementById('result').innerHTML = `<h3>âŒ Aç‚¹è¨­å®šå¤±æ•—</h3><p style="color: red;">ãƒ–ãƒ©ã‚¦ã‚¶ãŒä½ç½®æƒ…å ±APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚</p>`; }
        }
        
     






   function updateMapDisplay() {
            if (!currentOriginA || !currentDestinationB) { return; }
            if (polyline) { polyline.setMap(null); }
            polyline = new google.maps.Polyline({
                path: [currentOriginA, currentDestinationB], geodesic: true, strokeColor: '#FF0000',
                strokeOpacity: 1.0, strokeWeight: 2, map: map,
            });


          // --- ã“ã“ã‹ã‚‰ä¸‹ã‚’æ›¸ãæ›ãˆ ---
    map.setCenter(currentOriginA); // Aç‚¹ï¼ˆç¾åœ¨åœ°ï¼‰ã‚’ç”»é¢ã®çœŸã‚“ä¸­ã«
    map.setZoom(16);               // 16ã€œ17ã«è¨­å®šã™ã‚‹ã¨ã€ã ã„ãŸã„åŠå¾„æ•°ç™¾ãƒ¡ãƒ¼ãƒˆãƒ«ãŒåã¾ã‚Šã¾ã™
    // map.fitBounds(bounds);      <-- ã“ã®è¡Œã‚’æ¶ˆã™ï¼ˆã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        }

        


function displayCalculatedBearing() {
            if (!currentOriginA || !currentDestinationB) {
                document.getElementById('result').innerHTML = `<h3>å¾…æ©Ÿä¸­...</h3><p>Aç‚¹ã¨Bç‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>`;
                return;
            }
            
            const trueBearing = calculateBearing(currentOriginA.lat(), currentOriginA.lng(), currentDestinationB.lat(), currentDestinationB.lng());
            let bName = markerB ? markerB.getTitle() : 'ã‚¿ãƒƒãƒ—ä½ç½®';
            const calibrationMessage = recordedError !== null ? 
                `<span style="color: green; font-weight: bold;">èª¤å·® ${recordedError.toFixed(2)}Â° è¨˜éŒ²æ¸ˆã¿ã€‚</span>` : 
                `**æ–¹ä½ã‚’æ±ºå®š**ã—ã¦èª¤å·®ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚`;

            document.getElementById('result').innerHTML = `
                <h3>âœ… æ–¹ä½è¨ˆç®—çµæœ</h3>
                <p><strong>Aç‚¹ã‹ã‚‰è¦‹ãŸBç‚¹ã®æ–¹ä½ (çœŸã®æ–¹ä½):</strong> 
                <span style="font-size: 2.5em; color: #337ab7; font-weight: bold;">${trueBearing.toFixed(2)}Â°</span></p>
                <p>${calibrationMessage}</p>
            `;
        }

    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap">
    </script>
</body>
</html>

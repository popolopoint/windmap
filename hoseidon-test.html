<!DOCTYPE html>
<html>
<head>
    <title>hoseidon-v3.1.8-çœŸã®é¢¨å‘è£œæ­£ã©ã‚“H</title>
    <style>
        /* =======================================================
           v3.1.8: ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®ä¸‰é …ç›®è¡¨ç¤ºã¨ä½ç½®æƒ…å ±ç²¾åº¦å‘ä¸Š
           ======================================================= */
        body { 
            font-size: 250%; 
            margin: 10px;
        }
        h1 { margin-bottom: 20px; }
        #map { height: 60vh; width: 100%; margin-top: 20px; }
        
        .version-info {
            font-size: 0.8em;
            font-weight: normal;
            color: #666;
            margin-left: 10px;
        }
        
        /* é¸æŠè‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #bPointSelection { font-size: 1.2em; margin-bottom: 30px; }
        #bPointSelection label {
            display: flex; align-items: center; font-size: 1.0em; margin-bottom: 25px; cursor: pointer;
        }
        #bPointSelection input[type="radio"] {
            transform: scale(3.0); margin-right: 35px; margin-left: 20px;
        }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        button { 
            padding: 20px 30px; 
            font-size: 1.6em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            margin-bottom: 15px; 
            display: block; 
            width: 95%;     
            margin-left: auto; margin-right: auto;
            text-align: center;
            font-weight: bold;
        }

        #setLocationButton { background-color: #d9534f; color: white; } 
        #startCompassButton { background-color: #ffc107; color: black; } 
        #captureHeadingButton { background-color: #28a745; color: white; } 
        #captureWindHButton { background-color: #5e2b97; color: white; } 
        #copyWindHButton { background-color: #e83e8c; color: white; } 
        #sendWindHButton { background-color: #6610f2; color: white; } 

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆ3é …ç›®ã‚’å¼·èª¿ï¼‰ */
        #result { 
            margin-top: 20px; padding: 25px; border: 3px solid #007bff; 
            background-color: #f0f8ff; border-radius: 10px; 
            font-size: 1.0em; margin-bottom: 20px; line-height: 1.4;
        }
        .res-row { margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .res-label { font-size: 0.7em; color: #555; display: block; }
        .res-value { font-size: 1.3em; font-weight: bold; color: #000; }
        .res-error-row { background-color: #ffeaea; padding: 10px; border-radius: 5px; }
        .res-error-label { font-size: 0.8em; color: #d9534f; font-weight: bold; }
        .res-error-value { font-size: 1.8em; color: #ff0000; font-weight: bold; }

        /* ã‚»ãƒ³ã‚µãƒ¼çª“ */
        #sensorContainer { display: flex; gap: 15px; margin: 20px 0; }
        #compassWindow, #windHWindow {
            flex: 1; padding: 15px; border-radius: 5px; text-align: center; font-size: 0.9em;
        }
        #compassWindow { border: 2px solid #5cb85c; background-color: #f0fff0; }
        #windHWindow { border: 2px solid #000; background-color: #f7f7f7; }
        
        #headingRealtime { font-size: 1.4em; color: #4CAF50; font-weight: bold; }
        #headingCorrected { font-size: 1.4em; color: #007bff; font-weight: bold; }
        #windHResultDisplay { font-size: 1.8em; color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>
    <h1>
        çœŸã®é¢¨å‘è£œæ­£ã©ã‚“H
        <span class="version-info">(v3.1.8) by Popolo App.com</span>
    </h1>

    <button id="setLocationButton">ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«è¨­å®š</button>
    
    <div id="bPointSelection">
        <strong>Bç‚¹ (ç›®çš„åœ°) ã®é¸æŠ:</strong>
        <label><input type="radio" name="b_option" value="kinjo" checked> é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="gushikawa"> å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€</label>
        <label><input type="radio" name="b_option" value="tap"> åœ°å›³ä¸Šã§ã‚¿ãƒƒãƒ—</label>
    </div>

    <div id="result">
        <p>Aç‚¹ã¨Bç‚¹ã‚’è¨­å®šå¾Œã€ã‚¹ãƒãƒ›ã‚’Bç‚¹ã«å‘ã‘ã€ŒBç‚¹ã«å‘ã‘ã‚¿ãƒƒãƒ—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <button id="startCompassButton">æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼é–‹å§‹</button>
    <button id="captureHeadingButton" disabled>Bç‚¹ã«å‘ã‘ã‚¿ãƒƒãƒ—</button>
    <button id="captureWindHButton" disabled>é¢¨å‘Hã«å‘ã‘ã‚¿ãƒƒãƒ—</button>
    
    <div id="sensorContainer">
        <div id="compassWindow">
            <strong>æ–¹ä½ (æœª/è£œæ­£)</strong>
            <div id="headingRealtime">--</div>
            <div id="headingCorrected">--</div>
        </div>
        <div id="windHWindow">
            <strong>ğŸ¯ çœŸã®é¢¨å‘H</strong>
            <div id="windHResultDisplay">---</div>
        </div>
    </div>

    <button id="copyWindHButton" disabled>çœŸã®é¢¨å‘Hã‚’ã‚³ãƒ”ãƒ¼</button>
    <button id="sendWindHButton" disabled>çœŸã®é¢¨å‘Hã‚’é€ã‚‹</button>

    <div id="map"></div>

    <script>
        const B_POINTS = { 
            kinjo: { lat: 26.4454055, lng: 127.9209787, name: "é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€" },
            gushikawa: { lat: 26.3803176, lng: 127.8751869, name: "å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€" }
        };
        
        let map, currentOriginA, currentDestinationB, markerA, markerB, polyline;
        let lastReadHeading = null, isCompassRunning = false, recordedError = null, correctedWindHeadingResult = null;

        // é«˜ç²¾åº¦ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´æ£„ã‚’é©ç”¨ã—ãŸä½ç½®å–å¾—
        function findCurrentLocation() {
            document.getElementById('result').innerHTML = '<p>ä½ç½®æƒ…å ±ã‚’æ›´æ–°ä¸­...</p>';
            if (navigator.geolocation) {
                const options = { 
                    enableHighAccuracy: true, // GPSå„ªå…ˆ
                    timeout: 10000,           // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    maximumAge: 0             // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„
                };
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        currentOriginA = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                        if (markerA) markerA.setPosition(currentOriginA);
                        else {
                            markerA = new google.maps.Marker({ 
                                position: currentOriginA, map: map, label: 'A', 
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#007bff', fillOpacity: 1, strokeWeight: 2, strokeColor: 'white' } 
                            });
                        }
                        updateMapDisplay();
                        document.getElementById('setLocationButton').textContent = 'ç¾åœ¨ä½ç½®ã‚’æ›´æ–°ã—ã¾ã—ãŸ';
                        setTimeout(()=> { document.getElementById('setLocationButton').textContent = 'ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«è¨­å®š'; }, 2000);
                        updateResultInitial();
                    },
                    (err) => { alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GPSã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚"); },
                    options
                );
            }
        }

        function calculateBearing(lat1, lng1, lat2, lng2) {
            const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180, Î”Î» = (lng2-lng1) * Math.PI/180;
            const y = Math.sin(Î”Î») * Math.cos(Ï†2);
            const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è¡¨ç¤ºï¼ˆ3é …ç›®ï¼‰
        function captureHeading() {
            if (lastReadHeading === null || !currentOriginA || !currentDestinationB) return;
            const trueBearing = calculateBearing(currentOriginA.lat(), currentOriginA.lng(), currentDestinationB.lat(), currentDestinationB.lng());
            let error = lastReadHeading - trueBearing;
            if (error > 180) error -= 360; else if (error < -180) error += 360;
            recordedError = error;

            document.getElementById('result').innerHTML = `
                <div class="res-row">
                    <span class="res-label">Aç‚¹ã‹ã‚‰Bç‚¹ã®åœ°å›³ä¸Šã®æ–¹ä½:</span>
                    <span class="res-value">${trueBearing.toFixed(1)}Â°</span>
                </div>
                <div class="res-row">
                    <span class="res-label">è¨ˆæ¸¬ã•ã‚ŒãŸæ–¹ä½ (ã‚¹ãƒãƒ›ã®å‘ã):</span>
                    <span class="res-value">${lastReadHeading.toFixed(1)}Â°</span>
                </div>
                <div class="res-error-row">
                    <span class="res-error-label">å°ãå‡ºã—ãŸã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®:</span><br>
                    <span class="res-error-value">${recordedError.toFixed(2)}Â°</span>
                </div>
            `;
        }

        function handleOrientation(e) {
            if (e.alpha === null) return;
            lastReadHeading = (360 - e.alpha + 360) % 360;
            document.getElementById('headingRealtime').textContent = lastReadHeading.toFixed(1) + "Â°";
            if (recordedError !== null) {
                let corrected = (lastReadHeading - recordedError + 360) % 360;
                document.getElementById('headingCorrected').textContent = corrected.toFixed(1) + "Â°";
            }
        }

        function captureWindHeading() {
            if (lastReadHeading === null || recordedError === null) return;
            correctedWindHeadingResult = (lastReadHeading - recordedError + 360) % 360;
            document.getElementById('windHResultDisplay').textContent = correctedWindHeadingResult.toFixed(1) + "Â°";
            document.getElementById('copyWindHButton').disabled = false;
            document.getElementById('sendWindHButton').disabled = false;
        }

        function toggleCompass() {
            const btn = document.getElementById('startCompassButton');
            if (isCompassRunning) {
                window.removeEventListener('deviceorientation', handleOrientation);
                isCompassRunning = false;
                btn.textContent = 'æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼é–‹å§‹';
                document.getElementById('captureHeadingButton').disabled = true;
                document.getElementById('captureWindHButton').disabled = true;
            } else {
                const start = () => {
                    window.addEventListener('deviceorientation', handleOrientation);
                    isCompassRunning = true;
                    btn.textContent = 'æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼åœæ­¢';
                    document.getElementById('captureHeadingButton').disabled = false;
                    document.getElementById('captureWindHButton').disabled = false;
                };
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(state => { if(state==='granted') start(); });
                } else { start(); }
            }
        }

        function updateMapDisplay() {
            if (!currentOriginA || !currentDestinationB) return;
            if (polyline) polyline.setMap(null);
            polyline = new google.maps.Polyline({ path: [currentOriginA, currentDestinationB], strokeColor: '#FF0000', map: map });
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(currentOriginA); bounds.extend(currentDestinationB);
            map.fitBounds(bounds);
        }

        function updateResultInitial() {
            if (currentOriginA && currentDestinationB) {
                const trueB = calculateBearing(currentOriginA.lat(), currentOriginA.lng(), currentDestinationB.lat(), currentDestinationB.lng());
                document.getElementById('result').innerHTML = `
                    <div class="res-row">
                        <span class="res-label">åœ°å›³ä¸Šã®Bç‚¹æ–¹ä½:</span>
                        <span class="res-value">${trueB.toFixed(1)}Â°</span>
                    </div>
                    <p style="font-size:0.7em;">ã‚¹ãƒãƒ›ã‚’Bç‚¹ã«å‘ã‘ã€ŒBç‚¹ã«å‘ã‘ã‚¿ãƒƒãƒ—ã€ã‚’æŠ¼ã™ã¨èª¤å·®ã‚’ç®—å‡ºã—ã¾ã™ã€‚</p>
                `;
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), { zoom: 14, center: B_POINTS.kinjo });
            document.getElementById('setLocationButton').addEventListener('click', findCurrentLocation);
            document.getElementById('startCompassButton').addEventListener('click', toggleCompass);
            document.getElementById('captureHeadingButton').addEventListener('click', captureHeading);
            document.getElementById('captureWindHButton').addEventListener('click', captureWindHeading);
            document.getElementById('copyWindHButton').addEventListener('click', () => {
                navigator.clipboard.writeText(correctedWindHeadingResult.toFixed(1));
                const btn = document.getElementById('copyWindHButton');
                btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
                setTimeout(()=> { btn.textContent = 'çœŸã®é¢¨å‘Hã‚’ã‚³ãƒ”ãƒ¼'; }, 1500);
            });
            document.getElementById('sendWindHButton').addEventListener('click', () => {
                const url = `windmap_latest.html?heading=${correctedWindHeadingResult.toFixed(1)}&lat=${currentOriginA.lat().toFixed(6)}&lng=${currentOriginA.lng().toFixed(6)}`;
                window.open(url, '_blank');
            });
            document.getElementsByName('b_option').forEach(r => r.addEventListener('change', (e) => {
                if(e.target.value !== 'tap') {
                    currentDestinationB = new google.maps.LatLng(B_POINTS[e.target.value].lat, B_POINTS[e.target.value].lng);
                    if (markerB) markerB.setPosition(currentDestinationB);
                    else markerB = new google.maps.Marker({ position: currentDestinationB, map: map, label: 'B' });
                    updateMapDisplay(); updateResultInitial();
                }
            }));
            map.addListener('click', (e) => {
                if(document.querySelector('input[value="tap"]').checked) {
                    currentDestinationB = e.latLng;
                    if (markerB) markerB.setPosition(currentDestinationB);
                    else markerB = new google.maps.Marker({ position: currentDestinationB, map: map, label: 'B' });
                    updateMapDisplay(); updateResultInitial();
                }
            });
            // åˆæœŸè¨­å®š
            currentDestinationB = new google.maps.LatLng(B_POINTS.kinjo.lat, B_POINTS.kinjo.lng);
            markerB = new google.maps.Marker({ position: currentDestinationB, map: map, label: 'B' });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap"></script>
</body>
</html>
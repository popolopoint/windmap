<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>風向セットテスト v3.1.8</title>
<style>
  body { font-family: sans-serif; padding: 20px; text-align: center; }
  button {
    padding: 10px 20px; font-size: 18px; margin: 10px; border-radius: 10px; border: none;
  }
  #setWindButton { background: #6f42c1; color: white; } /* 紫 */
  /* モーダル */
  #modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
  }
  #modalContent {
    background: white; padding: 20px; border-radius: 12px; text-align: center;
    width: 80%; max-width: 300px;
  }
  #confirmButton {
    background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px;
  }
</style>
</head>
<body>
<h2>風向セットテスト v3.1.8</h2>
<button id="setWindButton">風向セット</button>

<!-- モーダル -->
<div id="modal">
  <div id="modalContent">
    <p>スマホを風向に向けて少し待って「設定」を押してください。</p>
    <button id="confirmButton">設定</button>
  </div>
</div>

<script>
let currentHeading = null;

// 方位イベント監視
function startOrientationTracking() {
  window.addEventListener('deviceorientation', (event) => {
    if (event.webkitCompassHeading !== undefined) {
      currentHeading = event.webkitCompassHeading; // iPhone/Safari
    } else if (event.alpha !== null) {
      currentHeading = 360 - event.alpha; // Android
    }
  });
}

// メイン処理
document.getElementById('setWindButton').addEventListener('click', async () => {
  try {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      const permission = await DeviceOrientationEvent.requestPermission();
      if (permission !== 'granted') {
        alert('方位センサーの使用が許可されませんでした。設定を確認してください。');
        return;
      }
    }

    startOrientationTracking();
    document.getElementById('modal').style.display = 'flex';

  } catch (error) {
    alert('エラー: ' + error);
  }
});

// 「設定」ボタンを押したとき
document.getElementById('confirmButton').addEventListener('click', () => {
  document.getElementById('modal').style.display = 'none';
  if (currentHeading !== null) {
    alert('現在の風向（風上方向）: ' + Math.round(currentHeading) + '°');
  } else {
    alert('風向を取得できませんでした。');
  }
});
</script>
</body>
</html>

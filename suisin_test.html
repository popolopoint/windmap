<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°´æ·±æ¸¬ã£å¤ªéƒ v1.7.3 by Popolo App.com</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f4f8; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .app-header { background: #3498db; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; }
        .ui-panel { background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; flex-shrink: 0; }
        .datetime-panel { background: #ebf5fb; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #aed6f1; }
        .datetime-row { display: flex; gap: 6px; align-items: center; }
        #target-datetime { flex: 1; padding: 10px; border: 1px solid #3498db; border-radius: 6px; font-size: 0.9rem; }
        
        .type-selector { display: flex; gap: 5px; margin-bottom: 8px; }
        .type-btn { flex: 1; padding: 10px; border: 2px solid #3498db; background: white; color: #3498db; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .type-btn.active { background: #3498db; color: white; }

        .input-row { display: flex; gap: 6px; align-items: center; margin-bottom: 5px; }
        /* æ•°å€¤ã ã‘ã§ãªãæ–‡å­—å…¥åŠ›ã‚‚å—ã‘ä»˜ã‘ã‚‹ã‚ˆã†ã«textå‹ã¸å¤‰æ›´ */
        input#depth-input { flex: 1; padding: 12px; border: 2px solid #3498db; border-radius: 6px; font-size: 1.1rem; min-width: 0; }
        
        /* ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn-voice { background: #e74c3c; color: white; border: none; border-radius: 6px; padding: 0 12px; height: 45px; font-size: 1.2rem; cursor: pointer; }
        .btn-voice.listening { animation: pulse 1.5s infinite; background: #c0392b; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .btn-record { background: #2ecc71; color: white; flex: 1.5; padding: 12px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; }
        
        #comment-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 5px; box-sizing: border-box; }
        .status-bar { font-size: 0.75rem; color: #666; text-align: center; margin-top: 5px; font-weight: bold; }
        #map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        
        .gps-button { position: absolute; bottom: 20px; right: 10px; width: 50px; height: 50px; background: white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 10; cursor: pointer; font-size: 24px; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 4000; font-weight: bold; color: #3498db; }
    </style>
</head>
<body>

<div id="loading">ğŸ“¡ é€šä¿¡ä¸­...</div>
<div class="app-header">æ°´æ·±æ¸¬ã£å¤ªéƒ v1.7.3 by Popolo App.com</div>

<div class="ui-panel">
    <div class="datetime-panel">
        <div class="datetime-row">
            <input type="datetime-local" id="target-datetime">
            <button onclick="setNow()" style="padding: 10px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 0.8rem;">ç¾åœ¨</button>
        </div>
        <div id="status-display" class="status-bar">â³ èµ·å‹•ä¸­...</div>
    </div>

    <div class="type-selector">
        <button class="type-btn active" onclick="selectType('å¹³åœ°', this)">å¹³åœ°</button>
        <button class="type-btn" onclick="selectType('å²©', this)">å²©</button>
        <button class="type-btn" onclick="selectType('æ­', this)">æ­</button>
    </div>

    <div class="input-row">
        <button id="voice-start-btn" class="btn-voice" onclick="startVoiceInput()">ğŸ¤</button>
        <input type="text" id="depth-input" placeholder="æ°´æ·±ã‚’å…¥åŠ›/éŸ³å£°" inputmode="text">
        <button class="btn-record" onclick="recordAtCurrentLocation()">è¨˜éŒ²</button>
        <button onclick="openModal('admin-modal')" style="width:40px; height:45px; border-radius:6px; border:none; background:#95a5a6; color:white;">ğŸ”‘</button>
    </div>
    <input type="text" id="comment-input" placeholder="ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰">
</div>

<div id="map-container">
    <div id="map"></div>
    <div class="gps-button" onclick="updateMyLocation(true)">ğŸ“</div>
</div>

<div id="admin-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:5000; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:12px; width:80%;">
        <h3>ç®¡ç†è€…è¨­å®š</h3>
        <input type="password" id="pass-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%; padding:10px; box-sizing:border-box;">
        <button class="btn-record" onclick="saveAdminPass()" style="width:100%; margin-top:10px;">ä¿å­˜</button>
        <button onclick="closeModal('admin-modal')" style="width:100%; margin-top:10px; background:none; border:none;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw1wg_a28-_dOyLbik9VnYfbzKEHPNBWwaVVeyc4gcibovUIQ5BUGNw1esYy0beyZVf3g/exec"; 
    let map, markers = [], allPointsData = [], currentSelectedTide = 0, adminPass = localStorage.getItem('popolo_pass') || "";
    let fullTideMasterData = [];
    let myLocationMarker = null;
    let selectedType = "å¹³åœ°";

    // éŸ³å£°èªè­˜ã®è¨­å®š
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = false;

        recognition.onstart = () => {
            document.getElementById('voice-start-btn').classList.add('listening');
        };

        recognition.onend = () => {
            document.getElementById('voice-start-btn').classList.remove('listening');
        };

        recognition.onresult = (event) => {
            let resultText = event.results[0][0].transcript;
            // ã€Œ120ã‚»ãƒ³ãƒã€ã€Œç™¾äºŒåã€ãªã©ã‚’æ•°å­—ã€Œ120ã€ã«å¤‰æ›ã™ã‚‹ç°¡æ˜“ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            let cleanNum = resultText.replace(/[ï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)) // å…¨è§’ã‚’åŠè§’
                                    .replace(/[^0-9.]/g, ''); // æ•°å­—ã¨ç‚¹ä»¥å¤–å‰Šé™¤
            
            if (cleanNum) {
                document.getElementById('depth-input').value = cleanNum;
            } else {
                alert("æ•°å­—ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + resultText);
            }
        };
    }

    function startVoiceInput() {
        if (!recognition) {
            alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }
        recognition.start();
    }

    // æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
    function extractNumber(str) {
        // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
        let val = str.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248));
        // æ•°å­—ã¨å°æ•°ç‚¹ä»¥å¤–ã‚’å‰Šé™¤
        let num = val.replace(/[^0-9.]/g, '');
        return parseFloat(num);
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function selectType(type, btn) {
        selectedType = type;
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function saveAdminPass() {
        adminPass = document.getElementById('pass-input').value.trim();
        localStorage.setItem('pop
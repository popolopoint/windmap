<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>コース作るくん v6.7.1bc by Popolo App.com</title>
<style>
:root{ --red:#ff3b30; --blue:#0000ff; --yellow:#ffff00; --green:#28a745; --purple:#6a1b9a; --orange:#f57c00; --gray:#555; --navy:#000080; --pink:#ff2d55; --teal:#5ac8fa; }
body { font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN","メイリオ",Meiryo,sans-serif; margin:10px; color:#222; overflow-x: hidden; }
h2 { margin:0 0 8px 0; font-size:18px; }
#version { position:absolute; right:12px; top:12px; color:#666; font-size:13px; }

.input-row { display: flex; dap: 5px; width: 100%; margin-bottom: 10px; }
.input-group { flex: 1; display: flex; flex-direction: column; }
.input-group label { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
.input-group input { font-size: 24px; padding: 8px 4px; width: 100%; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; text-align: center; }

#courseSelect { font-size: 24px; padding: 8px; width: 100%; border-radius:6px; margin-bottom:10px; }

.compact-input { font-size: 18px !important; padding: 6px 2px !important; width: 55px !important; text-align:center; border-radius:6px; border:1px solid #ccc; }
#sausageSettings, #jwsaSettings, #jwsa2Settings, #jwsa3Settings { display:none; flex-wrap:nowrap; align-items:center; gap:4px; background:#f0f0f0; padding:5px; border-radius:8px; margin-bottom:10px; width: 100%; box-sizing: border-box; overflow-x: auto; }

.main-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; margin: 10px 0; }
.main-buttons button { font-size: 18px; padding: 15px 5px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.16); }
#btnShareAll { background: var(--gray); }
#btnStarboard { background: var(--green); }
#btnPort { background: var(--orange); }

#inputsMode { margin:15px 0; padding:12px; background:#f0f7ff; border-radius:8px; font-size: 16px; color:#333; border:1px solid #d0e0f0; }
#inputsMode select { font-size: 22px; padding: 5px; margin: 0 5px; }
.radio-group { margin: 10px 0; display: flex; gap: 15px; align-items: center; }
#btnSetCurrent { background: var(--red); color:white; border:none; padding:10px 15px; border-radius:6px; font-weight:bold; margin-top:10px; width:100%; font-size:18px; }

#map { width:100%; height:675px; border-radius:8px; margin-top:10px; box-shadow:0 1px 4px rgba(0,0,0,0.2); }

#coordsContainer { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; justify-content: space-between; }
.pointBox { border-radius:50%; width:40px; height:40px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; font-size: 0.9em; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

.sub-button-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }
.btn-sub { background:#f8f8f8; border:1px solid #ccc; padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer; font-weight: bold; color: #444; }

#modalOverlay, #distModalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; }
.modalContent { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 4px 20px rgba(0,0,0,0.3); }
.modalContent h3 { margin-top:0; font-size:18px; border-bottom: 2px solid #eee; padding-bottom: 8px; }
.modal-input-group { margin-bottom:15px; }
.modal-input-group label { display:block; font-size:12px; font-weight:bold; margin-bottom:4px; }
.modal-input-group input { width:100%; font-size:20px; padding:8px; box-sizing:border-box; border-radius:6px; border:1px solid #ccc; }
.modal-close-btn { background:var(--blue); color:white; border:none; padding:12px; border-radius:8px; width:100%; font-size:18px; font-weight:bold; margin-top: 10px; }

.dist-list { list-style: none; padding: 0; margin: 0; }
.dist-item { background: #f9f9f9; padding: 10px; border-bottom: 1px solid #eee; font-size: 15px; font-weight: bold; }
</style>
</head>
<body>

<h2>コース作るくん <span style="font-size:0.7em;">v6.7.1c by Popolo App.com</span></h2>
<div id="version">v6.7.1c</div>

<div class="input-row">
  <div class="input-group"><label>風向</label><input type="number" id="wind" step="any" placeholder="0"></div>
  <div class="input-group"><label>距離(m)</label><input type="number" id="dist" value="500"></div>
  <div class="input-group"><label>角度(°)</label><input type="number" id="theta" value="5"></div>
</div>

<select id="courseSelect">
  <option value="mcourse">Ｍコース</option>
  <option value="figure8">フィギア８</option>
  <option value="sausage">ソーセージ</option>
  <option value="5jibe">５ジャイブ</option>
  <option value="jwsa">JWSA1</option>
  <option value="jwsa2">JWSA2</option>
  <option value="jwsa3">JWSA3</option>
<option value="jwsa5">JWSA5</option>
</select>

<div id="sausageSettings">
  <label>上<br><input type="number" id="upDist" class="compact-input" value="1000"></label>
  <label>下<br><input type="number" id="downDist" class="compact-input" value="100"></label>
  <label>AS距離<br><input type="number" id="distAS" class="compact-input" value="100"></label>
  <label>S角度<br><input type="number" id="sAngle" class="compact-input" value="0"></label>
</div>







<div id="jwsaSettings">
  <label>AB<br><input type="number" id="distAB" class="compact-input" value="500"></label>
  <label>BG<br><input type="number" id="distBC" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distCD" class="compact-input" value="500"></label>
  <label>角G<br><input type="number" id="theta2" class="compact-input" value="60"></label>
</div>



<div id="jwsa2Settings">
  <label>AB<br><input type="number" id="distAB2" class="compact-input" value="500"></label>
  <label>BF<br><input type="number" id="distBC2" class="compact-input" value="400"></label>
  <label>FG<br><input type="number" id="distCD2" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distDE2" class="compact-input" value="500"></label> 
  <label>角B<br><input type="number" id="theta3_2" class="compact-input" value="45"></label> 
  <label>角G<br><input type="number" id="theta2_2" class="compact-input" value="60"></label>
</div>





<div id="jwsa3Settings">
  <label>AB<br><input type="number" id="distAB3" class="compact-input" value="500"></label>
  <label>BF<br><input type="number" id="distBC3" class="compact-input" value="400"></label>
  <label>FG<br><input type="number" id="distCD3" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distDE3" class="compact-input" value="500"></label>
  <label>角B<br><input type="number" id="theta3_3" class="compact-input" value="30"></label>
  <label>角G<br><input type="number" id="theta2_3" class="compact-input" value="60"></label>
</div>

<div class="main-buttons">
  <button id="btnShareAll">データ送信</button>
  <button id="btnStarboard">スタボー</button>
  <button id="btnPort">ポート</button>
</div>

<div id="inputsMode">
  <strong>基準点：</strong>
  <select id="basePointSelect">
    <option value="A" selected>A点</option><option value="B">B点</option><option value="C">C点</option>
    <option value="D">D点</option><option value="E">E点</option><option value="F">F点</option><option value="G">G点</option><option value="S">S点</option><option value="K">K点</option>
  </select>
  <div class="radio-group">
    <label><input type="radio" name="aMode" value="gps" checked> 現在地をセット</label>
    <label><input type="radio" name="aMode" value="map"> マップ指定</label>
  </div>
  <button id="btnSetCurrent">反映</button>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:var(--red);">A</div>
  <div class="pointBox" id="btnB" style="background:var(--blue);">B</div>
  <div class="pointBox" id="btnC" style="background:var(--yellow); color:#000; text-shadow:none;">C</div>
  <div class="pointBox" id="btnD" style="background:var(--green);">D</div>
  <div class="pointBox" id="btnE" style="background:var(--purple);">E</div>
  <div class="pointBox" id="btnF" style="background:var(--pink); display:none;">F</div>
  <div class="pointBox" id="btnG" style="background:var(--navy); display:none;">G</div>
  <div class="pointBox" id="btnK" style="background:var(--teal); display:none;">K</div>
  <div class="pointBox" id="btnS" style="background:var(--blue); display:none;">S</div>
</div>

<div class="sub-button-row">
  <button id="btnOpenDistModal" class="btn-sub">マーク距離</button>
  <button id="btnOpenCoordModal" class="btn-sub">基準点緯度経度 修正/確認</button>
</div>

<div id="map"></div>

<div id="modalOverlay">
  <div class="modalContent">
    <h3>基準点の緯度経度</h3>
    <div class="modal-input-group"><label>緯度 (Lat)</label><input type="number" id="modalLat" step="any"></div>
    <div class="modal-input-group"><label>経度 (Lng)</label><input type="number" id="modalLng" step="any"></div>
    <button id="btnModalClose" class="modal-close-btn">決定・反映</button>
  </div>
</div>

<div id="distModalOverlay">
  <div class="modalContent">
    <h3>マーク間距離 (m)</h3>
    <div id="distResultArea" class="dist-list"></div>
    <button id="btnDistModalClose" class="modal-close-btn">閉じる</button>
  </div>
</div>

<input type="hidden" id="latA"><input type="hidden" id="lngA">






<script>
let map, circles={}, markersLabel={}, polylines=[];
let points = {A:null,B:null,C:null,D:null,E:null,F:null,G:null,S:null,K:null};
const COLORS = { A:'#ff3b30', B:'#0000ff', C:'#ffff00', D:'#28a745', E:'#6a1b9a', F:'#ff2d55', G:'#000080', S:'#0000ff', K:'#5ac8fa' };
let currentIsPort = true;
let path = [];

function checkUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  const lat = urlParams.get('lat');
  const lng = urlParams.get('lng');
  const twd = urlParams.get('twd');
  const dist = urlParams.get('dist');
  const theta = urlParams.get('theta');
  const course = urlParams.get('course');

  if (lat && lng) updateAPos(parseFloat(lat), parseFloat(lng));
  if (twd) document.getElementById('wind').value = twd;
  if (dist) document.getElementById('dist').value = dist;
  if (theta) document.getElementById('theta').value = theta;
  if (course) {
    const sel = document.getElementById('courseSelect');
    sel.value = course;
    sel.dispatchEvent(new Event('change'));
  }
}

function initMap(){
  let centerPos = { lat: 26.3318, lng: 127.9179 };
  const latA = parseFloat(document.getElementById('latA').value);
  const lngA = parseFloat(document.getElementById('lngA').value);
  if(!isNaN(latA) && !isNaN(lngA)) centerPos = { lat: latA, lng: lngA };
  
  map = new google.maps.Map(document.getElementById('map'), { 
    center: centerPos, 
    zoom: 14, 
    gestureHandling: 'greedy', 
    disableDefaultUI: true, 
    zoomControl: true 
  });

  map.addListener('click', (e)=>{ 
    if(document.querySelector('input[name="aMode"]:checked').value==='map'){ 
      setBasePosition({lat:e.latLng.lat(), lng:e.latLng.lng()}); 
    } 
  });

  let meMarker = new google.maps.Marker({
    map: map,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: '#007AFF',
      fillOpacity: 1,
      strokeColor: 'white',
      strokeWeight: 2
    },
    title: "現在地"
  });

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      meMarker.setPosition(myPos);
    }, error => {
      console.log("位置情報取得エラー:", error);
    }, { 
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 5000 
    });
  }

  checkUrlParams();
  if(document.getElementById('wind').value && !isNaN(latA)) setTimeout(() => calculateCourse(true), 500);
}

function movePoint(lat,lng,dist,bearing){
  const R=6378137, brng=(bearing%360)*Math.PI/180;
  const φ1=lat*Math.PI/180, λ1=lng*Math.PI/180, δ=dist/R;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(brng));
  const λ2=λ1+Math.atan2(Math.sin(brng)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return {lat: φ2*180/Math.PI, lng: λ2*180/Math.PI};
}

function getPointsStructure(baseA, wind, dist, theta, course, isPort) {
  let p = {A: baseA};
  const isS = (course==='sausage'), isJW = (course==='jwsa'), isJW2 = (course==='jwsa2'), 
        isJW3 = (course==='jwsa3'), isJW5 = (course==='jwsa5'), 
        is5J = (course==='5jibe'), isF8 = (course==='figure8');

  if(isS){
    const dAS = 100; // AS距離デフォルト100
    const sAng = parseFloat(document.getElementById('sAngle').value) || 0;
    const bS = wind + (isPort ? (90 + theta + sAng) : (270 - theta - sAng));
    p.S = movePoint(p.A.lat, p.A.lng, dAS, bS);
    const mid = {lat:(p.A.lat+p.S.lat)/2, lng:(p.A.lng+p.S.lng)/2};
    p.B = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('upDist').value)||0, wind);
    const dDown = parseFloat(document.getElementById('downDist').value)||0;
    p.C = movePoint(mid.lat, mid.lng, dDown, wind); 
  }
  else if(isJW || isJW2 || isJW3 || isJW5){
    const sfx = (isJW3 || isJW5) ? '3' : '2';
    const dAB=parseFloat(document.getElementById('distAB'+sfx).value)||0, dBC=parseFloat(document.getElementById('distBC'+sfx).value)||0, dCD=parseFloat(document.getElementById('distCD'+sfx).value)||0, dDE=parseFloat(document.getElementById('distDE'+sfx).value)||0, thD=30, thB=45; // 角D:30, 角B:45デフォルト
    p.B = movePoint(p.A.lat, p.A.lng, dAB, isPort?wind+theta+90:wind-theta+270);
    const bF = isPort ? (wind+270+thB) : (wind+90-thB);
    p.F = movePoint(p.B.lat, p.B.lng, dBC, bF);
    p.G = movePoint(p.F.lat, p.F.lng, dCD, wind);
    if(!isJW5) {
      const bK = isPort ? (wind+270-thD) : (wind+90+thD);
      p.K = movePoint(p.G.lat, p.G.lng, dDE, bK);
    }
    if(isJW3 || isJW5){
      p.C = movePoint(p.B.lat, p.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
      p.D = movePoint(p.C.lat, p.C.lng, dist, isPort?wind+90+theta:wind+270-theta);
      p.E = movePoint(p.D.lat, p.D.lng, dist, isPort?wind+270-theta:wind+90+theta);
    }
  } else {
    p.B = movePoint(p.A.lat, p.A.lng, dist, isPort?wind+90+theta:wind+270-theta);
    if(isF8) {
      p.C = movePoint(p.B.lat, p.B.lng, dist * Math.cos(theta * Math.PI / 180), isPort?wind+270:wind+90);
      p.E = movePoint(p.B.lat, p.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
    } else {
      p.C = movePoint(p.B.lat, p.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
      p.D = movePoint(p.C.lat, p.C.lng, dist, isPort?wind+90+theta:wind+270-theta);
      p.E = movePoint(p.D.lat, p.D.lng, dist, isPort?wind+270-theta:wind+90+theta);
      if(is5J){ p.F = movePoint(p.E.lat, p.E.lng, dist, isPort?wind+90+theta:wind+270-theta); p.G = movePoint(p.F.lat, p.F.lng, dist, isPort?wind+270-theta:wind+90+theta); }
    }
  }
  return p;
}

function calculateCourse(isPort){
  currentIsPort = isPort;
  const latA=parseFloat(document.getElementById('latA').value), lngA=parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA)||isNaN(lngA)) return;
  const wind=parseFloat(document.getElementById('wind').value)||0, dist=parseFloat(document.getElementById('dist').value)||0, theta=parseFloat(document.getElementById('theta').value)||0, course=document.getElementById('courseSelect').value;
  polylines.forEach(pl => pl.setMap(null)); polylines = [];
  Object.keys(points).forEach(k => { if(circles[k])circles[k].setMap(null); if(markersLabel[k])markersLabel[k].setMap(null); points[k]=null; });
  points = getPointsStructure({lat:latA, lng:lngA}, wind, dist, theta, course, isPort);

  const isM = (course==='mcourse'), isF8 = (course==='figure8'), isS = (course==='sausage'), is5J = (course==='5jibe'), isJW3 = (course==='jwsa3'), isJW5 = (course==='jwsa5'), isJW = (course==='jwsa'), isJW2 = (course==='jwsa2');

  document.getElementById('btnC').style.display = (isM || isF8 || isS || is5J || isJW3 || isJW5) ? 'flex' : 'none';
  document.getElementById('btnD').style.display = (isM || is5J || isJW3 || isJW5) ? 'flex' : 'none';
  document.getElementById('btnE').style.display = (isM || isF8 || is5J || isJW3 || isJW5) ? 'flex' : 'none';
  document.getElementById('btnF').style.display = (isJW2 || isJW3 || isJW5 || is5J) ? 'flex' : 'none';
  document.getElementById('btnG').style.display = (isJW2 || isJW3 || isJW5 || is5J) ? 'flex' : 'none';
  document.getElementById('btnK').style.display = (isJW2 || isJW3 || isJW) ? 'flex' : 'none';
  document.getElementById('btnS').style.display = isS ? 'flex' : 'none';

  path = [];
  if(isS) path = [points.S, points.A, points.B, points.C, points.B, points.C, points.A];
  else if(isJW) path = [points.A, points.B, points.G, points.K, points.B, points.A];
  else if(isJW2) path = [points.A, points.B, points.F, points.G, points.K, points.B, points.A];
  else if(isJW3) path = [points.A, points.B, points.F, points.G, points.K, points.B, points.C, points.D, points.E];
  else if(isJW5) path = [points.A, points.B, points.F, points.G, points.B, points.C, points.D, points.E];
  else if(is5J) path = [points.A, points.B, points.C, points.D, points.E, points.F, points.G];
  else path = [points.A, points.B, points.C, points.D, points.E].filter(v => v);

  polylines.push(new google.maps.Polyline({path:path, strokeColor:'#444', strokeWeight:2, map}));
  Object.keys(points).forEach(k => { if(points[k]) drawPoint(k, points[k], COLORS[k], k); });
  updateDistModalContent(isJW3, is5J);
}

function updateDistModalContent(isJW3, is5J){
  const area = document.getElementById('distResultArea');
  let html = `<div class="dist-item">A～C：${distanceBetween(points.A,points.C).toFixed(1)} m</div>`;
  if(points.E) html += `<div class="dist-item">A～E：${distanceBetween(points.A,points.E).toFixed(1)} m</div>`;
  if(is5J) html += `<div class="dist-item">A～G：${distanceBetween(points.A,points.G).toFixed(1)} m</div>`;
  area.innerHTML = html;
}

function setBasePosition(pos) {
  const baseLabel = document.getElementById('basePointSelect').value;
  const wind=parseFloat(document.getElementById('wind').value)||0, dist=parseFloat(document.getElementById('dist').value)||0, theta=parseFloat(document.getElementById('theta').value)||0, course=document.getElementById('courseSelect').value;
  const tempStructure = getPointsStructure({lat:0,lng:0}, wind, dist, theta, course, currentIsPort);
  const targetRel = tempStructure[baseLabel];
  if(!targetRel || (targetRel.lat === 0 && targetRel.lng === 0)) { updateAPos(pos.lat, pos.lng); }
  else {
    const R=6378137, dy=targetRel.lat*(Math.PI/180)*R, dx=targetRel.lng*(Math.PI/180)*R;
    const d=Math.sqrt(dx*dx+dy*dy), brng=(Math.atan2(dx,dy)*180/Math.PI+360)%360;
    const realA = movePoint(pos.lat, pos.lng, d, (brng+180)%360);
    updateAPos(realA.lat, realA.lng);
  }
  calculateCourse(currentIsPort);
}

function updateAPos(lat, lng) {
  document.getElementById('latA').value = lat.toFixed(6);
  document.getElementById('lngA').value = lng.toFixed(6);
  document.getElementById('modalLat').value = lat.toFixed(6);
  document.getElementById('modalLng').value = lng.toFixed(6);
}

function drawPoint(label,pos,color,displayText){
  displayText=displayText||label;
  circles[label]=new google.maps.Circle({ map, center:pos, radius:(label==='A'?16:12), strokeColor:color, strokeOpacity:1, strokeWeight:2, fillColor:color, fillOpacity:0.8 });
  markersLabel[label]=new google.maps.Marker({ position:pos, map, icon:{path:google.maps.SymbolPath.CIRCLE, scale:0}, label:{text:displayText, color:(label==='C'&&displayText==='C'?'#000':'#fff'), fontWeight:"bold", fontSize:"13px"} });
}

function distanceBetween(p1,p2){ if(!p1||!p2)return 0; const R=6378137, dφ=(p2.lat-p1.lat)*Math.PI/180, dλ=(p2.lng-p1.lng)*Math.PI/180; const a=Math.sin(dφ/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dλ/2)**2; return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }









// --- ここはそのまま ---
function shareCoords(l,p){ 
  if(!p)return; 
  const t=`${l}点\n${p.lat.toFixed(6)},${p.lng.toFixed(6)}\nhttps://www.google.com/maps?q=${p.lat},${p.lng}`; 
  if(navigator.share)navigator.share({text:t}).catch(()=>{}); else alert(t); 
}

// --- ★ここを追加する（割り込ませる） ---
window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'updateWind') {
    const windInput = document.getElementById('wind');
    if (windInput) {
      windInput.value = event.data.wind;
      calculateCourse(currentIsPort); 
    }
  }
});




window.addEventListener('load', ()=>{ 
  // ここに移動（追加）します！
  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'updateWind') {
      const windInput = document.getElementById('wind');
      if (windInput) {
        windInput.value = event.data.wind;
        calculateCourse(currentIsPort); 
      }
    }
  });





  document.getElementById('btnStarboard').onclick=()=>calculateCourse(false);
  document.getElementById('btnPort').onclick=()=>calculateCourse(true);

  document.getElementById('btnShareAll').onclick = () => {
    if (!points || !points.A) { alert("地点データがありません。"); return; }
    const wind = document.getElementById('wind').value || 0;
    const dist = document.getElementById('dist').value || 500;
    const theta = document.getElementById('theta').value || 5;
    const courseSelect = document.getElementById('courseSelect');
    const courseValue = courseSelect.value;
    const courseName = courseSelect.options[courseSelect.selectedIndex].text;
    const baseUrl = window.location.origin + window.location.pathname;
    const params = `?lat=${points.A.lat.toFixed(6)}&lng=${points.A.lng.toFixed(6)}&twd=${wind}&dist=${dist}&theta=${theta}&course=${courseValue}`;
    const shareUrl = baseUrl + params;

    let t = `【${courseName}】風向:${wind}°\n距離:${dist}m / 角度:${theta}°\n\n`;
    const order = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'K', 'S'];
    order.forEach(key => { if (points[key]) t += `${key}: ${points[key].lat.toFixed(6)},${points[key].lng.toFixed(6)}\n`; });
    t += `\n▼アプリでコース図を再現\n${shareUrl}`;
    if (navigator.share) navigator.share({ text: t }).catch(() => {}); else alert(t);
  };

  document.getElementById('btnSetCurrent').onclick = () => { 
    const mode = document.querySelector('input[name="aMode"]:checked').value; 
    if (mode === 'gps') { 
      navigator.geolocation.getCurrentPosition(p => { setBasePosition({ lat: p.coords.latitude, lng: p.coords.longitude }); }, e => alert("取得失敗")); 
    } else alert("地図上をタップしてください"); 
  };

  ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'K', 'S'].forEach(l => { 
    const btn = document.getElementById('btn' + l); 
    if (btn) btn.onclick = () => shareCoords(l, points[l]); 
  });

  document.getElementById('courseSelect').onchange = (e) => {
    const v = e.target.value;
    const dI = document.getElementById('dist'), tI = document.getElementById('theta');
    dI.value = (v === 'sausage') ? 100 : 500;
    tI.value = (v === 'sausage') ? 0 : 5; 
    ['sausage', 'jwsa', 'jwsa2', 'jwsa3'].forEach(s => {
      const el = document.getElementById(s + 'Settings');
      if (el) {
        if (v === 'jwsa5' && s === 'jwsa3') el.style.display = 'flex';
        else el.style.display = (v === s) ? 'flex' : 'none';
      }
    });
    calculateCourse(currentIsPort);
  };

  document.getElementById('btnOpenCoordModal').onclick = () => { document.getElementById('modalOverlay').style.display = 'flex'; };
  document.getElementById('btnModalClose').onclick = () => {
    const lat = parseFloat(document.getElementById('modalLat').value), lng = parseFloat(document.getElementById('modalLng').value);
    if(!isNaN(lat) && !isNaN(lng)) { updateAPos(lat, lng); if(map) map.setCenter({lat, lng}); calculateCourse(currentIsPort); }
    document.getElementById('modalOverlay').style.display = 'none';
  };
  document.getElementById('btnOpenDistModal').onclick = () => { document.getElementById('distModalOverlay').style.display = 'flex'; };
  document.getElementById('btnDistModalClose').onclick = () => { document.getElementById('distModalOverlay').style.display = 'none'; };
  
  initMap();
});
</script>





<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>
</body>
</html>













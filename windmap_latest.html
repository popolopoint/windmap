<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>„Ç≥„Éº„Çπ‰Ωú„Çã„Åè„Çì v7.1.1 by Popolo App.com</title>
<style>
:root{ --red:#ff3b30; --blue:#0000ff; --yellow:#ffff00; --green:#28a745; --purple:#6a1b9a; --orange:#f57c00; --gray:#555; --navy:#000080; --pink:#ff2d55; --teal:#5ac8fa; }
body { font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN",sans-serif; margin:10px; color:#222; overflow-x: hidden; background:#f8f9fa; }
h2 { margin:0 0 8px 0; font-size:18px; }
.status-bar { font-size: 11px; background: #fff; padding: 6px; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 10px; text-align: center; font-weight: bold; color: #555; }

.input-row { display: flex; gap: 5px; width: 100%; margin-bottom: 10px; }
.input-group { flex: 1; display: flex; flex-direction: column; }
.input-group label { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
.input-group input { font-size: 24px; padding: 8px 4px; width: 100%; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; text-align: center; }

#courseSelect { font-size: 24px; padding: 8px; width: 100%; border-radius:6px; margin-bottom:10px; }
.compact-input { font-size: 18px !important; padding: 6px 2px !important; width: 55px !important; text-align:center; border-radius:6px; border:1px solid #ccc; }
#sausageSettings, #jwsaSettings, #jwsa2Settings, #jwsa3Settings { display:none; flex-wrap:nowrap; align-items:center; gap:4px; background:#f0f0f0; padding:5px; border-radius:8px; margin-bottom:10px; width: 100%; box-sizing: border-box; overflow-x: auto; }

.main-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; margin: 10px 0; }
.main-buttons button { font-size: 18px; padding: 15px 5px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.16); }
#btnShareAll { background: var(--gray); }
#btnStarboard { background: var(--green); }
#btnPort { background: var(--orange); }

#map { width:100%; height:500px; border-radius:8px; margin-top:10px; box-shadow:0 1px 4px rgba(0,0,0,0.2); }
#loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 4000; font-weight: bold; color: #3498db; }
#coordsContainer { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; justify-content: space-between; }
.pointBox { border-radius:50%; width:40px; height:40px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<div id="loading">üì° Ê∞¥Ê∑±„Éá„Éº„ÇøÂèñÂæó‰∏≠...</div>
<h2>„Ç≥„Éº„Çπ‰Ωú„Çã„Åè„Çì <span style="font-size:0.7em;">v7.1.1 by Popolo App.com</span></h2>

<div class="status-bar" id="tide-status">üåä ÊΩÆ‰Ωç„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>

<div class="input-row">
  <div class="input-group"><label>È¢®Âêë</label><input type="number" id="wind" step="any" placeholder="0"></div>
  <div class="input-group"><label>Ë∑ùÈõ¢(m)</label><input type="number" id="dist" value="500"></div>
  <div class="input-group"><label>ÊôÇÂàª</label><input type="time" id="sim-time" style="font-size:20px; text-align:center;"></div>
</div>

<select id="courseSelect">
  <option value="mcourse">Ôº≠„Ç≥„Éº„Çπ</option>
  <option value="figure8">„Éï„Ç£„ÇÆ„Ç¢Ôºò</option>
  <option value="sausage">„ÇΩ„Éº„Çª„Éº„Ç∏</option>
  <option value="5jibe">Ôºï„Ç∏„É£„Ç§„Éñ</option>
  <option value="jwsa">JWSA1</option>
  <option value="jwsa2">JWSA2</option>
  <option value="jwsa3">JWSA3</option>
</select>

<div id="sausageSettings">
  <label>‰∏ä<br><input type="number" id="upDist" class="compact-input" value="1000"></label>
  <label>AS‰∏ã<br><input type="number" id="downDist" class="compact-input" value="100"></label>
</div>
<div id="jwsaSettings">
  <label>AB<br><input type="number" id="distAB" class="compact-input" value="500"></label>
  <label>BG<br><input type="number" id="distBC" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distCD" class="compact-input" value="500"></label>
  <label>ËßíD<br><input type="number" id="theta2" class="compact-input" value="30"></label>
</div>
<div id="jwsa2Settings">
  <label>AB<br><input type="number" id="distAB2" class="compact-input" value="500"></label>
  <label>BF<br><input type="number" id="distBC2" class="compact-input" value="200"></label>
  <label>FG<br><input type="number" id="distCD2" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distDE" class="compact-input" value="500"></label>
  <label>ËßíB<br><input type="number" id="theta3" class="compact-input" value="45"></label>
  <label>ËßíD<br><input type="number" id="theta2_2" class="compact-input" value="30"></label>
</div>
<div id="jwsa3Settings">
  <label>AB<br><input type="number" id="distAB3" class="compact-input" value="500"></label>
  <label>BF<br><input type="number" id="distBC3" class="compact-input" value="200"></label>
  <label>FG<br><input type="number" id="distCD3" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distDE3" class="compact-input" value="500"></label>
  <label>ËßíB<br><input type="number" id="theta3_3" class="compact-input" value="45"></label>
  <label>ËßíD<br><input type="number" id="theta2_3" class="compact-input" value="30"></label>
</div>

<div class="main-buttons">
  <button id="btnShareAll">„Éá„Éº„ÇøÈÄÅ‰ø°</button>
  <button id="btnStarboard">„Çπ„Çø„Éú„Éº</button>
  <button id="btnPort">„Éù„Éº„Éà</button>
</div>

<div id="map"></div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:var(--red);">A</div>
  <div class="pointBox" id="btnB" style="background:var(--blue);">B</div>
  <div class="pointBox" id="btnC" style="background:var(--yellow); color:#000;">C</div>
  <div class="pointBox" id="btnD" style="background:var(--green);">D</div>
</div>

<input type="hidden" id="latA"><input type="hidden" id="lngA">

<script>
// Ê∞¥Ê∑±Ê∏¨„Å£Â§™ÈÉé„ÅÆGAS URL
const TIDE_APP_URL = "‚òÖ„Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆGAS„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë‚òÖ";

let map, polylines=[], depthMarkers=[], fullTideData=[], allPointsData=[], currentTide=0;
let points = {A:null,B:null,C:null,D:null,E:null,F:null,G:null,S:null,K:null};
const COLORS = { A:'#ff3b30', B:'#0000ff', C:'#ffff00', D:'#28a745', E:'#6a1b9a', F:'#ff2d55', G:'#000080', S:'#0000ff', K:'#5ac8fa' };
let currentIsPort = true;

// ÂàùÊúüÊôÇÂàª„Çª„ÉÉ„Éà
const now = new Date();
document.getElementById('sim-time').value = now.toTimeString().slice(0,5);

async function initMap(){
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 26.3318, lng: 127.9179 },
    zoom: 14,
    mapTypeId: 'hybrid',
    disableDefaultUI: true,
    zoomControl: true
  });
  
  await loadDepthData();
  calculateCourse(true);
  
  document.getElementById('sim-time').addEventListener('change', updateTideAndMarkers);
}

async function loadDepthData() {
  document.getElementById('loading').style.display = 'flex';
  try {
    const res = await fetch(TIDE_APP_URL);
    const data = await res.json();
    fullTideData = data.allTideData || [];
    allPointsData = data.points || [];
    updateTideAndMarkers();
  } catch (e) {
    document.getElementById('tide-status').textContent = "‚ùå „Éá„Éº„ÇøÂèñÂæóÂ§±Êïó";
  }
  document.getElementById('loading').style.display = 'none';
}

function updateTideAndMarkers() {
  if (fullTideData.length === 0) return;
  const timeVal = document.getElementById('sim-time').value;
  const [h, m] = timeVal.split(':').map(Number);
  const now = new Date();
  
  const row = fullTideData.find(r => {
    const rd = new Date(r[0]);
    return rd.getDate() === now.getDate() && (rd.getMonth()+1) === (now.getMonth()+1);
  });

  if (row) {
    const t1 = parseFloat(row[1+h]), t2 = (h<23)?parseFloat(row[1+h+1]):t1;
    currentTide = t1 + (t2-t1)*(m/60);
    document.getElementById('tide-status').textContent = `üåä ‰∫àÊÉ≥ÊΩÆ‰Ωç(${timeVal}): ${currentTide.toFixed(1)}cm`;
    refreshDepthMarkers();
  }
}

function refreshDepthMarkers() {
  depthMarkers.forEach(m => m.setMap(null));
  depthMarkers = [];
  allPointsData.forEach(p => {
    const baseDepth = parseFloat(p[4]) || 0;
    const simDepth = baseDepth + currentTide;
    
    let sym = google.maps.SymbolPath.CIRCLE;
    if(p[6] === "Â≤©") sym = "M 0,-1.1 L 1.2,1 L -1.2,1 Z";
    else if(p[6] === "Êù≠") sym = "M 0,-1.2 L 1,0 L 0,1.2 L -1,0 Z";

    const m = new google.maps.Marker({
      position: {lat: Number(p[1]), lng: Number(p[2])},
      map: map,
      icon: { path: sym, fillColor: getDepthColor(simDepth), fillOpacity: 0.8, scale: 6, strokeColor: "#000", strokeWeight: 1 },
      title: `${p[6]}: ${simDepth.toFixed(1)}cm`
    });
    depthMarkers.push(m);
  });
}

function getDepthColor(d) {
  if (d < 15) return "#ff0000"; if (d < 40) return "#ff8c00"; if (d < 70) return "#ffff00";
  if (d < 100) return "#00ff00"; if (d < 140) return "#0000ff"; if (d < 180) return "#4b0082";
  return "#8e44ad";
}

// Êó¢Â≠ò„ÅÆË®àÁÆó„ÉªÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØÔºà„Åù„ÅÆ„Åæ„ÅæÁµ±ÂêàÔºâ
function movePoint(lat,lng,dist,bearing){
  const R=6378137, brng=(bearing%360)*Math.PI/180;
  const œÜ1=lat*Math.PI/180, Œª1=lng*Math.PI/180, Œ¥=dist/R;
  const œÜ2=Math.asin(Math.sin(œÜ1)*Math.cos(Œ¥)+Math.cos(œÜ1)*Math.sin(Œ¥)*Math.cos(brng));
  const Œª2=Œª1+Math.atan2(Math.sin(brng)*Math.sin(Œ¥)*Math.cos(œÜ1), Math.cos(Œ¥)-Math.sin(œÜ1)*Math.sin(œÜ2));
  return {lat: œÜ2*180/Math.PI, lng: Œª2*180/Math.PI};
}

function getPointsStructure(baseA, wind, dist, theta, course, isPort) {
  let p = {A: baseA};
  const isS = (course==='sausage'), isJW = (course==='jwsa'), isJW2 = (course==='jwsa2'), isJW3 = (course==='jwsa3');
  if(isS){
    const bS = wind + (isPort?90+theta:270-theta);
    p.S = movePoint(p.A.lat, p.A.lng, 100, bS);
    const mid = {lat:(p.A.lat+p.S.lat)/2, lng:(p.A.lng+p.S.lng)/2};
    p.B = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('upDist').value)||0, wind);
    p.C = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('downDist').value)||0, (wind+180)%360);
  } else if(isJW || isJW2 || isJW3){
    const sfx = isJW3 ? '3' : (isJW2 ? '2' : '');
    const dAB=parseFloat(document.getElementById('distAB'+sfx).value)||500;
    const thD=parseFloat(document.getElementById('theta2'+(sfx?('_'+sfx):'')).value)||30;
    p.B = movePoint(p.A.lat, p.A.lng, dAB, isPort?wind+theta+90:wind-theta+270);
    // ... (JWSA„ÅÆÂ∫ßÊ®ôË®àÁÆó„ÅØ„ÅîÊèêÁ§∫„ÅÆ„Ç≥„Éº„Éâ„Å®ÂêåÊßò)
  }
  // ‚ÄªÁ∞°Áï•Âåñ„ÅÆ„Åü„ÇÅ„ÄÅ„ÅîÊèêÁ§∫„ÅÆ„Ç≥„Éº„Éâ„ÅÆË®àÁÆóÂºè„ÇíÁ∂≠ÊåÅ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
  return p;
}

function calculateCourse(isPort){
  currentIsPort = isPort;
  const latA=parseFloat(document.getElementById('latA').value)||26.3318;
  const lngA=parseFloat(document.getElementById('lngA').value)||127.9179;
  const wind=parseFloat(document.getElementById('wind').value)||0, dist=parseFloat(document.getElementById('dist').value)||500, theta=parseFloat(document.getElementById('theta').value)||5, course=document.getElementById('courseSelect').value;
  
  polylines.forEach(p => p.setMap(null)); polylines = [];
  // („Éû„Éº„Ç´„Éº„ÇØ„É™„Ç¢Á≠â„ÅÆÂá¶ÁêÜ)
  // ... („Åì„Åì„Å´„Ç≥„Éº„ÇπÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØ„ÇíÁµ±Âêà)
}

window.addEventListener('load', ()=>{
  document.getElementById('btnStarboard').onclick=()=>calculateCourse(false);
  document.getElementById('btnPort').onclick=()=>calculateCourse(true);
  document.getElementById('courseSelect').onchange=(e)=>{
    const v=e.target.value; 
    document.getElementById('dist').value=(v==='sausage')?100:500;
    ['sausage','jwsa','jwsa2','jwsa3'].forEach(s=>{ document.getElementById(s+'Settings').style.display=(v===s)?'flex':'none'; });
    calculateCourse(currentIsPort);
  };
  initMap();
});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>
</body>
</html>
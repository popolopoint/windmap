<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ã‚³ãƒ¼ã‚¹ä½œã‚‹ãã‚“ v7.1.2 by Popolo App.com</title>
<style>
/* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶™æ‰¿ã—ã€æ°´æ·±è¡¨ç¤ºç”¨ã®å¾®èª¿æ•´ã‚’è¿½åŠ  */
:root{ --red:#ff3b30; --blue:#0000ff; --yellow:#ffff00; --green:#28a745; --purple:#6a1b9a; --orange:#f57c00; --gray:#555; --navy:#000080; --pink:#ff2d55; --teal:#5ac8fa; }
body { font-family: -apple-system,sans-serif; margin:10px; color:#222; overflow-x: hidden; background:#f8f9fa; }
h2 { margin:0 0 8px 0; font-size:18px; }
#version { position:absolute; right:12px; top:12px; color:#666; font-size:13px; }

.input-row { display: flex; gap: 5px; width: 100%; margin-bottom: 10px; }
.input-group { flex: 1; display: flex; flex-direction: column; }
.input-group label { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
.input-group input { font-size: 24px; padding: 8px 4px; width: 100%; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; text-align: center; }

#courseSelect { font-size: 24px; padding: 8px; width: 100%; border-radius:6px; margin-bottom:10px; border: 2px solid #007aff; }

.compact-input { font-size: 18px !important; padding: 6px 2px !important; width: 55px !important; text-align:center; border-radius:6px; border:1px solid #ccc; }
#sausageSettings, #jwsaSettings, #jwsa2Settings, #jwsa3Settings { display:none; flex-wrap:nowrap; align-items:center; gap:4px; background:#eef; padding:8px; border-radius:8px; margin-bottom:10px; width: 100%; box-sizing: border-box; overflow-x: auto; }

.main-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; margin: 10px 0; }
.main-buttons button { font-size: 18px; padding: 15px 5px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.16); }
#btnShareAll { background: var(--gray); }
#btnStarboard { background: var(--green); }
#btnPort { background: var(--orange); }

#inputsMode { margin:15px 0; padding:12px; background:#fff; border-radius:8px; font-size: 16px; border:1px solid #3498db; }
#btnSetCurrent { background: var(--red); color:white; border:none; padding:12px; border-radius:6px; font-weight:bold; margin-top:10px; width:100%; font-size:18px; }

#map { width:100%; height:600px; border-radius:8px; margin-top:10px; box-shadow:0 1px 4px rgba(0,0,0,0.2); }
#coordsContainer { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; justify-content: space-between; }
.pointBox { border-radius:50%; width:40px; height:40px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

#loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:none; justify-content:center; align-items:center; z-index:2000; font-weight:bold; }
</style>
</head>
<body>

<div id="loading">ğŸ“¡ æ°´æ·±ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...</div>
<h2>ã‚³ãƒ¼ã‚¹ä½œã‚‹ãã‚“ <span style="font-size:0.7em;">v7.1.2 by Popolo App.com</span></h2>
<div id="version">v7.1.2</div>

<div class="input-row">
  <div class="input-group"><label>é¢¨å‘</label><input type="number" id="wind" step="any" placeholder="0"></div>
  <div class="input-group"><label>è·é›¢(m)</label><input type="number" id="dist" value="500"></div>
  <div class="input-group"><label>è§’åº¦(Â°)</label><input type="number" id="theta" value="5"></div>
</div>

<select id="courseSelect">
  <option value="mcourse">ï¼­ã‚³ãƒ¼ã‚¹</option>
  <option value="figure8">ãƒ•ã‚£ã‚®ã‚¢ï¼˜</option>
  <option value="sausage">ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸</option>
  <option value="5jibe">ï¼•ã‚¸ãƒ£ã‚¤ãƒ–</option>
  <option value="jwsa">JWSA1</option>
  <option value="jwsa2">JWSA2</option>
  <option value="jwsa3">JWSA3</option>
</select>

<div id="sausageSettings">
  <label>ä¸Š<br><input type="number" id="upDist" class="compact-input" value="1000"></label>
  <label>ä¸‹(AS)<br><input type="number" id="downDist" class="compact-input" value="100"></label>
</div>
<div id="jwsaSettings">
  <label>AB<br><input type="number" id="distAB" class="compact-input" value="500"></label>
  <label>BG<br><input type="number" id="distBC" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distCD" class="compact-input" value="500"></label>
  <label>è§’D<br><input type="number" id="angleD" class="compact-input" value="30"></label>
</div>
<div id="jwsa2Settings">
  <label>AB<br><input type="number" id="distAB2" class="compact-input" value="500"></label>
  <label>BF<br><input type="number" id="distBC2" class="compact-input" value="200"></label>
  <label>FG<br><input type="number" id="distCD2" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distDE2" class="compact-input" value="500"></label>
  <label>è§’B<br><input type="number" id="angleB2" class="compact-input" value="45"></label>
  <label>è§’D<br><input type="number" id="angleD2" class="compact-input" value="30"></label>
</div>
<div id="jwsa3Settings">
  <label>AB<br><input type="number" id="distAB3" class="compact-input" value="500"></label>
  <label>BF<br><input type="number" id="distBC3" class="compact-input" value="200"></label>
  <label>FG<br><input type="number" id="distCD3" class="compact-input" value="500"></label>
  <label>GK<br><input type="number" id="distDE3" class="compact-input" value="500"></label>
  <label>è§’B<br><input type="number" id="angleB3" class="compact-input" value="45"></label>
  <label>è§’D<br><input type="number" id="angleD3" class="compact-input" value="30"></label>
</div>

<div class="main-buttons">
  <button id="btnShareAll">ä¸€æ‹¬é€ä¿¡</button>
  <button id="btnStarboard">ã‚¹ã‚¿ãƒœãƒ¼</button>
  <button id="btnPort">ãƒãƒ¼ãƒˆ</button>
</div>

<div id="inputsMode">
  <strong>åŸºæº–ç‚¹ï¼š</strong>
  <select id="basePointSelect">
    <option value="A" selected>Aç‚¹</option><option value="B">Bç‚¹</option><option value="C">Cç‚¹</option>
    <option value="D">Dç‚¹</option><option value="E">Eç‚¹</option><option value="F">Fç‚¹</option><option value="G">Gç‚¹</option><option value="S">Sç‚¹</option><option value="K">Kç‚¹</option>
  </select>
  <div style="margin:10px 0;">
    <label><input type="radio" name="aMode" value="gps" checked> ç¾åœ¨åœ°ã‚’ã‚»ãƒƒãƒˆ</label>
    <label style="margin-left:15px;"><input type="radio" name="aMode" value="map"> ãƒãƒƒãƒ—æŒ‡å®š</label>
  </div>
  <button id="btnSetCurrent">è¨ˆç®—ãƒ»åæ˜ </button>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:var(--red);">A</div>
  <div class="pointBox" id="btnB" style="background:var(--blue);">B</div>
  <div class="pointBox" id="btnC" style="background:var(--yellow); color:#000;">C</div>
  <div class="pointBox" id="btnD" style="background:var(--green);">D</div>
  <div class="pointBox" id="btnE" style="background:var(--purple);">E</div>
  <div class="pointBox" id="btnF" style="background:var(--pink); display:none;">F</div>
  <div class="pointBox" id="btnG" style="background:var(--navy); display:none;">G</div>
  <div class="pointBox" id="btnK" style="background:var(--teal); display:none;">K</div>
  <div class="pointBox" id="btnS" style="background:var(--blue); display:none;">S</div>
</div>

<div id="map"></div>
<input type="hidden" id="latA"><input type="hidden" id="lngA">

<script>
// â˜… æ°´æ·±æ¸¬ã£å¤ªéƒã¨åŒã˜GAS URLã‚’è‡ªå‹•é€£æº
const DEPTH_GAS_URL = "https://script.google.com/macros/s/AKfycbw1wg_a28-_dOyLbik9VnYfbzKEHPNBWwaVVeyc4gcibovUIQ5BUGNw1esYy0beyZVf3g/exec";
let map, points = {A:null,B:null,C:null,D:null,E:null,F:null,G:null,S:null,K:null};
let polylines = [], circles = {}, labels = [], depthMarkers = [];
let currentIsPort = true;

const COLORS = { A:'#ff3b30', B:'#0000ff', C:'#ffff00', D:'#28a745', E:'#6a1b9a', F:'#ff2d55', G:'#000080', S:'#0000ff', K:'#5ac8fa' };

async function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 26.3318, lng: 127.9179 },
        zoom: 15,
        mapTypeId: 'roadmap', // ãƒãƒƒãƒ—è¡¨ç¤ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
        gestureHandling: 'greedy',
        disableDefaultUI: true,
        zoomControl: true
    });

    map.addListener('click', (e) => {
        if (document.querySelector('input[name="aMode"]:checked').value === 'map') {
            setBasePosition({ lat: e.latLng.lat(), lng: e.latLng.lng() });
        }
    });

    // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«æ°´æ·±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    loadDepthData();
}

async function loadDepthData() {
    document.getElementById('loading').style.display = 'flex';
    try {
        const res = await fetch(DEPTH_GAS_URL);
        const data = await res.json();
        drawDepthMarkers(data.points || []);
    } catch (e) { console.error("æ°´æ·±ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—"); }
    document.getElementById('loading').style.display = 'none';
}

function drawDepthMarkers(points) {
    depthMarkers.forEach(m => m.setMap(null));
    depthMarkers = [];
    points.forEach(p => {
        const marker = new google.maps.Marker({
            position: { lat: Number(p[1]), lng: Number(p[2]) },
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: "#666",
                fillOpacity: 0.5,
                scale: 4,
                strokeWeight: 0
            },
            title: `æ°´æ·±: ${p[4]}cm`
        });
        depthMarkers.push(marker);
    });
}

function movePoint(lat, lng, dist, bearing) {
    const R = 6378137, brng = (bearing % 360) * Math.PI / 180;
    const Ï†1 = lat * Math.PI / 180, Î»1 = lng * Math.PI / 180, Î´ = dist / R;
    const Ï†2 = Math.asin(Math.sin(Ï†1) * Math.cos(Î´) + Math.cos(Ï†1) * Math.sin(Î´) * Math.cos(brng));
    const Î»2 = Î»1 + Math.atan2(Math.sin(brng) * Math.sin(Î´) * Math.cos(Ï†1), Math.cos(Î´) - Math.sin(Ï†1) * Math.sin(Ï†2));
    return { lat: Ï†2 * 180 / Math.PI, lng: Î»2 * 180 / Math.PI };
}

function calculateCourse(isPort) {
    currentIsPort = isPort;
    const latA = parseFloat(document.getElementById('latA').value), lngA = parseFloat(document.getElementById('lngA').value);
    if (isNaN(latA) || isNaN(lngA)) return;

    const wind = parseFloat(document.getElementById('wind').value) || 0;
    const dist = parseFloat(document.getElementById('dist').value) || 0;
    const theta = parseFloat(document.getElementById('theta').value) || 0;
    const course = document.getElementById('courseSelect').value;

    polylines.forEach(p => p.setMap(null));
    Object.keys(circles).forEach(k => circles[k].setMap(null));
    labels.forEach(l => l.setMap(null));

    points = getPointsStructure({ lat: latA, lng: lngA }, wind, dist, theta, course, isPort);

    // UIãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    const isS = (course === 'sausage'), isJW = (course.includes('jwsa'));
    document.getElementById('btnS').style.display = isS ? 'flex' : 'none';
    document.getElementById('btnC').style.display = (isS || course === 'jwsa2') ? 'none' : 'flex';

    let path = [];
    if (isS) path = [points.A, points.B, points.C, points.B, points.C, points.A];
    else if (course === 'jwsa') path = [points.A, points.B, points.C, points.D, points.B, points.A];
    else path = [points.A, points.B, points.C, points.D, points.E].filter(v => v);

    const poly = new google.maps.Polyline({ path, strokeColor: '#444', strokeWeight: 3, map });
    polylines.push(poly);

    Object.keys(points).forEach(k => {
        if (points[k]) drawMarker(k, points[k], COLORS[k]);
    });
}

function getPointsStructure(baseA, wind, dist, theta, course, isPort) {
    let p = { A: baseA };
    if (course === 'sausage') {
        const bS = wind + (isPort ? 90 + theta : 270 - theta);
        p.S = movePoint(p.A.lat, p.A.lng, 100, bS); // ASè·é›¢ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ100
        const mid = { lat: (p.A.lat + p.S.lat) / 2, lng: (p.A.lng + p.S.lng) / 2 };
        p.B = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('upDist').value), wind);
        p.C = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('downDist').value), wind);
    } else {
        p.B = movePoint(p.A.lat, p.A.lng, dist, isPort ? wind + 90 + theta : wind + 270 - theta);
        p.C = movePoint(p.B.lat, p.B.lng, dist, isPort ? wind + 270 - theta : wind + 90 + theta);
    }
    return p;
}

function drawMarker(label, pos, color) {
    circles[label] = new google.maps.Circle({
        map, center: pos, radius: 12,
        fillColor: color, fillOpacity: 0.8, strokeColor: '#000', strokeWeight: 1
    });
    const marker = new google.maps.Marker({
        position: pos, map, label: { text: label, color: '#fff', fontWeight: 'bold' },
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 }
    });
    labels.push(marker);
}

function setBasePosition(pos) {
    document.getElementById('latA').value = pos.lat.toFixed(6);
    document.getElementById('lngA').value = pos.lng.toFixed(6);
    calculateCourse(currentIsPort);
}

window.onload = () => {
    document.getElementById('btnStarboard').onclick = () => calculateCourse(false);
    document.getElementById('btnPort').onclick = () => calculateCourse(true);
    document.getElementById('btnSetCurrent').onclick = () => {
        if (document.querySelector('input[name="aMode"]:checked').value === 'gps') {
            navigator.geolocation.getCurrentPosition(p => setBasePosition({ lat: p.coords.latitude, lng: p.coords.longitude }));
        }
    };
    document.getElementById('courseSelect').onchange = (e) => {
        const v = e.target.value;
        ['sausage', 'jwsa', 'jwsa2', 'jwsa3'].forEach(s => {
            document.getElementById(s + 'Settings').style.display = (v === s) ? 'flex' : 'none';
        });
        calculateCourse(currentIsPort);
    };
    initMap();
};
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>
</body>
</html>
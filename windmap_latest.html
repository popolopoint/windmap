<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>コース作るくん v6.2.2b by Popolo App.com</title>
<style>
:root{ --red:#ff3b30; --blue:#0000ff; --yellow:#ffff00; --green:#28a745; --purple:#6a1b9a; --orange:#f57c00; --gray:#555; --pink:#ff2d55; --teal:#5ac8fa; }
body { font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN","メイリオ",Meiryo,sans-serif; margin:10px; color:#222; overflow-x: hidden; }
h2 { margin:0 0 8px 0; font-size:18px; }
#version { position:absolute; right:12px; top:12px; color:#666; font-size:13px; }

.input-row { display: flex; gap: 5px; width: 100%; margin-bottom: 10px; }
.input-group { flex: 1; display: flex; flex-direction: column; }
.input-group label { font-size: 11px; font-weight: bold; margin-bottom: 2px; }
.input-group input { font-size: 24px; padding: 8px 4px; width: 100%; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; text-align: center; }

#courseSelect { font-size: 24px; padding: 8px; width: 100%; border-radius:6px; margin-bottom:10px; }

.compact-input { font-size: 18px !important; padding: 6px 2px !important; width: 55px !important; text-align:center; border-radius:6px; border:1px solid #ccc; }
#sausageSettings, #jwsaSettings, #jwsa2Settings { display:none; flex-wrap:nowrap; align-items:center; gap:4px; background:#f0f0f0; padding:5px; border-radius:8px; margin-bottom:10px; width: 100%; box-sizing: border-box; overflow-x: auto; }

.main-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin: 10px 0; }
.main-buttons button { font-size: 22px; padding: 15px 10px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.16); display: flex; align-items: center; justify-content: center; }
#btnWindSet { background: var(--purple); }
#btnShareAll { background: var(--gray); }
#btnStarboard { background: var(--green); }
#btnPort { background: var(--orange); }

#inputsMode { margin:15px 0; padding:12px; background:#f0f7ff; border-radius:8px; font-size: 16px; color:#333; border:1px solid #d0e0f0; }
#inputsMode select { font-size: 22px; padding: 5px; margin: 0 5px; }
#btnSetCurrent { background: var(--red); color:white; border:none; padding:10px 15px; border-radius:6px; font-weight:bold; margin-top:10px; width:100%; font-size:18px; }

#map { width:100%; height:450px; border-radius:8px; margin-top:10px; box-shadow:0 1px 4px rgba(0,0,0,0.2); }
#distances { margin:10px 0; display:flex; gap:8px; flex-wrap:wrap; }
.distanceBox { background:#eee; padding:8px 12px; border-radius:6px; font-weight:bold; font-size: 1.1em; border: 1px solid #ddd; }
#coordsContainer { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; justify-content: space-between; }
.pointBox { border-radius:50%; width:55px; height:55px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; font-size: 1.3em; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<h2>コース作るくん <span style="font-size:0.7em;">v6.2.2b by Popolo App.com</span></h2>
<div id="version">v6.2.2b</div>

<div class="input-row">
  <div class="input-group"><label>風向</label><input type="number" id="wind" step="any" placeholder="0"></div>
  <div class="input-group"><label>距離(m)</label><input type="number" id="dist" value="500"></div>
  <div class="input-group"><label>角度(°)</label><input type="number" id="theta" value="5"></div>
</div>

<select id="courseSelect">
  <option value="mcourse">Ｍコース</option>
  <option value="figure8">フィギア８</option>
  <option value="sausage">ソーセージ</option>
  <option value="5jibe">５ジャイブ</option>
  <option value="jwsa">JWSA1</option>
  <option value="jwsa2">JWSA2</option>
</select>

<div id="sausageSettings">
  <label>上<br><input type="number" id="upDist" class="compact-input" value="1000"></label>
  <label>下<br><input type="number" id="downDist" class="compact-input" value="50"></label>
</div>
<div id="jwsaSettings">
  <label>AB<br><input type="number" id="distAB" class="compact-input" value="500"></label>
  <label>BC<br><input type="number" id="distBC" class="compact-input" value="500"></label>
  <label>CD<br><input type="number" id="distCD" class="compact-input" value="500"></label>
  <label>θ2<br><input type="number" id="theta2" class="compact-input" value="5"></label>
</div>
<div id="jwsa2Settings">
  <label>AB<br><input type="number" id="distAB2" class="compact-input" value="500"></label>
  <label>BC<br><input type="number" id="distBC2" class="compact-input" value="200"></label>
  <label>CD<br><input type="number" id="distCD2" class="compact-input" value="500"></label>
  <label>DE<br><input type="number" id="distDE" class="compact-input" value="500"></label>
  <label>θ2<br><input type="number" id="theta2_2" class="compact-input" value="5"></label>
  <label>θ3<br><input type="number" id="theta3" class="compact-input" value="15"></label>
</div>

<div class="main-buttons">
  <button id="btnWindSet">風向セット</button>
  <button id="btnShareAll">データ送信</button>
  <button id="btnStarboard">スタボー(右)</button>
  <button id="btnPort">ポート(左)</button>
</div>

<div id="inputsMode">
  <strong>基準点：</strong>
  <select id="basePointSelect">
    <option value="A" selected>A点</option><option value="B">B点</option><option value="C">C点</option>
    <option value="D">D点</option><option value="E">E点</option><option value="S">S点</option>
  </select>
  <button id="btnSetCurrent">反映</button>
</div>

<div id="distances">
  <div class="distanceBox" id="dAC">A～C：- m</div>
  <div class="distanceBox" id="dAE">A～E：- m</div>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:var(--red);">A</div>
  <div class="pointBox" id="btnB" style="background:var(--blue);">B</div>
  <div class="pointBox" id="btnC" style="background:var(--yellow); color:#000; text-shadow:none;">C</div>
  <div class="pointBox" id="btnD" style="background:var(--green);">D</div>
  <div class="pointBox" id="btnE" style="background:var(--purple);">E</div>
  <div class="pointBox" id="btnS" style="background:var(--blue); display:none;">S</div>
</div>

<div style="font-size:11px; color:#999; margin-top:10px; text-align:right;">
  算出A点: <span id="latA_disp">-</span> , <span id="lngA_disp">-</span>
  <input type="hidden" id="latA"><input type="hidden" id="lngA">
</div>

<div id="map"></div>

<script>
let map, circles={}, markersLabel={}, polylines=[];
let points = {A:null,B:null,C:null,D:null,E:null,F:null,G:null,S:null};
const COLORS = { A:'#ff3b30', B:'#0000ff', C:'#ffff00', D:'#28a745', E:'#6a1b9a', F:'#ff2d55', G:'#5ac8fa', S:'#0000ff' };
let currentIsPort = true;

function checkUrlParams() {
    const s = window.location.href;
    const hMatch = s.match(/[?&](heading|H|h)=([0-9.]+)/);
    const latMatch = s.match(/[?&]lat=([0-9.-]+)/);
    const lngMatch = s.match(/[?&]lng=([0-9.-]+)/);
    if (hMatch) document.getElementById('wind').value = hMatch[2];
    if (latMatch && lngMatch) {
        const lat = parseFloat(latMatch[1]), lng = parseFloat(lngMatch[2] || lngMatch[1]);
        updateAPos(lat, lng);
        if (map) map.setCenter({lat, lng});
    }
    if (hMatch && latMatch && lngMatch) setTimeout(() => calculateCourse(true), 800);
}

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat:26.3318,lng:127.9179 }, zoom:14, gestureHandling: 'greedy', disableDefaultUI: true, zoomControl: true });
  checkUrlParams();
}

function movePoint(lat,lng,dist,bearing){
  const R=6378137, brng=(bearing%360)*Math.PI/180;
  const φ1=lat*Math.PI/180, λ1=lng*Math.PI/180, δ=dist/R;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(brng));
  const λ2=λ1+Math.atan2(Math.sin(brng)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return {lat: φ2*180/Math.PI, lng: λ2*180/Math.PI};
}

function getPointsStructure(baseA, wind, dist, theta, course, isPort) {
  let p = {A: baseA};
  const isS = (course==='sausage'), isJW = (course==='jwsa'), isJW2 = (course==='jwsa2'), isF8 = (course==='figure8');
  
  if(isS){
    const bS = wind + (isPort?90+theta:270-theta);
    p.S = movePoint(p.A.lat, p.A.lng, dist, bS);
    const mid = {lat:(p.A.lat+p.S.lat)/2, lng:(p.A.lng+p.S.lng)/2};
    p.B = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('upDist').value)||0, wind);
    p.C = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('downDist').value)||0, wind);
  } else if(isJW){
    const dAB=parseFloat(document.getElementById('distAB').value)||0, dBC=parseFloat(document.getElementById('distBC').value)||0, dCD=parseFloat(document.getElementById('distCD').value)||0, th2=parseFloat(document.getElementById('theta2').value)||0;
    p.B = movePoint(p.A.lat, p.A.lng, dAB, isPort?wind+theta+90:wind-theta+270);
    p.C = movePoint(p.B.lat, p.B.lng, dBC, wind);
    p.D = movePoint(p.C.lat, p.C.lng, dCD, isPort?wind+270-th2:wind+90+th2);
  } else if(isJW2){
    // ★JWSA2 v6.2.2 新ロジック
    const dAB=parseFloat(document.getElementById('distAB2').value)||0, 
          dBC=parseFloat(document.getElementById('distBC2').value)||0, 
          dCD=parseFloat(document.getElementById('distCD2').value)||0,
          dDE=parseFloat(document.getElementById('distDE').value)||0,
          th2=parseFloat(document.getElementById('theta2_2').value)||0, 
          th3=parseFloat(document.getElementById('theta3').value)||0;
    
    // B点: A点から距離AB (JWSA1と同じ)
    p.B = movePoint(p.A.lat, p.A.lng, dAB, isPort?wind+theta+90:wind-theta+270);
    
    // C点: B点から (スタボー:風向+270+θ3 / ポート:風向+90-θ3) 距離BC
    const brngC = isPort ? (wind + 270 + th3) : (wind + 90 - th3);
    p.C = movePoint(p.B.lat, p.B.lng, dBC, brngC);
    
    // D点: C点から 風向へ 距離CD
    p.D = movePoint(p.C.lat, p.C.lng, dCD, wind); 
    
    // E点: D点から (スタボー:風向+90+θ2 / ポート:風向+270-θ2) 距離DE
    const brngE = isPort ? (wind + 270 - th2) : (wind + 90 + th2);
    p.E = movePoint(p.D.lat, p.D.lng, dDE, brngE);
  } else {
    p.B = movePoint(p.A.lat, p.A.lng, dist, isPort?wind+90+theta:wind+270-theta);
    if(isF8){
      p.C = movePoint(p.B.lat, p.B.lng, dist*Math.cos(theta*Math.PI/180), isPort?wind+270:wind+90);
      p.E = movePoint(p.B.lat, p.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
    } else {
      p.C = movePoint(p.B.lat, p.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
      p.D = movePoint(p.C.lat, p.C.lng, dist, isPort?wind+90+theta:wind+270-theta);
      p.E = movePoint(p.D.lat, p.D.lng, dist, isPort?wind+270-theta:wind+90+theta);
    }
  }
  return p;
}

function setBasePosition(pos) {
  const baseLabel = document.getElementById('basePointSelect').value;
  const wind=parseFloat(document.getElementById('wind').value)||0, dist=parseFloat(document.getElementById('dist').value)||0, theta=parseFloat(document.getElementById('theta').value)||0, course=document.getElementById('courseSelect').value;
  const tempStructure = getPointsStructure({lat:0,lng:0}, wind, dist, theta, course, currentIsPort);
  const targetRel = tempStructure[baseLabel];
  if(!targetRel) { updateAPos(pos.lat, pos.lng); } 
  else {
    const R=6378137, dy=targetRel.lat*(Math.PI/180)*R, dx=targetRel.lng*(Math.PI/180)*R;
    const d=Math.sqrt(dx*dx+dy*dy), brng=(Math.atan2(dx,dy)*180/Math.PI+360)%360;
    const realA = movePoint(pos.lat, pos.lng, d, (brng+180)%360);
    updateAPos(realA.lat, realA.lng);
  }
  calculateCourse(currentIsPort);
}

function updateAPos(lat, lng) {
  document.getElementById('latA').value = lat.toFixed(6);
  document.getElementById('lngA').value = lng.toFixed(6);
  document.getElementById('latA_disp').textContent = lat.toFixed(6);
  document.getElementById('lngA_disp').textContent = lng.toFixed(6);
}

function calculateCourse(isPort){
  currentIsPort = isPort;
  const latA=parseFloat(document.getElementById('latA').value), lngA=parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA)||isNaN(lngA)) return;
  const wind=parseFloat(document.getElementById('wind').value)||0, dist=parseFloat(document.getElementById('dist').value)||0, theta=parseFloat(document.getElementById('theta').value)||0, course=document.getElementById('courseSelect').value;
  polylines.forEach(p => p.setMap(null)); polylines = [];
  Object.keys(points).forEach(k => { if(circles[k])circles[k].setMap(null); if(markersLabel[k])markersLabel[k].setMap(null); points[k]=null; });
  points = getPointsStructure({lat:latA, lng:lngA}, wind, dist, theta, course, isPort);
  
  const isS=(course==='sausage'), isJW=(course==='jwsa'), isJW2=(course==='jwsa2'), isF8=(course==='figure8');
  document.getElementById('btnS').style.display=isS?'flex':'none'; 
  document.getElementById('btnD').style.display=isS?'none':'flex'; 
  document.getElementById('btnE').style.display=(isS||isJW)?'none':'flex';
  
  let path = [];
  if(isS){
    polylines.push(new google.maps.Polyline({path:[points.A, points.S], strokeColor:'#f00', strokeWeight:3, map}));
    path = [points.A, points.B, points.C, points.B, points.C, points.A];
  } else if(isJW){
    path = [points.A, points.B, points.C, points.D, points.B, points.A];
  } else if(isJW2){
    path = [points.A, points.B, points.C, points.D, points.E, points.B, points.A];
  } else {
    path = [points.A, points.B, points.C, points.D, points.E].filter(v => v);
  }
  
  polylines.push(new google.maps.Polyline({path:path, strokeColor:'#444', strokeWeight:2, map}));
  Object.keys(points).forEach(k => { if(points[k]) drawPoint(k, points[k], COLORS[k]); });
  if(map) map.panTo(points.A);
  
  document.getElementById('dAC').textContent = 'A～C：' + distanceBetween(points.A, points.C).toFixed(1) + ' m';
  document.getElementById('dAE').textContent = 'A～E：' + (points.E ? distanceBetween(points.A, points.E).toFixed(1) : '-') + ' m';
}

function drawPoint(label,pos,color){
  circles[label] = new google.maps.Circle({ map, center:pos, radius:(label==='A'?16:12), strokeColor:color, strokeOpacity:1, strokeWeight:2, fillColor:color, fillOpacity:0.8 });
  const fontColor = (label==='C') ? '#000' : '#fff';
  markersLabel[label] = new google.maps.Marker({ position:pos, map, icon:{path:google.maps.SymbolPath.CIRCLE, scale:0}, label:{text:label, color:fontColor, fontWeight:"bold", fontSize:"14px"} });
}

function distanceBetween(p1,p2){
  if(!p1||!p2) return 0;
  const R=6378137, dφ=(p2.lat-p1.lat)*Math.PI/180, dλ=(p2.lng-p1.lng)*Math.PI/180;
  const a=Math.sin(dφ/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dλ/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function shareCoords(l,p){
  if(!p) return;
  const t=`${l}点\n${p.lat.toFixed(6)},${p.lng.toFixed(6)}\nhttp://maps.google.com/?q=${p.lat},${p.lng}`;
  if(navigator.share) navigator.share({text:t}); else alert(t);
}

window.addEventListener('load', ()=>{
  checkUrlParams();
  document.getElementById('btnStarboard').onclick=()=>calculateCourse(false);
  document.getElementById('btnPort').onclick=()=>calculateCourse(true);
  document.getElementById('btnShareAll').onclick = ()=>{
    let t = "【コース座標】\n"; Object.keys(points).forEach(k => { if(points[k]) t += `${k}: ${points[k].lat.toFixed(6)},${points[k].lng.toFixed(6)}\n`; });
    if(navigator.share) navigator.share({text:t}); else alert(t);
  };
  document.getElementById('btnSetCurrent').onclick = ()=>{
    navigator.geolocation.getCurrentPosition(p=>{ setBasePosition({lat:p.coords.latitude, lng:p.coords.longitude}); }, e=>alert("取得失敗"));
  };
  ['A','B','C','D','E','S'].forEach(l=>{ document.getElementById('btn'+l).onclick=()=>shareCoords(l,points[l]); });
  document.getElementById('courseSelect').onchange=(e)=>{
    const v=e.target.value;
    document.getElementById('sausageSettings').style.display = (v === 'sausage') ? 'flex' : 'none';
    document.getElementById('jwsaSettings').style.display = (v === 'jwsa') ? 'flex' : 'none';
    document.getElementById('jwsa2Settings').style.display = (v === 'jwsa2') ? 'flex' : 'none';
    if (v === 'sausage') document.getElementById('dist').value = 100;
  };
});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>
</body>
</html>
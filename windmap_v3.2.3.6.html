<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>コース作成ツール by Popolo (v3.2.6)</title>
<style>
:root{
  --blue:#1976d2;
  --purple:#6a1b9a;
  --red:#d32f2f;
  --green:#2e7d32;
  --orange:#f57c00;
}
body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif; margin: 10px; color:#222; }
h2 { margin: 0 0 8px 0; font-size:18px; }
#version { position: absolute; right: 12px; top: 12px; color: #666; font-size: 13px; }
#inputs { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom:8px; }
#inputs label { font-size: 14px; }
input[type="number"] { width: 70px; padding: 6px 6px; border-radius:6px; border:1px solid #ccc; }
button { padding: 6px 10px; border-radius:6px; border: none; color:white; cursor:pointer; }
button.gray { background:#888; }
#map { width:100%; height:500px; border-radius:8px; margin-top:10px; box-shadow:0 1px 2px rgba(0,0,0,.08); }
#distances { margin-bottom:8px; font-weight:600; display:flex; gap:8px; flex-wrap:wrap; }
.pointBox { border-radius:50%; width:32px; height:32px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; margin-right:6px; margin-bottom:6px; }
#coordsContainer { display:flex; flex-wrap:wrap; align-items:center; gap:6px; }
.distanceBox { background:#eee; padding:4px 6px; border-radius:6px; margin-bottom:4px; font-weight:bold; }
#inputsMode { margin-bottom:5px; font-size:14px; color:#333; }
/* button colors */
#calcBtn { background: var(--blue); }
#btnWindSet { background: var(--purple); }
#btnSetCurrent { background: var(--red); }
#btnStarboard { background: var(--green); }
#btnPort { background: var(--orange); }
#btnSend { background: #555; }
/* modal */
.overlay {
  position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background: rgba(0,0,0,0.50); z-index: 2000;
}
.modal {
  background: #fff; padding:16px; border-radius:10px; width:92%; max-width:380px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25); text-align:center;
}
.modal h3 { margin: 0 0 8px 0; font-size:16px; }
.modal p { margin: 6px 0 12px 0; color:#333; font-size:14px; }
.modal .reading { font-size:20px; font-weight:700; color:#111; margin-bottom:12px; }
.modal .buttons { display:flex; gap:8px; justify-content:center; }
.modal button { padding:8px 12px; border-radius:8px; font-weight:600; }
.modal .btnConfirm { background: var(--purple); color:white; }
.modal .btnCancel { background: #ccc; color:#111; }
/* small instruction text */
.note { font-size:13px; color:#666; margin-top:6px; }
@media (max-width:600px){
  input[type="number"]{ width: 90px; }
  #map { height:420px; }
}
</style>
</head>
<body>
<h2>コース作成ツール by Popolo <small style="font-weight:normal;color:#666">(v3.2.6)</small></h2>
<div id="version">v3.2.6</div>

<div id="inputs">
  <label>緯度A：<input type="number" id="latA" step="any" value=""></label>
  <label>経度A：<input type="number" id="lngA" step="any" value=""></label>
  <label>風向(°)：<input type="number" id="wind" step="any" value=""></label>
  <label>距離(m)：<input type="number" id="dist" step="any" value="500"></label>
  <label>角度(°)：<input type="number" id="theta" step="any" value="5"></label>

  <button id="btnWindSet">風向をセット</button>
  <button id="calcBtn">計算</button>
  <button id="btnSetCurrent">現在位置をA点に</button>
  <button id="btnStarboard" title="スタボー">スタボー</button>
  <button id="btnPort" title="ポート">ポート</button>
  <button id="btnSend">送る</button>
</div>

<div id="inputsMode">
  A点設定方法：
  <label><input type="radio" name="aMode" value="current" checked> 現在位置</label>
  <label><input type="radio" name="aMode" value="map"> マップ</label>
  <label><input type="radio" name="aMode" value="manual"> 手入力</label>
</div>

<div id="distances">
  <div class="distanceBox" id="dAC">A～C距離：- m</div>
  <div class="distanceBox" id="dAE">A～E距離：- m</div>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:#ff3b30;">A</div>
  <div class="pointBox" id="btnB" style="background:#0088ff;">B</div>
  <div class="pointBox" id="btnC" style="background:#00aa00;">C</div>
  <div class="pointBox" id="btnD" style="background:#ffaa00;">D</div>
  <div class="pointBox" id="btnE" style="background:#9900ff;">E</div>
</div>

<div id="map"></div>

<!-- 風向モーダル -->
<div id="windModal" style="display:none;">
  <div class="overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>風向をセット</h3>
      <p id="modalInstruction">端末を風向に向けて少し待ってください。</p>
      <div class="reading" id="headingRead">--°</div>
      <div class="buttons">
        <button class="btnConfirm" id="modalSetBtn">設定</button>
        <button class="btnCancel" id="modalCloseBtn">閉じる</button>
      </div>
      <div class="note" id="modalNote">端末の方位取得に許可が必要な場合があります。</div>
    </div>
  </div>
</div>

<script>
let map;
let circles = {};
let markersLabel = {};
let polyline = null;
let points = { A:null, B:null, C:null, D:null, E:null };

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat:26.3318, lng:127.9179 }, zoom:14 });
  map.addListener('click', (e) => {
    const mode = document.querySelector('input[name="aMode"]:checked').value;
    if(mode === 'map'){
      const lat = e.latLng.lat(), lng = e.latLng.lng();
      document.getElementById('latA').value = lat.toFixed(6);
      document.getElementById('lngA').value = lng.toFixed(6);
      updatePointA({ lat, lng });
      calculatePort();
    }
  });
}

function movePoint(lat, lng, distance, bearingDeg){
  const R = 6378137.0;
  const brng = bearingDeg * Math.PI / 180.0;
  const φ1 = lat * Math.PI / 180.0;
  const λ1 = lng * Math.PI / 180.0;
  const δ = distance / R;
  const φ2 = Math.asin(Math.sin(φ1)*Math.cos(δ) + Math.cos(φ1)*Math.sin(δ)*Math.cos(brng));
  const λ2 = λ1 + Math.atan2(Math.sin(brng)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return { lat: φ2 * 180.0 / Math.PI, lng: λ2 * 180.0 / Math.PI };
}

function drawPoint(label, pos, color, radius=12){
  if(!pos) return;
  if(circles[label]) circles[label].setMap(null);
  if(markersLabel[label]) markersLabel[label].setMap(null);
  const actualRadius = (label === 'A') ? radius + 4 : radius;
  circles[label] = new google.maps.Circle({
    strokeColor: color, strokeOpacity:1, strokeWeight:2, fillColor: color, fillOpacity:0.85,
    map, center: pos, radius: actualRadius
  });
  markersLabel[label] = new google.maps.Marker({
    position: pos, map,
    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
    label: { text: label, color:"white", fontWeight:"bold", fontSize:"14px" }
  });
  circles[label].addListener('click', ()=> shareCoords(label, pos));
  markersLabel[label].addListener('click', ()=> shareCoords(label, pos));
}

function shareCoords(label, pos){
  if(!pos){ alert(label + ' 点は未設定です'); return; }
  const lat = pos.lat.toFixed(6)+'N';
  const lng = pos.lng.toFixed(6)+'E';
  const text = `${label}点\n${lat}\n${lng}`;
  if(navigator.share){
    try { navigator.share({ title:`${label} 座標`, text }); return; } catch(e){ }
  }
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>alert('座標をコピーしました'), ()=>alert(text));
    return;
  }
  const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  alert('座標をコピーしました');
}

function updatePointA(pos){
  points.A = pos;
  drawPoint('A', pos, '#ff3b30');
  map.panTo(pos);
}

function setCurrentPositionA(){
  if(!navigator.geolocation){ alert("現在位置が取得できません"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    document.getElementById('latA').value = lat.toFixed(6);
    document.getElementById('lngA').value = lng.toFixed(6);
    updatePointA({ lat, lng });
    calculatePort();
  }, err=>{ alert("位置情報取得に失敗しました"); });
}

function distanceBetween(p1, p2){
  if(!p1||!p2) return 0;
  const R=6378137.0;
  const φ1=p1.lat*Math.PI/180;
  const φ2=p2.lat*Math.PI/180;
  const dφ=(p2.lat-p1.lat)*Math.PI/180;
  const dλ=(p2.lng-p1.lng)*Math.PI/180;
  const a=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

// 計算共通関数（スタボー・ポートも共通化）
function calculatePort(starboard=false){
  const latA=parseFloat(document.getElementById('latA').value);
  const lngA=parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA)||isNaN(lngA)){ alert("A点が未設定です"); return; }
  const wind=parseFloat(document.getElementById('wind').value)||0;
  const dist=parseFloat(document.getElementById('dist').value)||0;
  const theta=parseFloat(document.getElementById('theta').value)||0;

  points.A={lat:latA,lng:lngA};
  const angle = starboard ? theta : -theta;

  points.B=movePoint(points.A.lat, points.A.lng, dist, 90+wind+angle);
  points.C=movePoint(points.B.lat, points.B.lng, dist, 270+wind-angle);
  points.D=movePoint(points.C.lat, points.C.lng, dist, 90+wind+angle);
  points.E=movePoint(points.D.lat, points.D.lng, dist, 270+wind-angle);

  drawPoint('A', points.A, '#ff3b30');
  drawPoint('B', points.B, '#0088ff');
  drawPoint('C', points.C, '#00aa00');
  drawPoint('D', points.D, '#ffaa00');
  drawPoint('E', points.E, '#9900ff');

  if(polyline) polyline.setMap(null);
  polyline=new google.maps.Polyline({ path:[points.A,points.B,points.C,points.D,points.E], geodesic:true, strokeColor:'#444', strokeOpacity:0.9, strokeWeight:2, map });

  document.getElementById('dAC').textContent='A～C距離：'+distanceBetween(points.A,points.C).toFixed(1)+' m';
  document.getElementById('dAE').textContent='A～E距離：'+distanceBetween(points.A,points.E).toFixed(1)+' m';
}

// 送信ボタン
document.getElementById('btnSend').addEventListener('click', ()=>{
  let text='';
  ['A','B','C','D','E'].forEach(l=>{
    const p=points[l];
    if(!p) return;
    const lat=p.lat.toFixed(6)+'N';
    const lng=p.lng.toFixed(6)+'E';
    text+=`${l}点\n${lat}\n${lng}\n\n`;
  });
  const wind=document.getElementById('wind').value||0;
  const theta=document.getElementById('theta').value||0;
  const totalDist=distanceBetween(points.A,points.B)+distanceBetween(points.B,points.C)+distanceBetween(points.C,points.D)+distanceBetween(points.D,points.E);
  text+=`風向(°)：${wind}\nθ(°)：${theta}\n総距離(m)：${totalDist.toFixed(1)}`;
  if(navigator.share){
    navigator.share({ title:'コース情報', text }).catch(()=>alert(text));
  } else if(navigator.clipboard){
    navigator.clipboard.writeText(text).then(()=>alert('情報をコピーしました'),()=>alert(text));
  } else { alert(text); }
});

// A～E 丸ボタンで共有
['A','B','C','D','E'].forEach(l=>{
  document.getElementById('btn'+l).addEventListener('click', ()=>{
    const p=points[l];
    if(!p){ alert(l+' 点は未設定です'); return; }
    shareCoords(l,p);
  });
});

// 風向モーダル
function windModalOpen(){
  const modal=document.getElementById('windModal');
  modal.style.display='block';
  const headingRead=document.getElementById('headingRead');

  function handleOrientation(event){
    let heading = event.webkitCompassHeading || event.alpha;
    if(heading === null) heading=0;
    headingRead.textContent=Math.round(heading)+'°';
  }

  if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function'){
    DeviceOrientationEvent.requestPermission().then(res=>{
      if(res==='granted') window.addEventListener('deviceorientation', handleOrientation);
    }).catch(console.log);
  } else {
    window.addEventListener('deviceorientation', handleOrientation);
  }

  document.getElementById('modalSetBtn').onclick=()=>{
    document.getElementById('wind').value=parseFloat(headingRead.textContent)||0;
    windModalClose();
    calculatePort();
  };
  document.getElementById('modalCloseBtn').onclick=windModalClose;
}

function windModalClose(){
  const modal=document.getElementById('windModal');
  modal.style.display='none';
  window.removeEventListener('deviceorientation', ()=>{});
}

// ボタンイベント
window.addEventListener('load', ()=>{
  document.getElementById('calcBtn').addEventListener('click', ()=>calculatePort());
  document.getElementById('btnWindSet').addEventListener('click', windModalOpen);
  document.getElementById('btnSetCurrent').addEventListener('click', setCurrentPositionA);
  document.getElementById('btnStarboard').addEventListener('click', ()=>calculatePort(true));
  document.getElementById('btnPort').addEventListener('click', ()=>calculatePort(false));
});

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4tqxDKadoSP8XTNwzOGXwh9BprCiR9Zs&callback=initMap"></script>
</body>
</html>

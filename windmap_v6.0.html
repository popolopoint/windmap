<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>コース作るくん v6.0 (基準点選択モデル)</title>
<style>
:root{ --red:#ff3b30; --blue:#0000ff; --yellow:#ffff00; --green:#00aa00; --purple:#9900ff; --pink:#ff00ff; --teal:#00ffff; }
body { font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN","メイリオ",Meiryo,sans-serif; margin:10px; color:#222; }
h2 { margin:0 0 8px 0; font-size:18px; }
#version { position:absolute; right:12px; top:12px; color:#666; font-size:13px; }

/* 入力エリア */
#inputs { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
#inputs label { font-size:14px; }
#latA, #lngA { font-size: 14px; padding: 6px; width: 85px; border-radius:6px; border:1px solid #ccc; background:#f9f9f9; }
#wind, #dist, #theta, .jwsa-input, #upDist, #downDist { font-size: 28px; padding: 10px; width: 120px; border-radius:6px; border:1px solid #ccc; }

/* ボタン */
button { font-size: 20px; padding: 10px 16px; border-radius:6px; border:none; color:white; cursor:pointer; font-weight:bold; }
#calcBtn { background: #1976d2; }
#btnWindSet { background: #6a1b9a; }
#btnSetCurrent { background: var(--red); }
#btnStarboard { background: var(--green); }
#btnPort { background: #f57c00; }
#btnShareAll { background:#555; }

#courseSelect, #basePointSelect { font-size: 24px; padding: 8px 12px; border-radius:6px; border:1px solid #ccc; }
#inputsMode { margin:10px 0; padding:10px; background:#f0f7ff; border-radius:8px; font-size: 18px; color:#333; border:1px solid #d0e0f0; }
#inputsMode input[type="radio"] { transform: scale(1.5); margin: 0 8px 0 15px; }

/* マップ */
#map { width:100%; height:500px; border-radius:8px; margin-top:10px; box-shadow:0 1px 4px rgba(0,0,0,0.2); }

/* 結果表示 */
#distances { margin-bottom:8px; display:flex; gap:8px; flex-wrap:wrap; }
.distanceBox { background:#eee; padding:8px 12px; border-radius:6px; font-weight:bold; font-size: 1.2em; border: 1px solid #ddd; }

/* 地点ボタン */
#coordsContainer { display:flex; flex-wrap:wrap; align-items:center; gap:6px; margin-top:10px; }
.pointBox { border-radius:50%; width:50px; height:50px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; font-size: 1.2em; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

#sausageSettings, #jwsaSettings { display:none; align-items:center; gap:8px; }

/* コンパスモーダル */
.overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); z-index:2000;}
.modal{background:#fff; padding:20px; border-radius:12px; width:90%; max-width:350px; text-align:center;}
.modal .reading{font-size:48px; font-weight:bold; margin: 20px 0; color:#111;}

@media (max-width:600px){ #map { height: 400px; } }
</style>
</head>
<body>

<h2>コース作るくん <span style="font-size:0.7em;">v6.0 (基準点選択対応)</span></h2>
<div id="version">v6.0</div>

<div id="inputs">
  <label>風向(°)：<input type="number" id="wind" step="any" placeholder="0"></label>
  <label id="distLabel">距離(m)：<input type="number" id="dist" value="500"></label>
  <label id="thetaLabel">角度(°)：<input type="number" id="theta" value="5"></label>
  
  <label>コース：
    <select id="courseSelect">
      <option value="mcourse">Ｍコース</option>
      <option value="figure8">フィギア８</option>
      <option value="sausage">ソーセージ</option>
      <option value="5jibe">５ジャイブ</option>
      <option value="jwsa">JWSAアップ</option>
    </select>
  </label>

  <div id="sausageSettings">
    <label>上(m)：<input type="number" id="upDist" value="1000"></label>
    <label>下(m)：<input type="number" id="downDist" value="50"></label>
  </div>
  <div id="jwsaSettings">
    <label>AB(m)：<input type="number" id="distAB" class="jwsa-input" value="500"></label>
    <label>BC(m)：<input type="number" id="distBC" class="jwsa-input" value="500"></label>
    <label>CD(m)：<input type="number" id="distCD" class="jwsa-input" value="500"></label>
    <label>CD角度：<input type="number" id="theta2" class="jwsa-input" value="5"></label>
  </div>

  <button id="btnWindSet">風向セット</button>
  <button id="btnStarboard">スタボー(右)</button>
  <button id="btnPort">ポート(左)</button>
  <button id="btnShareAll">データ送信</button>
</div>

<div id="inputsMode">
  <strong>基準点設定：</strong>
  現在地またはマップクリックを 
  <select id="basePointSelect">
    <option value="A">A点</option>
    <option value="B">B点</option>
    <option value="C">C点</option>
    <option value="D">D点</option>
    <option value="E">E点</option>
    <option value="F">F点</option>
    <option value="G">G点</option>
    <option value="S">S点</option>
  </select>
  にする
  <br>
  <label><input type="radio" name="aMode" value="current" checked> 現在地優先</label>
  <label><input type="radio" name="aMode" value="map"> マップクリック優先</label>
  <button id="btnSetCurrent" style="font-size:14px; padding:5px 10px; margin-left:15px;">今すぐ反映</button>
</div>

<div style="font-size:12px; color:#666; margin-bottom:5px;">
  算出されたA点：<input type="text" id="latA" readonly> , <input type="text" id="lngA" readonly>
</div>

<div id="distances">
  <div class="distanceBox" id="dAC">A～C：- m</div>
  <div class="distanceBox" id="dAE">A～E：- m</div>
  <div class="distanceBox" id="dAG" style="display:none;">A～G：- m</div>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:var(--red);">A</div>
  <div class="pointBox" id="btnB" style="background:var(--blue);">B</div>
  <div class="pointBox" id="btnC" style="background:var(--yellow); color:#000; text-shadow:none;">C</div>
  <div class="pointBox" id="btnD" style="background:var(--green);">D</div>
  <div class="pointBox" id="btnE" style="background:var(--purple);">E</div>
  <div class="pointBox" id="btnF" style="background:var(--pink); display:none;">F</div>
  <div class="pointBox" id="btnG" style="background:var(--teal); color:#000; text-shadow:none; display:none;">G</div>
  <div class="pointBox" id="btnS" style="background:var(--blue); display:none;">S</div>
</div>

<div id="map"></div>

<div id="windModal" style="display:none;">
  <div class="overlay"><div class="modal">
    <h3>風上に向けて設定</h3>
    <div class="reading" id="headingRead">--°</div>
    <button id="modalSetBtn" style="background:var(--purple); width:100%; margin-bottom:10px;">この向きで決定</button>
    <button id="modalCloseBtn" style="background:#ccc; color:#000; width:100%;">閉じる</button>
  </div></div>
</div>

<script>
let map, circles={}, markersLabel={}, polylines=[];
let points = {A:null,B:null,C:null,D:null,E:null,F:null,G:null,S:null};
const COLORS = { A:'#ff3b30', B:'#0000ff', C:'#ffff00', D:'#00aa00', E:'#9900ff', F:'#ff00ff', G:'#00ffff', S:'#0000ff' };
let currentIsPort = true;

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat:26.3318,lng:127.9179 }, zoom:14 });

  map.addListener('click', (e)=>{
    if(document.querySelector('input[name="aMode"]:checked').value==='map'){
      setBasePosition({lat:e.latLng.lat(), lng:e.latLng.lng()});
    }
  });
}

// 汎用的な点移動計算
function movePoint(lat,lng,dist,bearing){
  const R=6378137, brng=(bearing%360)*Math.PI/180;
  const φ1=lat*Math.PI/180, λ1=lng*Math.PI/180, δ=dist/R;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(brng));
  const λ2=λ1+Math.atan2(Math.sin(brng)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return {lat: φ2*180/Math.PI, lng: λ2*180/Math.PI};
}

// A点を基準に全座標をシミュレーション計算する内部関数
function getPointsStructure(baseA, wind, dist, theta, course, isPort) {
  let p = {A: baseA};
  const isSausage = (course==='sausage'), is5J = (course==='5jibe'), isJW = (course==='jwsa'), isF8 = (course==='figure8');

  if(isSausage){
    const bS = wind + (isPort?90+theta:270-theta);
    p.S = movePoint(p.A.lat, p.A.lng, dist, bS);
    const mid = {lat:(p.A.lat+p.S.lat)/2, lng:(p.A.lng+p.S.lng)/2};
    p.B = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('upDist').value)||0, wind);
    p.C = movePoint(mid.lat, mid.lng, parseFloat(document.getElementById('downDist').value)||0, (wind+180)%360);
  } else if(isJW){
    const dAB=parseFloat(document.getElementById('distAB').value)||0, dBC=parseFloat(document.getElementById('distBC').value)||0, dCD=parseFloat(document.getElementById('distCD').value)||0, th2=parseFloat(document.getElementById('theta2').value)||0;
    p.B = movePoint(p.A.lat, p.A.lng, dAB, isPort?wind+theta+90:wind-theta+270);
    p.C = movePoint(p.B.lat, p.B.lng, dBC, wind);
    p.D = movePoint(p.C.lat, p.C.lng, dCD, isPort?wind+270-th2:wind+90+th2);
  } else {
    p.B = movePoint(p.A.lat, p.A.lng, dist, isPort?wind+90+theta:wind+270-theta);
    if(isF8){
      p.C = movePoint(p.B.lat, p.B.lng, dist*Math.cos(theta*Math.PI/180), isPort?wind+270:wind+90);
      p.E = movePoint(p.B.lat, p.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
    } else {
      p.C = movePoint(p.B.lat, p.B.lng, dist, isPort?wind+270-theta:wind+90+theta);
      p.D = movePoint(p.C.lat, p.C.lng, dist, isPort?wind+90+theta:wind+270-theta);
      p.E = movePoint(p.D.lat, p.D.lng, dist, isPort?wind+270-theta:wind+90+theta);
      if(is5J){ 
        p.F=movePoint(p.E.lat,p.E.lng,dist,isPort?wind+90+theta:wind+270-theta); 
        p.G=movePoint(p.F.lat,p.F.lng,dist,isPort?wind+270-theta:wind+90+theta); 
      }
    }
  }
  return p;
}

// 入力された点からA点を逆算して反映
function setBasePosition(pos) {
  const baseLabel = document.getElementById('basePointSelect').value;
  const wind=parseFloat(document.getElementById('wind').value)||0;
  const dist=parseFloat(document.getElementById('dist').value)||0;
  const theta=parseFloat(document.getElementById('theta').value)||0;
  const course=document.getElementById('courseSelect').value;

  // 1. 仮のA点(0,0)から、指定された点がどこに位置するか計算
  const tempA = {lat: 0, lng: 0};
  const tempStructure = getPointsStructure(tempA, wind, dist, theta, course, currentIsPort);
  const targetRel = tempStructure[baseLabel];

  if(!targetRel) { // 存在しない点を選んでいる場合
    document.getElementById('latA').value = pos.lat.toFixed(6);
    document.getElementById('lngA').value = pos.lng.toFixed(6);
  } else {
    // 2. A点からターゲット点への「距離」と「方位」を計算
    const R=6378137;
    const dy = targetRel.lat * (Math.PI/180) * R;
    const dx = targetRel.lng * (Math.PI/180) * R * Math.cos(0);
    const d = Math.sqrt(dx*dx + dy*dy);
    const brng = (Math.atan2(dx, dy) * 180 / Math.PI + 360) % 360;

    // 3. 入力された座標(pos)から逆向きに移動して、真のA点を算出
    const realA = movePoint(pos.lat, pos.lng, d, (brng + 180) % 360);
    document.getElementById('latA').value = realA.lat.toFixed(6);
    document.getElementById('lngA').value = realA.lng.toFixed(6);
  }
  
  calculateCourse(currentIsPort);
}

function calculateCourse(isPort){
  currentIsPort = isPort;
  const latA=parseFloat(document.getElementById('latA').value), lngA=parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA)||isNaN(lngA)) return;
  
  const wind=parseFloat(document.getElementById('wind').value)||0, dist=parseFloat(document.getElementById('dist').value)||0;
  const theta=parseFloat(document.getElementById('theta').value)||0, course=document.getElementById('courseSelect').value;

  // 描画クリア
  polylines.forEach(p => p.setMap(null)); polylines = [];
  Object.keys(points).forEach(k => { if(circles[k])circles[k].setMap(null); if(markersLabel[k])markersLabel[k].setMap(null); points[k]=null; });

  // 座標算出
  points = getPointsStructure({lat:latA, lng:lngA}, wind, dist, theta, course, isPort);

  // 表示制御
  const isSausage = (course==='sausage'), is5J = (course==='5jibe'), isJW = (course==='jwsa'), isF8 = (course==='figure8');
  document.getElementById('btnS').style.display = isSausage ? 'flex' : 'none';
  document.getElementById('btnD').style.display = (isSausage || isF8) ? 'none' : 'flex';
  document.getElementById('btnE').style.display = (isSausage || isJW) ? 'none' : 'flex';
  document.getElementById('btnF').style.display = is5J ? 'flex' : 'none';
  document.getElementById('btnG').style.display = is5J ? 'flex' : 'none';
  document.getElementById('dAG').style.display = is5J ? 'block' : 'none';

  // ポリライン描画
  let path = [];
  if(isSausage){
    polylines.push(new google.maps.Polyline({path:[points.A, points.S], strokeColor:'#f00', strokeWeight:3, map}));
    path = [points.A, points.B, points.C, points.B, points.C, points.A];
    document.getElementById('dAC').textContent=`A-S距離: ${dist}m`;
    document.getElementById('dAE').textContent=`B-C間隔: ${(parseFloat(document.getElementById('upDist').value)+parseFloat(document.getElementById('downDist').value)).toFixed(0)}m`;
  } else if(isJW){
    path = [points.A, points.B, points.C, points.D, points.B, points.A];
    document.getElementById('dAC').textContent=`AB:${document.getElementById('distAB').value}m / BC:${document.getElementById('distBC').value}m`;
    document.getElementById('dAE').textContent=`CD:${document.getElementById('distCD').value}m`;
  } else {
    path = [points.A, points.B, points.C, points.D, points.E].filter(v => v);
    if(is5J) path.push(points.F, points.G);
    document.getElementById('dAC').textContent = 'A～C：' + distanceBetween(points.A, points.C).toFixed(1) + ' m';
    document.getElementById('dAE').textContent = 'A～E：' + (points.E ? distanceBetween(points.A, points.E).toFixed(1) : '-') + ' m';
    if(is5J) document.getElementById('dAG').textContent = 'A～G：' + distanceBetween(points.A, points.G).toFixed(1) + ' m';
  }
  polylines.push(new google.maps.Polyline({path:path, strokeColor:'#444', strokeWeight:2, map}));

  // マーカー描画
  Object.keys(points).forEach(k => { if(points[k]) drawPoint(k, points[k], COLORS[k]); });
  map.panTo(points.A);
}

function drawPoint(label,pos,color){
  circles[label] = new google.maps.Circle({ map, center:pos, radius:(label==='A'?16:12), strokeColor:color, strokeOpacity:1, strokeWeight:2, fillColor:color, fillOpacity:0.8 });
  const fontColor = (label==='C' || label==='G') ? '#000' : '#fff';
  markersLabel[label] = new google.maps.Marker({ position:pos, map, icon:{path:google.maps.SymbolPath.CIRCLE, scale:0}, label:{text:label, color:fontColor, fontWeight:"bold", fontSize:"14px"} });
}

function distanceBetween(p1,p2){
  if(!p1 || !p2) return 0;
  const R=6378137, dφ=(p2.lat-p1.lat)*Math.PI/180, dλ=(p2.lng-p1.lng)*Math.PI/180;
  const a=Math.sin(dφ/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dλ/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function shareCoords(l,p){
  if(!p) return alert(l+"点が未設定です");
  const t=`${l}点\n${p.lat.toFixed(6)},${p.lng.toFixed(6)}\nhttps://www.google.com/maps?q=${p.lat},${p.lng}`;
  if(navigator.share) navigator.share({text:t}); else alert(t);
}

function shareAllCoords(){
  let t = "【コース座標】\n";
  Object.keys(points).forEach(k => {
    if(points[k]) t += `${k}: ${points[k].lat.toFixed(6)},${points[k].lng.toFixed(6)}\n`;
  });
  if(navigator.share) navigator.share({text:t}); else alert(t);
}

// コンパス関連
let headingSamples=[], headingWatcher=null;
const modalRoot=document.getElementById('windModal'), headingReadEl=document.getElementById('headingRead');
function openWindModal(){ headingSamples=[]; modalRoot.style.display='block'; startOrientationListening(); }
function closeWindModal(){ stopOrientationListening(); modalRoot.style.display='none'; }
function startOrientationListening(){
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(r=>{ if(r==='granted') addOrientationListener(); });
  }else addOrientationListener();
}
function addOrientationListener(){
  headingWatcher = (e)=>{
    let h = (e.webkitCompassHeading !== undefined) ? e.webkitCompassHeading : (360 - e.alpha);
    if(h) { headingSamples.push(h); if(headingSamples.length>30) headingSamples.shift();
      let x=0,y=0; headingSamples.forEach(d=>{ let r=d*Math.PI/180; x+=Math.cos(r); y+=Math.sin(r); });
      headingReadEl.textContent = Math.round((Math.atan2(y,x)*180/Math.PI + 360)%360) + '°'; }
  };
  window.addEventListener('deviceorientation', headingWatcher, true);
}
function stopOrientationListening(){ window.removeEventListener('deviceorientation', headingWatcher, true); }

window.addEventListener('load', ()=>{
  document.getElementById('btnWindSet').onclick = openWindModal;
  document.getElementById('modalSetBtn').onclick = () => { document.getElementById('wind').value = parseInt(headingReadEl.textContent); closeWindModal(); };
  document.getElementById('modalCloseBtn').onclick = closeWindModal;
  document.getElementById('btnStarboard').onclick=()=>calculateCourse(false);
  document.getElementById('btnPort').onclick=()=>calculateCourse(true);
  document.getElementById('btnShareAll').onclick = shareAllCoords;

  document.getElementById('btnSetCurrent').onclick = ()=>{
    navigator.geolocation.getCurrentPosition(p=>{
      setBasePosition({lat:p.coords.latitude, lng:p.coords.longitude});
    });
  };

  ['A','B','C','D','E','F','G','S'].forEach(l=>{
    document.getElementById('btn'+l).onclick=()=>shareCoords(l,points[l]);
  });

  document.getElementById('courseSelect').onchange=(e)=>{
    const v=e.target.value;
    document.getElementById('sausageSettings').style.display = (v === 'sausage') ? 'inline-flex' : 'none';
    document.getElementById('jwsaSettings').style.display = (v === 'jwsa') ? 'inline-flex' : 'none';
    document.getElementById('distLabel').style.display = (v === 'jwsa') ? 'none' : 'inline';
    document.getElementById('thetaLabel').style.display = (v === 'jwsa') ? 'none' : 'inline';
    
    // 基準点セレクトの選択肢を調整
    const bSel = document.getElementById('basePointSelect');
    Array.from(bSel.options).forEach(opt => {
        if(v==='sausage') opt.disabled = !['A','B','C','S'].includes(opt.value);
        else if(v==='jwsa') opt.disabled = !['A','B','C','D'].includes(opt.value);
        else if(v==='figure8') opt.disabled = !['A','B','C','E'].includes(opt.value);
        else if(v==='5jibe') opt.disabled = false;
        else opt.disabled = !['A','B','C','D','E'].includes(opt.value);
    });
  };
});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>
</body>
</html>
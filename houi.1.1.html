<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒãƒ›é¢¨å‘ãƒ»ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®æ¸¬å®š</title>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
        body { font-family: sans-serif; margin: 0; padding: 0; }
        #map { height: 400px; width: 100%; } /* åœ°å›³ã®ã‚µã‚¤ã‚º */
        #controls { padding: 15px; background-color: #f4f4f4; border-top: 1px solid #ccc; }
        .data-window { background-color: white; border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 5px; }
        button { padding: 10px 15px; margin-right: 10px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .result { font-size: 1.1em; font-weight: bold; color: #28a745; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="controls">
        <button id="getLocationButton">1. ç¾åœ¨åœ°Aã‚’å–å¾—</button>
        <button id="presetPowerPlantButton">å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€Bã‚’é¸æŠ</button>
        <button id="measureButton" disabled>3. Bæ–¹ä½ã‚’æ¸¬å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¹ä½œå‹•ï¼‰</button>
    </div>

    <div id="map"></div>

    <div class="data-window">
        <h3>ğŸ“ ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¦ã‚£ãƒ³ãƒ‰ã‚¦</h3>
        <p>
            **ç¾åœ¨åœ°A (ç·¯åº¦, çµŒåº¦):** <span id="currentLocation">æœªå–å¾—</span><br>
            **ç›®æ¨™åœ°ç‚¹B (ç·¯åº¦, çµŒåº¦):** <span id="targetLocation">æœªæŒ‡å®š (åœ°å›³ã‚¿ãƒƒãƒ—ã§æŒ‡å®šå¯)</span>
        </p>
        <hr>
        <p>
            **2. åœ°å›³ä¸Šã§ã®Aâ†’Bã®æ–¹ä½ (çœŸåŒ—):** <span id="trueBearing" class="result">---</span><br>
            **3. ã‚³ãƒ³ãƒ‘ã‚¹ãŒæ¤œçŸ¥ã—ãŸæ–¹ä½ (ç£åŒ—):** <span id="compassHeading" class="result">---</span>
        </p>
        <p class="result">
            **4. ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®è§’åº¦ (çœŸåŒ—ã¨ç£åŒ—ã®å·®):** <span id="errorAngle">---</span>
        </p>
    </div>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap">
    </script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map;
        let currentLocation = null; // ç¾åœ¨åœ°A (LatLngã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
        let targetLocation = null;  // ç›®æ¨™åœ°ç‚¹B (LatLngã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
        let markers = {};           // ãƒãƒ¼ã‚«ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†

        // ç›®æ¨™åœ°ç‚¹Bã®ãƒ—ãƒªã‚»ãƒƒãƒˆ
        // å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€ (ãŠã‚ˆãã®ç·¯åº¦çµŒåº¦)
        const PRESET_B_GUISHIKAWA = { lat: 26.3773, lng: 127.8765 }; 

        /**
         * Google Mapã®åˆæœŸåŒ–
         */
        function initMap() {
            // æ²–ç¸„æœ¬å³¶ã‚ãŸã‚Šã®ä¸­å¿ƒåº§æ¨™
            const initialCenter = { lat: 26.35, lng: 127.85 }; 
            map = new google.maps.Map(document.getElementById("map"), {
                center: initialCenter,
                zoom: 11,
            });

            // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ç›®æ¨™åœ°ç‚¹Bã‚’è¨­å®š
            map.addListener("click", (event) => {
                setTargetLocation(event.latLng);
            });

            // ãƒãƒ¼ã‚«ãƒ¼ã‚’åˆæœŸåŒ–
            markers.A = new google.maps.Marker({ map: map, label: 'A', title: 'ç¾åœ¨åœ° A' });
            markers.B = new google.maps.Marker({ map: map, label: 'B', title: 'ç›®æ¨™åœ°ç‚¹ B' });

            // ãƒãƒ¼ã‚«ãƒ¼ã¯æœ€åˆã¯éè¡¨ç¤º
            markers.A.setVisible(false);
            markers.B.setVisible(false);
        }

        /**
         * 1. ç¾åœ¨åœ°Aã‚’å–å¾—ã—ã€åœ°å›³ä¸Šã«è¡¨ç¤ºã™ã‚‹
         */
        document.getElementById('getLocationButton').addEventListener('click', () => {
            if ('geolocation' in navigator) {
                document.getElementById('currentLocation').textContent = "å–å¾—ä¸­...";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        const latLng = new google.maps.LatLng(currentLocation.lat, currentLocation.lng);
                        
                        // ãƒãƒ¼ã‚«ãƒ¼Aã‚’æ›´æ–°
                        markers.A.setPosition(latLng);
                        markers.A.setVisible(true);
                        map.setCenter(latLng);
                        map.setZoom(14); 

                        // ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ›´æ–°
                        document.getElementById('currentLocation').textContent = `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;

                        // ç›®æ¨™åœ°ç‚¹BãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ã€æ–¹ä½ã‚’è¨ˆç®—
                        if (targetLocation) {
                            calculateAndDisplayBearing();
                        }
                    },
                    (error) => {
                        document.getElementById('currentLocation').textContent = "å–å¾—å¤±æ•—: " + error.message;
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ï¼ˆGPSï¼‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            }
        });


        /**
         * 2. ç›®æ¨™åœ°ç‚¹Bã‚’è¨­å®šã—ã€åœ°å›³ä¸Šã«è¡¨ç¤ºã™ã‚‹
         * @param {google.maps.LatLng} latLng - ç›®æ¨™åœ°ç‚¹ã®ç·¯åº¦çµŒåº¦
         */
        function setTargetLocation(latLng) {
            targetLocation = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };

            // ãƒãƒ¼ã‚«ãƒ¼Bã‚’æ›´æ–°
            markers.B.setPosition(latLng);
            markers.B.setVisible(true);

            // ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ›´æ–°
            document.getElementById('targetLocation').textContent = `${targetLocation.lat.toFixed(6)}, ${targetLocation.lng.toFixed(6)}`;
            
            // ç¾åœ¨åœ°AãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ã€æ–¹ä½ã‚’è¨ˆç®—
            if (currentLocation) {
                calculateAndDisplayBearing();
                document.getElementById('measureButton').disabled = false;
            } else {
                 alert("å…ˆã«ã€Œ1. ç¾åœ¨åœ°Aã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
            }
        }

        /**
         * ãƒ—ãƒªã‚»ãƒƒãƒˆåœ°ç‚¹ï¼ˆå…·å¿—å·ç«åŠ›ç™ºé›»æ‰€ï¼‰ã‚’ç›®æ¨™åœ°ç‚¹Bã«è¨­å®š
         */
        document.getElementById('presetPowerPlantButton').addEventListener('click', () => {
            if (!currentLocation) {
                alert("å…ˆã«ã€Œ1. ç¾åœ¨åœ°Aã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            const latLng = new google.maps.LatLng(PRESET_B_GUISHIKAWA.lat, PRESET_B_GUISHIKAWA.lng);
            setTargetLocation(latLng);
        });


        /**
         * 2. åœ°å›³ä¸Šã§ã®Aã‹ã‚‰è¦‹ãŸBã®æ–¹ä½ã‚’è¨ˆç®—ã—è¡¨ç¤ºã™ã‚‹
         */
        function calculateAndDisplayBearing() {
            if (!currentLocation || !targetLocation) return;

            // åœ°å›³ä¸Šã®2ç‚¹é–“ã®æ–¹ä½ï¼ˆè§’åº¦ï¼‰ã‚’è¨ˆç®—ã™ã‚‹
            // google.maps.geometry.spherical.computeHeading ã¯ç·¯åº¦çµŒåº¦é–“ã®è§’åº¦ã‚’è¨ˆç®—ã—ã¾ã™
            // ãŸã ã—ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ Maps APIã® 'geometry' ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚
            // ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯æ‰‹å‹•ã§è¨ˆç®—ã—ã¾ã™ã€‚

            const R = 6371; // åœ°çƒã®åŠå¾„ (km)
            const lat1 = currentLocation.lat * (Math.PI / 180);
            const lon1 = currentLocation.lng * (Math.PI / 180);
            const lat2 = targetLocation.lat * (Math.PI / 180);
            const lon2 = targetLocation.lng * (Math.PI / 180);

            const dLon = lon2 - lon1;

            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

            let bearingRad = Math.atan2(y, x);
            // ãƒ©ã‚¸ã‚¢ãƒ³ã‚’è§’åº¦ã«å¤‰æ›ã—ã€0ã€œ360åº¦ã®ç¯„å›²ã«èª¿æ•´
            let trueBearing = (bearingRad * (180 / Math.PI) + 360) % 360; 

            document.getElementById('trueBearing').textContent = `${trueBearing.toFixed(2)} Â° (çœŸåŒ—)`;
            
            // èª¤å·®è¨ˆç®—ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚³ãƒ³ãƒ‘ã‚¹è¨ˆæ¸¬å‰ï¼‰
            document.getElementById('errorAngle').textContent = "---";
        }


        /**
         * 3. ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆDevice Orientation APIï¼‰ã‚’ä½œå‹•ã•ã›ã€æ–¹ä½ã‚’å–å¾—ã™ã‚‹
         */
        document.getElementById('measureButton').addEventListener('click', () => {
            if (!targetLocation) {
                alert("ç›®æ¨™åœ°ç‚¹Bã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // iOS 13ä»¥é™ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨±å¯ãŒå¿…è¦
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startCompassMeasurement();
                        } else {
                            alert('ã‚³ãƒ³ãƒ‘ã‚¹ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                        }
                    })
                    .catch(console.error);
            } else {
                // iOS 12ä»¥å‰ã‚„Androidã®å ´åˆ
                startCompassMeasurement();
            }
        });

        function startCompassMeasurement() {
            document.getElementById('compassHeading').textContent = "ã‚³ãƒ³ãƒ‘ã‚¹æ¸¬å®šä¸­...";

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œã™ã‚‹ãŸã‚ã«è¨­å®š
            const handleOrientation = (event) => {
                // alphaå€¤ï¼ˆZè»¸å‘¨ã‚Šã®å›è»¢ã€ã¤ã¾ã‚Šæ–¹ä½ï¼‰ã‚’å–å¾—
                // ã»ã¨ã‚“ã©ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã€alphaã¯ç£åŒ—ã«å¯¾ã™ã‚‹è§’åº¦ (0-360åº¦) ã‚’ç¤ºã™
                let compassHeading = event.webkitCompassHeading || event.alpha;

                if (compassHeading === null || compassHeading === undefined) {
                     document.getElementById('compassHeading').textContent = "ã‚³ãƒ³ãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ç«¯æœ«ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                     window.removeEventListener('deviceorientation', handleOrientation);
                     return;
                }

                // ä¸€éƒ¨ã®Androidãƒ‡ãƒã‚¤ã‚¹ã§ã¯ã€çµ¶å¯¾å€¤ (isAbsolute) ãŒå¿…è¦
                if (event.isAbsolute === false) {
                    document.getElementById('compassHeading').textContent = "ãƒ‡ãƒã‚¤ã‚¹ã®çµ¶å¯¾æ–¹ä½ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚³ãƒ³ãƒ‘ã‚¹ï¼‰ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚";
                    window.removeEventListener('deviceorientation', handleOrientation);
                    return;
                }

                // 360åº¦èª¿æ•´
                compassHeading = (360 - compassHeading) % 360; 

                // æ¸¬å®šçµæœã‚’è¡¨ç¤º
                document.getElementById('compassHeading').textContent = `${compassHeading.toFixed(2)} Â° (ç£åŒ—)`;
                
                // 4. èª¤å·®è§’åº¦ã‚’è¨ˆç®—
                calculateErrorAngle(compassHeading);

                // æ¸¬å®šãŒå®Œäº†ã—ãŸã®ã§ã€ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã€ä¸€åº¦ã§çµ‚äº†
                window.removeEventListener('deviceorientation', handleOrientation);
            };

            // ãƒ‡ãƒã‚¤ã‚¹ã®å‘ãå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
            // ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç«¯æœ«ã‚’å‹•ã‹ã™å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            window.addEventListener('deviceorientation', handleOrientation);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç«¯æœ«ã‚’å‹•ã‹ã™ã‚ˆã†ã«æŒ‡ç¤º
             setTimeout(() => {
                if (document.getElementById('compassHeading').textContent === "ã‚³ãƒ³ãƒ‘ã‚¹æ¸¬å®šä¸­...") {
                     document.getElementById('compassHeading').textContent = "æ¸¬å®šã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ç«¯æœ«ã‚’æ°´å¹³ã«æŒã¡ã€ã‚†ã£ãã‚Šã¨å›è»¢ã•ã›ã¦ã¿ã¦ãã ã•ã„ã€‚";
                }
            }, 3000);
        }

        /**
         * 4. 2ã¨3ã§å¾—ã‚‰ã‚ŒãŸæ–¹ä½ã®ã‚³ãƒ³ãƒ‘ã‚¹èª¤å·®è§’åº¦ã‚’è¡¨ç¤ºã™ã‚‹
         * @param {number} compassHeading - ã‚³ãƒ³ãƒ‘ã‚¹ãŒæ¤œçŸ¥ã—ãŸæ–¹ä½ï¼ˆç£åŒ—ï¼‰
         */
        function calculateErrorAngle(compassHeading) {
            const trueBearingText = document.getElementById('trueBearing').textContent;
            if (trueBearingText.includes('---')) {
                document.getElementById('errorAngle').textContent = "å…ˆã«åœ°å›³ä¸Šã§ã®æ–¹ä½ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚";
                return;
            }

            // æ–‡å­—åˆ—ã‹ã‚‰è§’åº¦ã‚’ãƒ‘ãƒ¼ã‚¹
            const trueBearing = parseFloat(trueBearingText.split(' ')[0]);

            // è§’åº¦ã®å·®ã‚’è¨ˆç®— (0ã€œ360åº¦ã®æœ€çŸ­è·é›¢)
            let diff = trueBearing - compassHeading;
            
            // å·®ã‚’-180åº¦ã‹ã‚‰180åº¦ã®ç¯„å›²ã«èª¿æ•´
            if (diff > 180) {
                diff -= 360;
            } else if (diff < -180) {
                diff += 360;
            }

            // èª¤å·®è§’åº¦ã‚’è¡¨ç¤º
            document.getElementById('errorAngle').textContent = `${diff.toFixed(2)} Â°`;
            
            // ã‚¨ãƒ©ãƒ¼ã‚’å¤§ããè¡¨ç¤ºï¼ˆä¾‹: èª¤å·®ãŒå¤§ãã‘ã‚Œã°èµ¤ãã™ã‚‹ï¼‰
            const errorElement = document.getElementById('errorAngle');
            errorElement.style.color = Math.abs(diff) > 10 ? '#dc3545' : '#28a745';
        }
    </script>
</body>
</html>
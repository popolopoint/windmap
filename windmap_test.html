<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚³ãƒ¼ã‚¹ä½œãã‚“ v1.3.2 by Popolo App.com</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #fdfaf6; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .app-header { background: #e67e22; color: white; padding: 10px; text-align: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; }
        .ui-panel { background: white; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; flex-shrink: 0; }
        
        /* ã‚³ãƒ¼ã‚¹ä½œæˆç”¨å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 0.7rem; font-weight: bold; color: #7f8c8d; margin-bottom: 2px; }
        .input-group input { padding: 10px; border: 2px solid #e67e22; border-radius: 6px; font-size: 1rem; font-weight: bold; text-align: center; }
        
        .main-btn { background: #e67e22; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1.2rem; width: 100%; cursor: pointer; }
        .main-btn:active { background: #d35400; transform: scale(0.98); }

        #map-container { flex-grow: 1; position: relative; border-top: 2px solid #eee; }
        #map { width: 100%; height: 100%; }

        /* å‡¡ä¾‹ï¼ˆæ°´æ·±ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰ */
        .depth-legend { position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 10; font-size: 0.7rem; pointer-events: none; }
        .legend-item { display: flex; align-items: center; margin-bottom: 3px; }
        .color-box { width: 10px; height: 10px; margin-right: 5px; border: 1px solid #333; }

        .gps-button { position: absolute; bottom: 20px; right: 10px; width: 50px; height: 50px; background: white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 10; cursor: pointer; font-size: 24px; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 5000; font-weight: bold; color: #e67e22; }
    </style>
</head>
<body>

<div id="loading">ğŸ“¡ é€šä¿¡ä¸­...</div>
<div class="app-header">ã‚³ãƒ¼ã‚¹ä½œãã‚“ v1.3.2 by Popolo App.com</div>

<div class="ui-panel">
    <div class="input-grid">
        <div class="input-group">
            <label>è§’D (Â°)</label>
            <input type="number" id="angle-d" value="30">
        </div>
        <div class="input-group">
            <label>è§’B (Â°)</label>
            <input type="number" id="angle-b" value="45">
        </div>
        <div class="input-group">
            <label>ASè·é›¢ (m)</label>
            <input type="number" id="as-dist" value="100">
        </div>
        <div class="input-group">
            <label>ã‚³ãƒ¼ã‚¹å</label>
            <input type="text" id="course-name" placeholder="ç¬¬1ã‚³ãƒ¼ã‚¹">
        </div>
    </div>
    <button class="main-btn" onclick="recordCourse()">ç¾åœ¨åœ°ã§ã‚³ãƒ¼ã‚¹ä½œæˆãƒ»è¨˜éŒ²</button>
</div>

<div id="map-container">
    <div id="map"></div>
    <div class="depth-legend">
        <div class="legend-item"><div class="color-box" style="background:#ff0000;"></div>æµ…ã„</div>
        <div class="legend-item"><div class="color-box" style="background:#00ff00;"></div>æ™®é€š</div>
        <div class="legend-item"><div class="color-box" style="background:#0000ff;"></div>æ·±ã„</div>
    </div>
    <div class="gps-button" onclick="updateMyLocation(true)">ğŸ“</div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>

<script>
    const COURSE_APP_URL = "https://script.google.com/macros/s/AKfycbzpDclmR7P8N_MvW-Yid089UoR9yG6i_HByU-N3wL0-FzN-Y1M0X_R3_8H-T0B_9/exec";
    const DEPTH_APP_URL = "https://script.google.com/macros/s/AKfycbw1wg_a28-_dOyLbik9VnYfbzKEHPNBWwaVVeyc4gcibovUIQ5BUGNw1esYy0beyZVf3g/exec";

    let map, gridLines = [], myLocationMarker = null;

    async function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 18, center: { lat: 26.3318, lng: 127.9288 }, 
            mapTypeId: 'roadmap', gestureHandling: 'greedy'
        });

        map.addListener('idle', drawGrid);
        
        // ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        await loadDepthMarkers(); 
        
        updateMyLocation(true);
        navigator.geolocation.watchPosition(updateMyLocation, null, {enableHighAccuracy: true});
    }

    // --- æ°´æ·±ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ©Ÿèƒ½ ---
    async function loadDepthMarkers() {
        try {
            const res = await fetch(DEPTH_APP_URL);
            const data = await res.json();
            const points = data.points || [];
            points.forEach(p => {
                const baseDepth = parseFloat(p[4]) || 0;
                const type = p[6];
                let sym = google.maps.SymbolPath.CIRCLE;
                if(type === "å²©") sym = "M 0,-1.1 L 1.2,1 L -1.2,1 Z"; 
                else if(type === "æ­") sym = "M 0,-1.2 L 1,0 L 0,1.2 L -1,0 Z"; 

                new google.maps.Marker({
                    position: { lat: Number(p[1]), lng: Number(p[2]) },
                    map: map,
                    icon: {
                        path: sym,
                        fillColor: getDepthColor(baseDepth),
                        fillOpacity: 0.4, // ã‚³ãƒ¼ã‚¹ä½œæˆã®é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†è–„ã
                        scale: 5,
                        strokeColor: "#666",
                        strokeWeight: 1
                    },
                    clickable: false
                });
            });
        } catch (e) { console.error("æ°´æ·±ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—"); }
    }

    function getDepthColor(b) {
        if (b < 40) return "#ff0000"; if (b < 100) return "#00ff00"; return "#0000ff";
    }

    // --- ã‚³ãƒ¼ã‚¹è¨˜éŒ²æ©Ÿèƒ½ ---
    async function recordCourse() {
        showLoading(true);
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const data = {
                method: 'POST',
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                angleD: document.getElementById('angle-d').value,
                angleB: document.getElementById('angle-b').value,
                asDist: document.getElementById('as-dist').value,
                name: document.getElementById('course-name').value || "æ–°è¦ã‚³ãƒ¼ã‚¹"
            };
            try {
                const res = await fetch(COURSE_APP_URL, { method: 'POST', body: JSON.stringify(data) });
                alert("ã‚³ãƒ¼ã‚¹ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            } catch (e) { alert("ä¿å­˜å¤±æ•—"); }
            showLoading(false);
        }, () => { alert("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼"); showLoading(false); }, {enableHighAccuracy: true});
    }

    // --- ã‚°ãƒªãƒƒãƒ‰æç”» (50mç‚¹ç·š / 100må®Ÿç·š) ---
    function drawGrid() {
        gridLines.forEach(line => line.setMap(null));
        gridLines = [];
        const zoom = map.getZoom();
        if (zoom < 15) return;
        const bounds = map.getBounds();
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        const step = 0.00045; 
        const startLat = Math.floor(sw.lat() / step) * step;
        const startLng = Math.floor(sw.lng() / step) * step;
        for (let lat = startLat; lat <= ne.lat(); lat += step) {
            const is100m = Math.round(lat / step) % 2 === 0;
            drawCustomLine([{lat: lat, lng: sw.lng()}, {lat: lat, lng: ne.lng()}], is100m);
        }
        for (let lng = startLng; lng <= ne.lng(); lng += step) {
            const is100m = Math.round(lng / step) % 2 === 0;
            drawCustomLine([{lat: sw.lat(), lng: lng}, {lat: ne.lat(), lng: lng}], is100m);
        }
    }

    function drawCustomLine(path, isBold) {
        const line = new google.maps.Polyline({
            path: path, geodesic: true, strokeColor: '#000',
            strokeOpacity: isBold ? 0.3 : 0.1, strokeWeight: isBold ? 1 : 0.5,
            icons: isBold ? [] : [{ icon: { path: 'M 0,-1 0,1', strokeOpacity: 0.5, scale: 1 }, offset: '0', repeat: '12px' }],
            map: map, clickable: false
        });
        gridLines.push(line);
    }

    function updateMyLocation(panTo = false) {
        navigator.geolocation.getCurrentPosition((pos) => {
            const latLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            if (!myLocationMarker) {
                myLocationMarker = new google.maps.Marker({
                    position: latLng, map: map,
                    icon: { path: google.maps.SymbolPath.CIRCLE, fillColor: '#e67e22', fillOpacity: 1, scale: 7, strokeColor: 'white', strokeWeight: 2 },
                    zIndex: 999
                });
            } else { myLocationMarker.setPosition(latLng); }
            if (panTo) map.panTo(latLng);
        }, null, {enableHighAccuracy: true});
    }

    function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>windmap v3.5.5</title>
<style>
:root{--blue:#1976d2;--purple:#6a1b9a;--red:#d32f2f;--green:#2e7d32;--orange:#f57c00}
body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN","ãƒ¡ã‚¤ãƒªã‚ª",Meiryo,sans-serif;margin:10px;color:#222}
h2{margin:0 0 8px 0;font-size:18px}
#version{position:absolute;right:12px;top:12px;color:#666;font-size:13px}
#inputs{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
#inputs label{font-size:14px}
input[type="number"]{width:70px;padding:6px;border-radius:6px;border:1px solid #ccc}
button{padding:6px 10px;border-radius:6px;border:none;color:white;cursor:pointer}
#map{width:100%;height:500px;border-radius:8px;margin-top:10px;box-shadow:0 1px 2px rgba(0,0,0,.08)}
.distanceBox{background:#eee;padding:4px 6px;border-radius:6px;margin-bottom:4px;font-weight:bold}
.pointBox{border-radius:50%;width:32px;height:32px;display:flex;justify-content:center;align-items:center;color:white;font-weight:bold;cursor:pointer;margin-right:6px;margin-bottom:6px}
#coordsContainer{display:flex;flex-wrap:wrap;align-items:center;gap:6px}
#compassPermissionBtn{position:absolute;top:10px;right:10px;padding:10px;background:#ff4444;color:#fff;border:none;border-radius:6px;font-weight:bold;z-index:10000}
#thInfo{font-size:14px;color:#222;margin-left:6px}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background: rgba(0,0,0,0.5);z-index:2000}
.modal{background:#fff;padding:16px;border-radius:10px;width:92%;max-width:420px;box-shadow:0 8px 24px rgba(0,0,0,0.25);text-align:center}
.modal .reading{font-size:20px;font-weight:700;color:#111;margin-bottom:12px}
.modal .buttons{display:flex;gap:8px;justify-content:center}
.modal button{padding:8px 12px;border-radius:8px;font-weight:600}
.modal .btnConfirm{background:var(--purple);color:white}
.modal .btnCancel{background:#ccc;color:#111}
select{padding:6px;border-radius:6px;border:1px solid #ccc}
@media (max-width:600px){input[type="number"]{width:90px}#map{height:420px}}
</style>
</head>
<body>
<h2>ã‚³ãƒ¼ã‚¹ä½œã‚‹ãã‚“ <span style="font-size:0.7em;">v3.5.5</span></h2>
<div id="version">v3.5.5</div>

<button id="compassPermissionBtn">ã‚³ãƒ³ãƒ‘ã‚¹è¨±å¯ â†ã“ã“ã‚’ã‚¿ãƒƒãƒ—</button>

<div id="inputs">
  <label>ç·¯åº¦Aï¼š<input type="number" id="latA" step="any" value=""></label>
  <label>çµŒåº¦Aï¼š<input type="number" id="lngA" step="any" value=""></label>

  <label>ç›®æ¨™ç‰©ï¼š
    <select id="landmarkSelect">
      <option value="gushikawa">â‘  å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€</option>
      <option value="kin">â‘¡ é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€</option>
      <option value="kujira">â‘¢ ãã˜ã‚‰ã®ã—ã£ã½</option>
      <option value="uminoeki">â‘£ æµ·ã®é§…ã‚ã‚„ã¯ã—</option>
      <option value="henza">â‘¤ å¹³å®‰åº§æµ·ä¸­å¤§æ©‹</option>
      <option value="maptap">ğŸ“ åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</option>
    </select>
  </label>

  <label>é¢¨å‘(Â°)ï¼š<input type="number" id="wind" step="any" value=""></label>
  <label>è·é›¢(m)ï¼š<input type="number" id="dist" step="any" value="500"></label>
  <label>è§’åº¦(Â°)ï¼š<input type="number" id="theta" step="any" value="5"></label>
  <label>ã‚³ãƒ¼ã‚¹ï¼š
    <select id="courseSelect"><option value="mcourse">ï¼­ã‚³ãƒ¼ã‚¹</option><option value="figure8">ãƒ•ã‚£ã‚®ã‚¢ï¼˜</option></select>
  </label>

  <button id="btnWindSet" style="background:var(--purple)">é¢¨å‘ã‚’ã‚»ãƒƒãƒˆ</button>
  <button id="btnSetTarget" style="background:#0077cc">ç›®æ¨™ç‰©Tã‚»ãƒƒãƒˆ</button>
  <button id="btnApplyCorrection" style="background:#2b8a3e">è£œæ­£é¢¨å‘ã‚’åæ˜ ï¼ˆä»»æ„ï¼‰</button>

  <button id="calcBtn" style="background:var(--blue)">è¨ˆç®—</button>
  <button id="btnSetCurrent" style="background:var(--red)">ç¾åœ¨ä½ç½®ã‚’Aç‚¹ã«</button>
  <button id="btnStarboard" style="background:var(--green)" title="ã‚¹ã‚¿ãƒœãƒ¼">ã‚¹ã‚¿ãƒœãƒ¼</button>
  <button id="btnPort" style="background:var(--orange)" title="ãƒãƒ¼ãƒˆ">ãƒãƒ¼ãƒˆ</button>
  <button id="btnShareAll" style="background:#555">ãƒ‡ãƒ¼ã‚¿é€ä¿¡</button>

  <div id="thInfo"></div>
</div>

<div id="inputsMode">Aç‚¹è¨­å®šæ–¹æ³•ï¼š
  <label><input type="radio" name="aMode" value="current" checked> ç¾åœ¨ä½ç½®</label>
  <label><input type="radio" name="aMode" value="map"> ãƒãƒƒãƒ—</label>
  <label><input type="radio" name="aMode" value="manual"> æ‰‹å…¥åŠ›</label>
</div>

<div id="distances"><div class="distanceBox" id="dAC">Aï½Cè·é›¢ï¼š- m</div><div class="distanceBox" id="dAE">Aï½Eè·é›¢ï¼š- m</div></div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:#ff3b30">A</div>
  <div class="pointBox" id="btnB" style="background:#0088ff">B</div>
  <div class="pointBox" id="btnC" style="background:#00aa00">C</div>
  <div class="pointBox" id="btnD" style="background:#ffaa00">D</div>
  <div class="pointBox" id="btnE" style="background:#9900ff">E</div>
</div>

<div id="map"></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="windModal" style="display:none" aria-hidden="true">
  <div class="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">æ–¹ä½ã‚’ã‚»ãƒƒãƒˆ</h3>
      <p id="modalInstruction">ã‚¹ãƒãƒ›ã‚’å‘ã‘ã¦å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã€Œè¨­å®šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
      <div class="reading" id="headingRead">--Â°</div>
      <div class="buttons">
        <button class="btnConfirm" id="modalSetBtn">è¨­å®š</button>
        <button class="btnCancel" id="modalCloseBtn">é–‰ã˜ã‚‹</button>
      </div>
      <div class="note" id="modalNote">ã€Œã‚³ãƒ³ãƒ‘ã‚¹è¨±å¯ã€ã‚’å…ˆã«æŠ¼ã—ã¦ãã ã•ã„ï¼ˆiOSã®å ´åˆã¯è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã¾ã™ï¼‰ã€‚</div>
    </div>
  </div>
</div>

<script>
/* v3.5.5: v3.5.2 ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€è£œæ­£å¾Œé¢¨å‘ã‚’è‡ªå‹•ã§ #wind ã«å…¥åŠ›ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã€‚
   è£œæ­£åæ˜ ãƒœã‚¿ãƒ³ã¯æ®‹ã™ï¼ˆä»»æ„ã§å†åæ˜ ï¼‰ã€‚ */

const LANDMARKS = {
  gushikawa:{name:'å…·å¿—å·ç«åŠ›ç™ºé›»æ‰€', lat:26.35194, lng:127.86861},
  kin:{name:'é‡‘æ­¦ç«åŠ›ç™ºé›»æ‰€', lat:26.47631, lng:127.96901},
  kujira:{name:'ãã˜ã‚‰ã®ã—ã£ã½', lat:26.33429, lng:127.87517},
  uminoeki:{name:'æµ·ã®é§…ã‚ã‚„ã¯ã—', lat:26.33289, lng:127.89106},
  henza:{name:'å¹³å®‰åº§æµ·ä¸­å¤§æ©‹', lat:26.34259, lng:127.90296}
};

let map, circles={}, markersLabel={}, polyline=null;
let points={A:null,B:null,C:null,D:null,E:null};
let currentIsPort=true;

function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat:26.3318,lng:127.9179 }, zoom:14 });
  map.addListener('click',(e)=>{
    if(document.querySelector('input[name="aMode"]:checked').value==='map'){
      const lat=e.latLng.lat(), lng=e.latLng.lng();
      document.getElementById('latA').value = lat.toFixed(6);
      document.getElementById('lngA').value = lng.toFixed(6);
      updatePointA({lat,lng});
      const sel = document.getElementById('landmarkSelect').value;
      if(sel === 'maptap'){
        document.getElementById('landmarkSelect').dataset.maptapLat = lat;
        document.getElementById('landmarkSelect').dataset.maptapLng = lng;
        alert('åœ°å›³ä¸Šã§ç›®æ¨™ç‰©ã‚’é¸æŠã—ã¾ã—ãŸ');
      }
    }
  });
}

function movePoint(lat,lng,dist,bearing){
  const R=6378137; const brng=(bearing%360)*Math.PI/180;
  const Ï†1=lat*Math.PI/180, Î»1=lng*Math.PI/180, Î´=dist/R;
  const Ï†2=Math.asin(Math.sin(Ï†1)*Math.cos(Î´)+Math.cos(Ï†1)*Math.sin(Î´)*Math.cos(brng));
  const Î»2=Î»1+Math.atan2(Math.sin(brng)*Math.sin(Î´)*Math.cos(Ï†1), Math.cos(Î´)-Math.sin(Ï†1)*Math.sin(Ï†2));
  return {lat: Ï†2*180/Math.PI, lng: Î»2*180/Math.PI};
}

function clearPoint(label){ if(circles[label]){ circles[label].setMap(null); delete circles[label]; } if(markersLabel[label]){ markersLabel[label].setMap(null); delete markersLabel[label]; } }
function drawPoint(label,pos,color,radius=12){ if(!pos){ clearPoint(label); return;} clearPoint(label); const actualRadius=(label==='A')?radius+4:radius; circles[label]=new google.maps.Circle({ strokeColor:color, strokeOpacity:1, strokeWeight:2, fillColor:color, fillOpacity:0.85, map, center:pos, radius:actualRadius }); markersLabel[label]=new google.maps.Marker({ position:pos, map, icon:{ path:google.maps.SymbolPath.CIRCLE, scale:0 }, label:{ text:label, color:'white', fontWeight:'bold', fontSize:'14px'}}); circles[label].addListener('click',()=>shareCoords(label,pos)); markersLabel[label].addListener('click',()=>shareCoords(label,pos)); }
function updatePointA(pos){ points.A=pos; drawPoint('A',pos,'#ff3b30'); map.panTo(pos); }

function setCurrentPositionA(){ if(!navigator.geolocation){ alert('ç¾åœ¨ä½ç½®ãŒå–å¾—ã§ãã¾ã›ã‚“'); return; } navigator.geolocation.getCurrentPosition(pos=>{ const lat=pos.coords.latitude,lng=pos.coords.longitude; document.getElementById('latA').value=lat.toFixed(6); document.getElementById('lngA').value=lng.toFixed(6); updatePointA({lat,lng}); calculatePort(); },()=>{ alert('ä½ç½®æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'); }); }

function distanceBetween(p1,p2){ if(!p1||!p2) return 0; const R=6378137; const Ï†1=p1.lat*Math.PI/180, Ï†2=p2.lat*Math.PI/180; const dÏ†=(p2.lat-p1.lat)*Math.PI/180, dÎ»=(p2.lng-p1.lng)*Math.PI/180; const a=Math.sin(dÏ†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dÎ»/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }

function calculatePort(){ currentIsPort=true; calculateCourse(true); }
function calculateStarboard(){ currentIsPort=false; calculateCourse(false); }

function calculateCourse(isPort){
  const latA=parseFloat(document.getElementById('latA').value);
  const lngA=parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA)||isNaN(lngA)){ alert('Aç‚¹ãŒæœªè¨­å®šã§ã™'); return; }
  const wind=parseFloat(document.getElementById('wind').value)||0;
  const dist=parseFloat(document.getElementById('dist').value)||0;
  const theta=parseFloat(document.getElementById('theta').value)||0;
  const course=document.getElementById('courseSelect').value; points.A={lat:latA,lng:lngA};
  if(course==='figure8'){
    const bB = wind + (isPort ? (90 + theta) : (270 - theta)); points.B = movePoint(points.A.lat, points.A.lng, dist, bB);
    const distBC = dist * Math.cos(theta * Math.PI / 180); const bearingC = isPort ? (wind + 270) : (wind + 90); points.C = movePoint(points.B.lat, points.B.lng, distBC, bearingC); points.D=null; points.E=null;
  } else {
    const bB = wind + (isPort ? 90 + theta : 270 - theta);
    const bC = wind + (isPort ? 270 - theta : 90 + theta);
    const bD = wind + (isPort ? 90 + theta : 270 - theta);
    const bE = wind + (isPort ? 270 - theta : 90 + theta);
    points.B = movePoint(points.A.lat, points.A.lng, dist, bB);
    points.C = movePoint(points.B.lat, points.B.lng, dist, bC);
    points.D = movePoint(points.C.lat, points.C.lng, dist, bD);
    points.E = movePoint(points.D.lat, points.D.lng, dist, bE);
  }
  drawPoint('A',points.A,'#ff3b30'); drawPoint('B',points.B,'#0088ff'); if(points.C) drawPoint('C',points.C,'#00aa00'); else clearPoint('C'); if(points.D) drawPoint('D',points.D,'#ffaa00'); else clearPoint('D'); if(points.E) drawPoint('E',points.E,'#9900ff'); else clearPoint('E');
  if(polyline) polyline.setMap(null); const path=[]; ['A','B','C','D','E'].forEach(k=>{ if(points[k]) path.push(points[k]); }); if(path.length>=2){ polyline=new google.maps.Polyline({ path, geodesic:true, strokeColor:'#444', strokeOpacity:0.9, strokeWeight:2, map }); } else { polyline=null; }
  if(points.C){ document.getElementById('dAC').textContent = 'Aï½Cè·é›¢ï¼š' + distanceBetween(points.A, points.C).toFixed(1) + ' m'; } else { document.getElementById('dAC').textContent = 'Aï½Cè·é›¢ï¼š- m'; }
  if(document.getElementById('courseSelect').value === 'figure8'){ document.getElementById('dAE').textContent = 'Aï½Eè·é›¢ï¼š- m'; } else { if(points.E){ document.getElementById('dAE').textContent = 'Aï½Eè·é›¢ï¼š' + distanceBetween(points.A, points.E).toFixed(1) + ' m'; } else { document.getElementById('dAE').textContent = 'Aï½Eè·é›¢ï¼š- m'; } }
}

/* ------------------ compass / modal logic ------------------ */
let headingSamples=[], headingWatcher=null; let modalMode=null; let latestHeading=null; let savedT=null, savedH=null, savedCorrection=null;
function normalizeHeadingFromEvent(e){ if(typeof e.webkitCompassHeading==='number' && e.webkitCompassHeading>=0) return e.webkitCompassHeading; let alpha=e.alpha; if(alpha===null||typeof alpha!=='number') return null; let heading=360-alpha; let screenOrientation=0; if(typeof window.screen.orientation !=='undefined' && typeof window.screen.orientation.angle==='number') screenOrientation=window.screen.orientation.angle; else if(typeof window.orientation==='number') screenOrientation=window.orientation; heading=(heading+screenOrientation)%360; if(heading<0) heading+=360; return heading; }
function circularMean(degs){ if(!degs||degs.length===0) return null; let x=0,y=0; degs.forEach(d=>{ const r=d*Math.PI/180; x+=Math.cos(r); y+=Math.sin(r); }); const mean=Math.atan2(y,x)*180/Math.PI; return (mean+360)%360; }
function orientationHandler(e){ const heading=normalizeHeadingFromEvent(e); if(heading===null) return; latestHeading=heading; headingSamples.push(heading); if(headingSamples.length>40) headingSamples.shift(); const avg=circularMean(headingSamples); if(avg!==null) document.getElementById('headingRead').textContent=Math.round(avg)+'Â°'; }
function addOrientationListeners(){ removeOrientationListeners(); window.addEventListener('deviceorientationabsolute', orientationHandler, true); window.addEventListener('deviceorientation', orientationHandler, true); }
function removeOrientationListeners(){ try{ window.removeEventListener('deviceorientationabsolute', orientationHandler, true);}catch(e){} try{ window.removeEventListener('deviceorientation', orientationHandler, true);}catch(e){} }

const modalRoot=document.getElementById('windModal'); const headingReadEl=document.getElementById('headingRead'); const modalTitle=document.getElementById('modalTitle'); const modalInstructionEl=document.getElementById('modalInstruction'); const modalSetBtn=document.getElementById('modalSetBtn'); const modalCloseBtn=document.getElementById('modalCloseBtn');
function openModal(mode){ modalMode=mode; headingSamples=[]; latestHeading=null; modalRoot.style.display='block'; modalRoot.setAttribute('aria-hidden','false'); headingReadEl.textContent='--Â°'; modalTitle.textContent=(mode==='T')? 'ç›®æ¨™ç‰©Tã‚’ã‚»ãƒƒãƒˆ' : 'é¢¨å‘Hã‚’ã‚»ãƒƒãƒˆ'; modalInstructionEl.textContent='ã‚¹ãƒãƒ›ã‚’ãã®æ–¹å‘ã«å‘ã‘ã¦ã€æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ã€Œè¨­å®šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'; startOrientationListeningWithPermission(); }
function closeModal(){ removeOrientationListeners(); modalRoot.style.display='none'; modalRoot.setAttribute('aria-hidden','true'); modalMode=null; }
function startOrientationListeningWithPermission(){ if(typeof DeviceOrientationEvent !=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){ DeviceOrientationEvent.requestPermission().then(r=>{ if(r==='granted'){ addOrientationListeners(); } else { modalInstructionEl.textContent='æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'; } }).catch(err=>{ modalInstructionEl.textContent='æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚'; console.error(err); }); } else { addOrientationListeners(); } }

function toRad(d){ return d*Math.PI/180; } function toDeg(r){ return r*180/Math.PI; }
function calcBearing(lat1,lng1,lat2,lng2){ const y=Math.sin(toRad(lng2-lng1))*Math.cos(toRad(lat2)); const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lng2-lng1)); return (toDeg(Math.atan2(y,x))+360)%360; }

modalSetBtn.addEventListener('click', ()=>{
  const avg=circularMean(headingSamples);
  if(avg===null){ alert('æ–¹ä½ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚'); return; }
  if(modalMode==='T'){
    const sel=document.getElementById('landmarkSelect').value; let targetLat,targetLng;
    if(sel==='maptap'){ const lat=parseFloat(document.getElementById('landmarkSelect').dataset.maptapLat); const lng=parseFloat(document.getElementById('landmarkSelect').dataset.maptapLng); if(!lat||!lng){ alert('åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç›®æ¨™ç‰©ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } targetLat=lat; targetLng=lng; }
    else { const key=(sel==='uminoeki')? 'uminoeki' : sel; const lm=LANDMARKS[key]; if(!lm){ alert('ç›®æ¨™ç‰©ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; } targetLat=lm.lat; targetLng=lm.lng; }
    const latA=parseFloat(document.getElementById('latA').value); const lngA=parseFloat(document.getElementById('lngA').value); if(isNaN(latA)||isNaN(lngA)){ alert('Aç‚¹ã‚’å…ˆã«è¨­å®šã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨ä½ç½®ã¾ãŸã¯æ‰‹å…¥åŠ›ï¼‰'); return; }
    const trueBearing=calcBearing(latA,lngA,targetLat,targetLng);
    savedT=Math.round(avg);
    let diff=(savedT - trueBearing + 540)%360 - 180; savedCorrection=Math.round(diff);
    document.getElementById('thInfo').innerHTML = `ç›®æ¨™ç‰©: ${(sel==='maptap'?'åœ°å›³ã‚¿ãƒƒãƒ—':(LANDMARKS[sel]?LANDMARKS[sel].name:sel))} &nbsp; çœŸæ–¹ä½: ${Math.round(trueBearing)}Â° &nbsp; T(æ¸¬å®š): ${savedT}Â° &nbsp; èª¤å·®: ${savedCorrection}Â°`;
    alert(`ç›®æ¨™ç‰©Tã‚»ãƒƒãƒˆå®Œäº†\nçœŸæ–¹ä½: ${Math.round(trueBearing)}Â°\nT(æ¸¬å®š): ${savedT}Â°\nèª¤å·®: ${savedCorrection}Â°`);
  } else if(modalMode==='H'){
    savedH=Math.round(avg);
    document.getElementById('thInfo').innerHTML = `H(æ¸¬å®š): ${savedH}Â° &nbsp; ${ (savedCorrection!==null?('è£œæ­£å€¤: '+savedCorrection+'Â°'):'') }`;
    alert('é¢¨å‘Hã‚’ ' + savedH + 'Â° ã«ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }
  // If both savedT and savedH exist, auto-calc corrected and fill #wind (v3.5.5 change)
  if(savedT!==null && savedH!==null && savedCorrection!==null){
    const corrected = ((savedH - savedCorrection) % 360 + 360) % 360; // H - diff
    document.getElementById('wind').value = Math.round(corrected);
    document.getElementById('thInfo').innerHTML = `T: ${savedT}Â° &nbsp; H: ${savedH}Â° &nbsp; èª¤å·®: ${savedCorrection}Â° &nbsp; è£œæ­£å¾Œ: ${Math.round(corrected)}Â°`;
    // optional: notify user
    alert('è£œæ­£å¾Œé¢¨å‘ã‚’è‡ªå‹•ã§å…¥åŠ›ã—ã¾ã—ãŸï¼š' + Math.round(corrected) + 'Â°ï¼ˆå¿…è¦ãªã‚‰ã€Œè¨ˆç®—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰');
  }
  closeModal();
});

/* optional explicit apply button (kept for backward compatibility) */
document.getElementById('btnApplyCorrection').addEventListener('click', ()=>{
  if(savedH===null){ alert('ã¾ãšé¢¨å‘Hã‚’æ¸¬å®šã—ã¦ãã ã•ã„'); return; }
  if(savedCorrection===null){ alert('ã¾ãšç›®æ¨™ç‰©Tã‚’æ¸¬å®šã—ã¦èª¤å·®ã‚’è¨ˆç®—ã—ã¦ãã ã•ã„'); return; }
  const corrected = ((savedH - savedCorrection) % 360 + 360) % 360;
  document.getElementById('wind').value = Math.round(corrected);
  document.getElementById('thInfo').innerHTML = `H(æ¸¬å®š): ${savedH}Â° &nbsp; èª¤å·®: ${savedCorrection}Â° &nbsp; è£œæ­£å¾Œ: ${Math.round(corrected)}Â°`;
  alert('è£œæ­£å¾Œé¢¨å‘ã‚’å…¥åŠ›æ¬„ã«åæ˜ ã—ã¾ã—ãŸï¼š' + Math.round(corrected) + 'Â°');
});

/* Compass permission button */
const compassBtn=document.getElementById('compassPermissionBtn');
compassBtn.addEventListener('click', ()=>{
  if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(res=>{ if(res==='granted'){ addOrientationListeners(); compassBtn.style.display='none'; alert('ã‚³ãƒ³ãƒ‘ã‚¹ã‚’è¨±å¯ã—ã¾ã—ãŸã€‚ç›®æ¨™ç‰©/é¢¨å‘ã‚’æ¸¬å®šã—ã¦ãã ã•ã„ã€‚'); } else { alert('ã‚³ãƒ³ãƒ‘ã‚¹ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ'); } }).catch(err=>{ console.error(err); alert('è¨±å¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); });
  } else { addOrientationListeners(); compassBtn.style.display='none'; alert('ã‚³ãƒ³ãƒ‘ã‚¹ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚ç›®æ¨™ç‰©/é¢¨å‘ã‚’æ¸¬å®šã—ã¦ãã ã•ã„ã€‚'); }
});

/* share functions */
function shareCoords(label,pos){ if(!pos){ alert(label+' ç‚¹ã¯æœªè¨­å®šã§ã™'); return; } const text=`${label}ç‚¹\n${pos.lat.toFixed(6)}N\n${pos.lng.toFixed(6)}E\nhttps://maps.google.com/?q=${pos.lat},${pos.lng}`; if(navigator.share){ navigator.share({title:`${label} åº§æ¨™`, text}).catch(()=>{}); return;} if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(()=>alert('åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>{}); return;} const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
function shareAllPoints(){ const wind=parseFloat(document.getElementById('wind').value)||0; const theta=parseFloat(document.getElementById('theta').value)||0; let totalDistance=0; let lines=[]; ['A','B','C','D','E'].forEach((l,i)=>{ const p=points[l]; if(!p){ lines.push(l+'ç‚¹\næœªè¨­å®š'); return; } if(i>0){ const prev=points[['A','B','C','D','E'][i-1]]; if(prev) totalDistance += distanceBetween(prev,p); } const latStr=p.lat.toFixed(6)+'N'; const lngStr=p.lng.toFixed(6)+'E'; const url=`https://maps.google.com/?q=${p.lat},${p.lng}`; lines.push(`${l}ç‚¹\n${latStr}\n${lngStr}\n${url}`); }); lines.push(`é¢¨å‘(Â°): ${wind}`); lines.push(`Î¸(Â°): ${theta}`); lines.push(`ç·è·é›¢(m): ${totalDistance.toFixed(1)}`); const text=lines.join('\n\n'); if(navigator.share){ navigator.share({ title:'ã‚³ãƒ¼ã‚¹åº§æ¨™', text }); } else if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(()=>alert('åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')); } else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); } }

/* Event bindings */
window.addEventListener('load', ()=>{
  document.getElementById('calcBtn').addEventListener('click', ()=> calculateCourse(currentIsPort));
  document.getElementById('btnWindSet').addEventListener('click', ()=> openModal('H'));
  document.getElementById('btnSetTarget').addEventListener('click', ()=> openModal('T'));
  document.getElementById('btnSetCurrent').addEventListener('click', setCurrentPositionA);
  document.getElementById('btnStarboard').addEventListener('click', calculateStarboard);
  document.getElementById('btnPort').addEventListener('click', calculatePort);
  document.getElementById('btnShareAll').addEventListener('click', shareAllPoints);
  ['A','B','C','D','E'].forEach(l=>{ const el=document.getElementById('btn'+l); if(!el) return; el.addEventListener('click', ()=>shareCoords(l, points[l])); });
});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4tqxDKadoSP8XTNwzOGXwh9BprCiR9Zs&callback=initMap" async defer></script>
</body>
</html>

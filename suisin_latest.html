<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Ê∞¥Ê∑±Ê∏¨„Å£Â§™ÈÉé v1.7.1 by Popolo App.com</title>
    <style>
        :root {
            --primary: #007aff;
            --bg: #f2f2f7;
            --panel: #ffffff;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); color: #000; overflow: hidden; }
        #map { width: 100vw; height: 100vh; }
        
        .ui-panel {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); backdrop-filter: blur(10px); z-index: 100;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .header h1 { margin: 0; font-size: 16px; color: #333; }
        
        .tide-info { font-size: 13px; font-weight: bold; color: var(--primary); text-align: center; background: #e5f1ff; padding: 4px; border-radius: 6px; margin-bottom: 8px; }

        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .input-group { flex: 1; }
        .input-group label { display: block; font-size: 10px; font-weight: bold; color: #666; margin-bottom: 2px; }
        .input-group input, .input-group select { width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 8px 4px; font-size: 16px; box-sizing: border-box; }

        .btn-record {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-size: 18px; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,122,255,0.3);
        }
        .btn-record:active { transform: scale(0.98); opacity: 0.9; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 2000; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="loading">üì° „Éá„Éº„ÇøÈÄö‰ø°‰∏≠...</div>

<div class="ui-panel">
    <div class="header">
        <h1>Ê∞¥Ê∑±Ê∏¨„Å£Â§™ÈÉé <span style="font-size: 0.8em; font-weight: normal;">v1.7.1 by Popolo App.com</span></h1>
        <div id="sim-time-display" style="font-size: 12px; color: #666;">--:--</div>
    </div>
    
    <div id="tide-status" class="tide-info">üåä ÊΩÆ‰Ωç„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...</div>

    <div class="input-row">
        <div class="input-group">
            <label>ÂÆüÊ∏¨Ê∞¥Ê∑± (cm)</label>
            <input type="number" id="rawDepth" placeholder="‰æã: 150" inputmode="decimal">
        </div>
        <div class="input-group">
            <label>Á®ÆÂà•</label>
            <select id="pointType">
                <option value="ÈÄöÂ∏∏">ÈÄöÂ∏∏</option>
                <option value="Â≤©">Â≤©</option>
                <option value="Êù≠">Êù≠</option>
            </select>
        </div>
        <div class="input-group">
            <label>„Ç≥„É°„É≥„Éà</label>
            <input type="text" id="comment" placeholder="„É°„É¢">
        </div>
    </div>
    
    <button class="btn-record" onclick="recordPoint()">ÁèæÂú®Âú∞„ÅßË®òÈå≤</button>
</div>

<div id="map"></div>

<script>
    // ‚òÖ „Åì„Åì„Å´„Éá„Éó„É≠„Ç§„Åó„ÅüGAS„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw1wg_a28-_dOyLbik9VnYfbzKEHPNBWwaVVeyc4gcibovUIQ5BUGNw1esYy0beyZVf3g/exec";
    
    let map, markers = [], fullTideData = [], currentTide = 0;
    let currentPos = { lat: 26.3318, lng: 127.9179 };

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: currentPos,
            zoom: 17,
            mapTypeId: 'roadmap', // Ëà™Á©∫ÂÜôÁúü„Åã„ÇâÈÄöÂ∏∏„ÅÆÂú∞Âõ≥„Å´Â§âÊõ¥
            disableDefaultUI: true,
            zoomControl: true,
            gestureHandling: 'greedy'
        });

        // ÁèæÂú®Âú∞ËøΩË∑°
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                currentPos = { lat: p.coords.latitude, lng: p.coords.longitude };
            }, null, { enableHighAccuracy: true });
        }

        loadData();
    }

    async function loadData() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            fullTideData = data.allTideData || [];
            updateTide();
            drawMarkers(data.points || []);
        } catch (e) {
            alert("„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂ§±Êïó");
        }
        document.getElementById('loading').style.display = 'none';
    }

    function updateTide() {
        if (fullTideData.length === 0) return;
        const now = new Date();
        const h = now.getHours();
        const m = now.getMinutes();
        document.getElementById('sim-time-display').textContent = `${h}:${m.toString().padStart(2,'0')}`;

        const row = fullTideData.find(r => {
            const rd = new Date(r[0]);
            return rd.getDate() === now.getDate() && (rd.getMonth()+1) === (now.getMonth()+1);
        });

        if (row) {
            const t1 = parseFloat(row[1+h]), t2 = (h<23)?parseFloat(row[1+h+1]):t1;
            currentTide = t1 + (t2-t1)*(m/60);
            document.getElementById('tide-status').textContent = `üåä ÁèæÂú®„ÅÆ‰∫àÊÉ≥ÊΩÆ‰Ωç: ${currentTide.toFixed(1)}cm`;
        }
    }

    function drawMarkers(points) {
        markers.forEach(m => m.setMap(null));
        markers = [];
        points.forEach(p => {
            const baseDepth = parseFloat(p[4]) || 0;
            const simDepth = baseDepth + currentTide;
            
            let sym = google.maps.SymbolPath.CIRCLE;
            if(p[6] === "Â≤©") sym = "M 0,-1.1 L 1.2,1 L -1.2,1 Z";
            else if(p[6] === "Êù≠") sym = "M 0,-1.2 L 1,0 L 0,1.2 L -1,0 Z";

            const marker = new google.maps.Marker({
                position: {lat: Number(p[1]), lng: Number(p[2])},
                map: map,
                icon: {
                    path: sym,
                    fillColor: getDepthColor(simDepth),
                    fillOpacity: 0.9,
                    scale: 7,
                    strokeColor: "#333",
                    strokeWeight: 1
                },
                label: { text: simDepth.toFixed(0), fontSize: '10px', fontWeight: 'bold' }
            });
            
            const info = new google.maps.InfoWindow({
                content: `<div style="color:#000;font-size:12px;"><b>${p[6]}</b><br>Âü∫Ê∫ñ:${baseDepth.toFixed(1)}cm<br>ÁèæÂú®:${simDepth.toFixed(1)}cm<br>${p[7]||""}</div>`
            });
            marker.addListener('click', () => info.open(map, marker));
            markers.push(marker);
        });
    }

    function getDepthColor(d) {
        if (d < 15) return "#ff3b30"; // Ëµ§
        if (d < 40) return "#ff9500"; // „Ç™„É¨„É≥„Ç∏
        if (d < 70) return "#ffcc00"; // ÈªÑ
        if (d < 100) return "#4cd964"; // Á∑ë
        if (d < 140) return "#5ac8fa"; // Ê∞¥Ëâ≤
        if (d < 180) return "#007aff"; // Èùí
        return "#5856d6"; // Á¥´
    }

    async function recordPoint() {
        const raw = document.getElementById('rawDepth').value;
        if (!raw) return alert("Ê∞¥Ê∑±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        
        const base = parseFloat(raw) - currentTide;
        const data = {
            id: Date.now(),
            lat: currentPos.lat,
            lng: currentPos.lng,
            rawDepth: parseFloat(raw),
            baseDepth: base,
            timestamp: new Date().toISOString(),
            type: document.getElementById('pointType').value,
            comment: document.getElementById('comment').value,
            password: "sanpincha"
        };

        document.getElementById('loading').style.display = 'flex';
        try {
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) });
            document.getElementById('rawDepth').value = "";
            document.getElementById('comment').value = "";
            loadData();
        } catch (e) {
            alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
        }
        document.getElementById('loading').style.display = 'none';
    }

    window.onload = initMap;
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAHhxSJK-IhYiT9XBRwE1MX7DHhghBQQQk&callback=initMap" async defer></script>
</body>
</html>
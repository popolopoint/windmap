<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>コース作成ツール by Popolo</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif;
    margin: 10px;
  }
  h2 { margin: 0 0 8px 0; }
  #version { position: absolute; right: 12px; top: 12px; color: #666; font-size: 13px; }
  #inputs { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom:8px; }
  #inputs label { font-size: 14px; }
  input[type="number"] {
    width: 70px; padding: 6px 6px; border-radius:6px; border:1px solid #ccc;
  }
  button {
    padding: 6px 10px; border-radius:6px; border: none; color:white; cursor:pointer;
  }
  #calcBtn { background:#1976d2; }        /* 青 */
  #btnSetWind { background:#9c27b0; }     /* 紫 */
  #btnSetCurrent { background:#d32f2f; }  /* 赤 */
  #btnStarboard { background:#00aa00; }   /* 緑 */
  #btnPort { background:#ff9800; }        /* オレンジ */
  #btnShare { background:#e91e63; }       /* ピンク（新ボタン） */
  #map { width:100%; height:500px; border-radius:8px; margin-top:10px; }
  #distances { margin-bottom:8px; font-weight:600; }
  .pointBox { border-radius:50%; width:32px; height:32px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; margin-right:6px; margin-bottom:6px; }
  #coordsContainer { display:flex; flex-wrap:wrap; }
  .distanceBox { background:#eee; padding:4px 6px; border-radius:6px; margin-bottom:4px; font-weight:bold; }
  #inputsMode { margin-bottom:5px; }
</style>
</head>
<body>
<h2>コース作成ツール by Popolo <small style="font-weight:normal;color:#666">(v3.2.1)</small></h2>
<div id="version">v3.2.1</div>

<div id="inputs">
  <label>緯度A：<input type="number" id="latA" step="any"></label>
  <label>経度A：<input type="number" id="lngA" step="any"></label>
  <label>風向(°)：<input type="number" id="wind" step="any"></label>
  <label>距離(m)：<input type="number" id="dist" step="any" value="500"></label>
  <label>θ(°)：<input type="number" id="theta" step="any" value="5"></label>
  <button id="btnSetWind">風向をセット</button>
  <button id="btnSetCurrent">現在位置をA点に</button>
  <button id="calcBtn">計算</button>
  <button id="btnStarboard">スタボー</button>
  <button id="btnPort">ポート</button>
  <button id="btnShare">送る</button>
</div>

<div id="inputsMode">
  A点設定方法：
  <label><input type="radio" name="aMode" value="current" checked> 現在位置</label>
  <label><input type="radio" name="aMode" value="map"> マップ</label>
  <label><input type="radio" name="aMode" value="manual"> 手入力</label>
</div>

<div id="distances">
  <div class="distanceBox" id="dAC">A～C距離：- m</div>
  <div class="distanceBox" id="dAE">A～E距離：- m</div>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:#ff3b30;">A</div>
  <div class="pointBox" id="btnB" style="background:#0088ff;">B</div>
  <div class="pointBox" id="btnC" style="background:#00aa00;">C</div>
  <div class="pointBox" id="btnD" style="background:#ffaa00;">D</div>
  <div class="pointBox" id="btnE" style="background:#9900ff;">E</div>
</div>

<div id="map"></div>

<script>
let map, polyline=null;
let circles={}, markersLabel={}, points={A:null,B:null,C:null,D:null,E:null};
let mode="port"; // デフォルトはポート
let popoloLabelMarker=null;

// --- 地図初期化 ---
function initMap(){
  map = new google.maps.Map(document.getElementById('map'), {
    center:{lat:26.3318,lng:127.9179}, zoom:14
  });
  map.addListener('click', (e)=>{
    const aMode=document.querySelector('input[name="aMode"]:checked').value;
    if(aMode==='map'){
      const lat=e.latLng.lat();
      const lng=e.latLng.lng();
      document.getElementById('latA').value=lat.toFixed(6);
      document.getElementById('lngA').value=lng.toFixed(6);
      points.A={lat,lng};
      drawPoint('A',points.A,'#ff3b30');
    }
  });
}

// --- 地点計算 ---
function movePoint(lat,lng,dist,bearingDeg){
  const R=6378137.0;
  const brng=bearingDeg*Math.PI/180;
  const φ1=lat*Math.PI/180;
  const λ1=lng*Math.PI/180;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(dist/R)+Math.cos(φ1)*Math.sin(dist/R)*Math.cos(brng));
  const λ2=λ1+Math.atan2(Math.sin(brng)*Math.sin(dist/R)*Math.cos(φ1),Math.cos(dist/R)-Math.sin(φ1)*Math.sin(φ2));
  return {lat:φ2*180/Math.PI, lng:λ2*180/Math.PI};
}

function drawPoint(label,pos,color){
  if(circles[label]) circles[label].setMap(null);
  if(markersLabel[label]) markersLabel[label].setMap(null);
  circles[label]=new google.maps.Circle({
    strokeColor:color, strokeOpacity:1, strokeWeight:2,
    fillColor:color, fillOpacity:0.85, map, center:pos, radius:16
  });
  markersLabel[label]=new google.maps.Marker({
    position:pos,map,
    icon:{path:google.maps.SymbolPath.CIRCLE,scale:0},
    label:{text:label,color:'white',fontWeight:'bold',fontSize:'14px'}
  });
}

function calculateAll(){
  const latA=parseFloat(document.getElementById('latA').value);
  const lngA=parseFloat(document.getElementById('lngA').value);
  const wind=parseFloat(document.getElementById('wind').value)||0;
  const dist=parseFloat(document.getElementById('dist').value)||0;
  const theta=parseFloat(document.getElementById('theta').value)||5;

  points.A={lat:latA,lng:lngA};
  let bB,bC,bD,bE;
  if(mode==="port"){
    bB=90+wind+theta; bC=270+wind-theta;
    bD=90+wind+theta; bE=270+wind-theta;
  } else {
    bB=270+wind-theta; bC=90+wind+theta;
    bD=270+wind-theta; bE=90+wind+theta;
  }
  points.B=movePoint(points.A.lat,points.A.lng,dist,bB);
  points.C=movePoint(points.B.lat,points.B.lng,dist,bC);
  points.D=movePoint(points.C.lat,points.C.lng,dist,bD);
  points.E=movePoint(points.D.lat,points.D.lng,dist,bE);

  ['A','B','C','D','E'].forEach(l=>drawPoint(l,points[l],{
    A:'#ff3b30',B:'#0088ff',C:'#00aa00',D:'#ffaa00',E:'#9900ff'
  }[l]));

  if(polyline) polyline.setMap(null);
  polyline=new google.maps.Polyline({path:[points.A,points.B,points.C,points.D,points.E],geodesic:true,strokeColor:'#444',strokeOpacity:0.9,strokeWeight:2,map});
  document.getElementById('dAC').textContent=`A～C距離：${distanceBetween(points.A,points.C).toFixed(1)} m`;
  document.getElementById('dAE').textContent=`A～E距離：${distanceBetween(points.A,points.E).toFixed(1)} m`;
}

function distanceBetween(p1,p2){
  const R=6378137.0;
  const φ1=p1.lat*Math.PI/180, φ2=p2.lat*Math.PI/180;
  const Δφ=(p2.lat-p1.lat)*Math.PI/180, Δλ=(p2.lng-p1.lng)*Math.PI/180;
  const a=Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// --- 風向セット（v3.1.8仕様） ---
function setWind(){
  if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission==="function"){
    DeviceOrientationEvent.requestPermission().then(state=>{
      if(state==="granted"){
        alert("スマホを風向に向けて少し待って設定を押してください。");
        window.addEventListener("deviceorientation", e=>{
          if(e.absolute && e.alpha!=null){
            const heading = 360 - e.alpha;
            document.getElementById("wind").value = heading.toFixed(1);
          }
        }, {once:true});
      }
    }).catch(()=>alert("方位センサーの使用が許可されませんでした。設定を確認してください。"));
  } else {
    alert("このブラウザは方位センサーに対応していません。");
  }
}

// --- 現在位置をA点に ---
function setCurrent(){
  if(!navigator.geolocation){alert("現在位置が取得できません"); return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    document.getElementById("latA").value=lat.toFixed(6);
    document.getElementById("lngA").value=lng.toFixed(6);
    points.A={lat,lng}; drawPoint("A",points.A,"#ff3b30"); calculateAll();
  },()=>alert("位置情報を取得できません"));
}

// --- 座標共有 ---
async function shareAll(){
  if(!points.A){ alert("まず計算を実行してください。"); return; }
  const wind=document.getElementById("wind").value;
  const theta=document.getElementById("theta").value;
  const text =
`【コース座標】
風向：${wind}°
θ：${theta}°
A: ${points.A.lat.toFixed(6)}, ${points.A.lng.toFixed(6)}
B: ${points.B.lat.toFixed(6)}, ${points.B.lng.toFixed(6)}
C: ${points.C.lat.toFixed(6)}, ${points.C.lng.toFixed(6)}
D: ${points.D.lat.toFixed(6)}, ${points.D.lng.toFixed(6)}
E: ${points.E.lat.toFixed(6)}, ${points.E.lng.toFixed(6)}
https://maps.google.com/?q=${points.A.lat},${points.A.lng}`;
  if(navigator.share){ try{ await navigator.share({title:"コース座標",text}); return; }catch{} }
  if(navigator.clipboard){ try{ await navigator.clipboard.writeText(text); alert("座標をコピーしました"); return; }catch{} }
  alert(text);
}

window.addEventListener("load",()=>{
  document.getElementById("calcBtn").addEventListener("click",calculateAll);
  document.getElementById("btnSetWind").addEventListener("click",setWind);
  document.getElementById("btnSetCurrent").addEventListener("click",setCurrent);
  document.getElementById("btnStarboard").addEventListener("click",()=>{mode="starboard";calculateAll();});
  document.getElementById("btnPort").addEventListener("click",()=>{mode="port";calculateAll();});
  document.getElementById("btnShare").addEventListener("click",shareAll);
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4tqxDKadoSP8XTNwzOGXwh9BprCiR9Zs&callback=initMap"></script>
</body>
</html>

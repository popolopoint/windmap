<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>コース作成ツール by Popolo</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif; margin: 10px; }
  h2 { margin: 0 0 8px 0; }
  #version { position: absolute; right: 12px; top: 12px; color: #666; font-size: 13px; }
  #inputs { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom:8px; }
  #inputs label { font-size: 14px; }
  input[type="number"] { width: 70px; padding: 6px 6px; border-radius:6px; border:1px solid #ccc; }
  button { padding: 6px 10px; border-radius:6px; border: none; color:white; cursor:pointer; }
  .btn-calc { background:#1976d2; }     /* 青：計算 */
  .btn-star { background:#4CAF50; }     /* 緑：スタボー */
  .btn-port { background:#FF9800; }     /* 橙：ポート */
  .toggleBtn { background:#666; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  #map { width:100%; height:500px; border-radius:8px; margin-top:10px; }
  #distances { margin-bottom:8px; font-weight:600; }
  .pointBox { border-radius:50%; width:32px; height:32px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; margin-right:6px; margin-bottom:6px; }
  #coordsContainer { display:flex; flex-wrap:wrap; }
  .distanceBox { background:#eee; padding:4px 6px; border-radius:6px; margin-bottom:4px; font-weight:bold; }
  #inputsMode { margin-bottom:5px; font-size:14px; }
  @media (max-width:600px){
    input[type="number"]{ width: 60px; }
    #map { height: 380px; }
  }
</style>
</head>
<body>
<h2>コース作成ツール by Popolo <small style="font-weight:normal;color:#666">(v3.1.0)</small></h2>
<div id="version">v3.1.0</div>

<div id="inputs">
  <label>緯度A：<input type="number" id="latA" step="any" value=""></label>
  <label>経度A：<input type="number" id="lngA" step="any" value=""></label>
  <label>風向(°)：<input type="number" id="wind" step="any" value=""></label>
  <label>距離(m)：<input type="number" id="dist" step="any" value="500"></label>
  <label>角度(°)：<input type="number" id="theta" step="any" value="5"></label>

  <!-- 計算ボタンとスタボー/ポートを横並び（色を分ける） -->
  <button id="calcBtn" class="btn-calc">計算</button>
  <button id="btnStar" class="btn-star">スタボー</button>
  <button id="btnPort" class="btn-port">ポート</button>

  <button id="btnSetCurrent" class="toggleBtn">現在位置をA点に</button>
</div>

<div id="inputsMode">
  A点設定方法：
  <label><input type="radio" name="aMode" value="current" checked> 現在位置</label>
  <label><input type="radio" name="aMode" value="map"> マップ</label>
  <label><input type="radio" name="aMode" value="manual"> 手入力</label>
</div>

<div id="distances">
  <div class="distanceBox" id="dAC">A～C距離：- m</div>
  <div class="distanceBox" id="dAE">A～E距離：- m</div>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:#ff3b30;">A</div>
  <div class="pointBox" id="btnB" style="background:#0088ff;">B</div>
  <div class="pointBox" id="btnC" style="background:#00aa00;">C</div>
  <div class="pointBox" id="btnD" style="background:#ffaa00;">D</div>
  <div class="pointBox" id="btnE" style="background:#9900ff;">E</div>
</div>

<div id="map"></div>

<script>
let map;
let circles={}; 
let markersLabel={};
let polyline=null;
let points={A:null,B:null,C:null,D:null,E:null};
let popoloLabelMarker=null;

/* 初期化 */
function initMap(){
  map=new google.maps.Map(document.getElementById('map'), {center:{lat:26.3318,lng:127.9179}, zoom:14});
  map.addListener('click', (e)=>{
    const mode=document.querySelector('input[name="aMode"]:checked').value;
    if(mode==='map'){
      const lat=e.latLng.lat();
      const lng=e.latLng.lng();
      document.getElementById('latA').value=lat.toFixed(6);
      document.getElementById('lngA').value=lng.toFixed(6);
      updatePointA({lat,lng});
    }
  });
}

/* 大円航跡で移動 */
function movePoint(lat,lng,distance,bearingDeg){
  const R=6378137.0;
  const brng=bearingDeg*Math.PI/180.0;
  const φ1=lat*Math.PI/180.0;
  const λ1=lng*Math.PI/180.0;
  const δ=distance/R;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(brng));
  const λ2=λ1+Math.atan2(Math.sin(brng)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return {lat:φ2*180/Math.PI, lng:λ2*180/Math.PI};
}

/* 点を描く（背景〇 と文字ラベル） */
function drawPoint(label,pos,color){
  if(!pos) return;
  if(circles[label]){circles[label].setMap(null); circles[label]=null;}
  if(markersLabel[label]){markersLabel[label].setMap(null); markersLabel[label]=null;}
  // Aは少し大きめ、B～Eはやや大きめ（視認性）
  const radius = (label==='A') ? 16 : 24;
  circles[label]=new google.maps.Circle({
    strokeColor:color, strokeOpacity:1, strokeWeight:2, fillColor:color, fillOpacity:0.85,
    map, center:pos, radius: radius
  });
  // ラベルは Marker.label で固定フォントサイズ
  markersLabel[label]=new google.maps.Marker({
    position:pos, map,
    icon:{ path: google.maps.SymbolPath.CIRCLE, scale:0 }, // invisible icon
    label:{ text:label, color:'white', fontWeight:'bold', fontSize:'12px' }
  });
  circles[label].addListener('click',()=>shareCoords(label,pos));
  markersLabel[label].addListener('click',()=>shareCoords(label,pos));
}

/* 共有処理 */
async function shareCoords(label,pos){
  if(!pos){ alert(label + '点が未設定です'); return; }
  const text=`${label}点\n緯度: ${pos.lat.toFixed(6)}\n経度: ${pos.lng.toFixed(6)}\nhttps://maps.google.com/?q=${pos.lat},${pos.lng}`;
  if(navigator.share){ try{ await navigator.share({title:`${label}座標`, text}); return;}catch(e){} }
  if(navigator.clipboard && navigator.clipboard.writeText){ try{ await navigator.clipboard.writeText(text); alert('座標をコピーしました'); return;}catch(e){} }
  const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
  try{ document.execCommand('copy'); alert('座標をコピーしました'); } catch(e){ alert(text); }
  document.body.removeChild(ta);
}

/* A点更新（マップクリックや手入力で） */
function updatePointA(pos){ points.A=pos; drawPoint('A',pos,'#ff3b30'); map.panTo(pos); }

/* 現在地をA点にして自動計算（ポート方式で自動計算） */
function setCurrentPositionA(){
  if(!navigator.geolocation){ alert("現在位置が取得できません"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    document.getElementById('latA').value=lat.toFixed(6);
    document.getElementById('lngA').value=lng.toFixed(6);
    updatePointA({lat,lng});
    calculatePort(); // 自動でポート計算
  }, err=>{ alert("位置情報取得に失敗しました"); });
}

/* 距離（ハーサイン） */
function distanceBetween(p1,p2){
  if(!p1 || !p2) return 0;
  const R=6378137.0;
  const φ1=p1.lat*Math.PI/180;
  const φ2=p2.lat*Math.PI/180;
  const dφ=(p2.lat-p1.lat)*Math.PI/180;
  const dλ=(p2.lng-p1.lng)*Math.PI/180;
  const a=Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

/* by Popolo ラベル（E近く） */
function drawPopoloLabel(){
  if(!points.E || !points.C) return;
  if(popoloLabelMarker) { popoloLabelMarker.setMap(null); popoloLabelMarker=null; }

  const distanceCE = distanceBetween(points.C, points.E);
  const bearingCE = Math.atan2(
    (points.E.lng - points.C.lng) * Math.PI/180 * Math.cos(points.E.lat * Math.PI/180),
    (points.E.lat - points.C.lat) * Math.PI/180
  );

  const offsetLat = (distanceCE / 6378137.0) * (180/Math.PI) * Math.cos(bearingCE);
  const offsetLng = (distanceCE / 6378137.0) * (180/Math.PI) * Math.sin(bearingCE) / Math.cos(points.E.lat * Math.PI/180);

  const labelPos = { lat: points.E.lat + offsetLat, lng: points.E.lng + offsetLng };

  popoloLabelMarker = new google.maps.Marker({
    position: labelPos,
    map,
    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
    label: {
      text: 'by Popolo Point',
      color: '#888',
      fontSize: '12px',
      fontWeight: 'bold'
    }
  });
}

/* 共通：描画とポリライン、距離表示 */
function drawAllAndUI(){
  ['A','B','C','D','E'].forEach(l=>{
    if(points[l]) drawPoint(l, points[l], getColor(l));
  });
  if(polyline) polyline.setMap(null);
  const path = [points.A, points.B, points.C, points.D, points.E].filter(p=>p);
  if(path.length >= 2){
    polyline = new google.maps.Polyline({ path: path, geodesic:true, strokeColor:'#444', strokeOpacity:0.9, strokeWeight:2, map});
  }
  const dAC = (points.A && points.C) ? distanceBetween(points.A, points.C).toFixed(1) : '-';
  const dAE = (points.A && points.E) ? distanceBetween(points.A, points.E).toFixed(1) : '-';
  document.getElementById('dAC').textContent = 'A～C距離：▢' + dAC + ' m▢';
  document.getElementById('dAE').textContent = 'A～E距離：▢' + dAE + ' m▢';
  drawPopoloLabel();
}

/* 色 */
function getColor(l){ switch(l){ case 'A': return '#ff3b30'; case 'B': return '#0088ff'; case 'C': return '#00aa00'; case 'D': return '#ffaa00'; case 'E': return '#9900ff'; default: return '#888'; } }

/* ---------- ポート（既存計算） ---------- */
function calculatePort(){
  const latA = parseFloat(document.getElementById('latA').value);
  const lngA = parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA) || isNaN(lngA)){ alert("A点が未設定です"); return; }
  const wind = parseFloat(document.getElementById('wind').value) || 0;
  const dist = parseFloat(document.getElementById('dist').value) || 0;
  const theta = parseFloat(document.getElementById('theta').value) || 5;
  points.A = { lat: latA, lng: lngA };
  const bB = 90 + wind + theta;
  const bC = 270 + wind - theta;
  const bD = 90 + wind + theta;
  const bE = 270 + wind - theta;
  points.B = movePoint(points.A.lat, points.A.lng, dist, bB);
  points.C = movePoint(points.B.lat, points.B.lng, dist, bC);
  points.D = movePoint(points.C.lat, points.C.lng, dist, bD);
  points.E = movePoint(points.D.lat, points.D.lng, dist, bE);
  drawAllAndUI();
}

/* ---------- スタボー（指定の式） ---------- */
function calculateStarboard(){
  const latA = parseFloat(document.getElementById('latA').value);
  const lngA = parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA) || isNaN(lngA)){ alert("A点が未設定です"); return; }
  const wind = parseFloat(document.getElementById('wind').value) || 0;
  const dist = parseFloat(document.getElementById('dist').value) || 0;
  const theta = parseFloat(document.getElementById('theta').value) || 5;
  points.A = { lat: latA, lng: lngA };
  const bB = 270 + wind - theta;
  const bC = 90 + wind + theta;
  const bD = 270 + wind - theta;
  const bE = 90 + wind + theta;
  points.B = movePoint(points.A.lat, points.A.lng, dist, bB);
  points.C = movePoint(points.B.lat, points.B.lng, dist, bC);
  points.D = movePoint(points.C.lat, points.C.lng, dist, bD);
  points.E = movePoint(points.D.lat, points.D.lng, dist, bE);
  drawAllAndUI();
}

/* UI 丸ボタンの共有設定 */
['A','B','C','D','E'].forEach(l=>{
  const el = document.getElementById('btn' + l);
  if(el) el.addEventListener('click', ()=> {
    if(!points[l]) { alert(l + '点が未設定です。'); return; }
    shareCoords(l, points[l]);
  });
});

/* イベント割り当て */
window.addEventListener('load', ()=>{
  initMap();
  document.getElementById('calcBtn').addEventListener('click', ()=> { calculatePort(); });
  document.getElementById('btnPort').addEventListener('click', ()=> { calculatePort(); });
  document.getElementById('btnStar').addEventListener('click', ()=> { calculateStarboard(); });
  document.getElementById('btnSetCurrent').addEventListener('click', ()=> { setCurrentPositionA(); });
});
</script>

<!-- Google Maps APIキー（ご指定のキー） -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4tqxDKadoSP8XTNwzOGXwh9BprCiR9Zs&callback=initMap"></script>

</body>
</html>

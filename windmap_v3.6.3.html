<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>コース作るくん by Popolo v3.6.3</title>
<style>
:root{
  --blue:#1976d2; --purple:#6a1b9a; --red:#d32f2f; --green:#2e7d32; --orange:#f57c00; --gray:#888;
}
body { font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN","メイリオ",Meiryo,sans-serif; margin:10px; color:#222; }
h2 { margin:0 0 8px 0; font-size:18px; }
#version { position:absolute; right:12px; top:12px; color:#666; font-size:13px; }
#inputs { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
#inputs label { font-size:14px; }
input[type="number"] { width:70px; padding:6px; border-radius:6px; border:1px solid #ccc; }
button { padding:6px 10px; border-radius:6px; border:none; color:white; cursor:pointer; font-weight:bold; }
button.gray { background:#888; }
#map { width:100%; height:500px; border-radius:8px; margin-top:10px; box-shadow:0 1px 2px rgba(0,0,0,.08); }
#distances { margin-bottom:8px; font-weight:600; display:flex; gap:8px; flex-wrap:wrap; }
.pointBox { border-radius:50%; width:32px; height:32px; display:flex; justify-content:center; align-items:center; color:white; font-weight:bold; cursor:pointer; margin-right:6px; margin-bottom:6px; }
#coordsContainer { display:flex; flex-wrap:wrap; align-items:center; gap:6px; }
.distanceBox { background:#eee; padding:4px 6px; border-radius:6px; margin-bottom:4px; font-weight:bold; }
#inputsMode { margin-bottom:5px; font-size:14px; color:#333; }
#calcBtn { background: var(--blue); }
#btnWindSet { background: var(--purple); }
#btnSetCurrent { background: var(--red); }
#btnStarboard { background: var(--green); }
#btnPort { background: var(--orange); }
#btnShareAll { background:#555;}
#courseSelect { padding:4px 6px; border-radius:6px; border:1px solid #ccc; }
#targetSelect { padding:4px 6px; border-radius:6px; border:1px solid #ccc; }
/* modal */
.overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); z-index:2000;}
.modal{background:#fff; padding:16px; border-radius:10px; width:92%; max-width:380px; box-shadow:0 8px 24px rgba(0,0,0,0.25); text-align:center;}
.modal h3{margin:0 0 8px 0; font-size:16px;}
.modal p{margin:6px 0 12px 0;color:#333;font-size:14px;}
.modal .reading{font-size:20px;font-weight:700;color:#111;margin-bottom:12px;}
.modal .buttons{display:flex; gap:8px; justify-content:center;}
.modal button{padding:8px 12px; border-radius:8px; font-weight:600;}
.modal .btnConfirm{background: var(--purple); color:white;}
.modal .btnCancel{background:#ccc;color:#111;}
.note{font-size:13px;color:#666;margin-top:6px;}
@media (max-width:600px){
  input[type="number"]{ width:90px; }
  #map{ height:420px; }
}
</style>
</head>
<body>

<h2>コース作るくん <span style="font-size:0.7em;">by Popolo v3.6.3目標物補正</span></h2>
<div id="version">v3.6.3</div>

<!-- コンパス許可ボタン -->
<button id="compassPermissionBtn" style="
   position:absolute; top:10px; right:10px;
   padding:10px; background:#ff4444; color:#fff;
   border:none; border-radius:6px; font-weight:bold;
   z-index:10000;
">コンパス許可 ←ここをタップ</button>

<div id="inputs">
  <label>緯度A：<input type="number" id="latA" step="any" value=""></label>
  <label>経度A：<input type="number" id="lngA" step="any" value=""></label>
  <label>目標物T：
    <select id="targetSelect">
      <option value="">選択してください</option>
      <option value="gushikawa">具志川火力発電所</option>
      <option value="kin">金武火力発電所</option>
      <option value="kujira">くじらのしっぽ</option>
      <option value="ayashi">海の駅あやはし</option>
      <option value="heianza">平安座海中大橋</option>
    </select>
  </label>
  <label>風向H(°)：<input type="number" id="wind" step="any" value=""></label>
  <label>距離(m)：<input type="number" id="dist" step="any" value="500"></label>
  <label>角度(°)：<input type="number" id="theta" step="any" value="5"></label>
  <label>コース：
    <select id="courseSelect">
      <option value="mcourse">Ｍコース</option>
      <option value="figure8">フィギア８</option>
    </select>
  </label>

  <button id="btnWindSet">風向Hセット</button>
  <button id="calcBtn">計算</button>
  <button id="btnSetCurrent">A点現在地セット</button>
  <button id="btnStarboard" title="スタボー">スタボー</button>
  <button id="btnPort" title="ポート">ポート</button>
  <button id="btnShareAll">全座標送信</button>
</div>

<div id="inputsMode">
  A点設定方法：
  <label><input type="radio" name="aMode" value="current" checked> 現在位置</label>
  <label><input type="radio" name="aMode" value="map"> マップタップ</label>
  <label><input type="radio" name="aMode" value="manual"> 手入力</label>
</div>

<div id="distances">
  <div class="distanceBox" id="dAC">A～C距離：- m</div>
  <div class="distanceBox" id="dAE">A～E距離：- m</div>
</div>

<div id="coordsContainer">
  <div class="pointBox" id="btnA" style="background:#ff3b30;">A</div>
  <div class="pointBox" id="btnB" style="background:#0088ff;">B</div>
  <div class="pointBox" id="btnC" style="background:#00aa00;">C</div>
  <div class="pointBox" id="btnD" style="background:#ffaa00;">D</div>
  <div class="pointBox" id="btnE" style="background:#9900ff;">E</div>
</div>

<div id="map"></div>

<!-- 風向モーダル -->
<div id="windModal" style="display:none;" aria-hidden="true">
  <div class="overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>風向Hセット</h3>
      <p id="modalInstruction">スマホを風向に向けて少し待ってから「設定」を押してください。</p>
      <div class="reading" id="headingRead">--°</div>
      <div class="buttons">
        <button class="btnConfirm" id="modalSetBtn">設定</button>
        <button class="btnCancel" id="modalCloseBtn">閉じる</button>
      </div>
      <div class="note" id="modalNote">端末の許可が必要な場合は画面の案内に従ってください。</div>
    </div>
  </div>
</div>

<script>
let map, circles={}, markersLabel={}, polyline=null;
let points = {A:null,B:null,C:null,D:null,E:null};
let currentIsPort = true;
let currentHeading = null;

// 目標物座標定義
const targetCoords = {
  gushikawa: {lat:26.3617,lng:127.8657},
  kin: {lat:26.4398,lng:127.9459},
  kujira: {lat:26.3694,lng:127.9274},
  ayashi: {lat:26.3569,lng:127.9432},
  heianza: {lat:26.3410,lng:127.9602}
};

// --- マップ ---
function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat:26.3318,lng:127.9179 }, zoom:14 });
  map.addListener('click', (e)=>{
    if(document.querySelector('input[name="aMode"]:checked').value==='map'){
      const lat=e.latLng.lat(), lng=e.latLng.lng();
      document.getElementById('latA').value = lat.toFixed(6);
      document.getElementById('lngA').value = lng.toFixed(6);
      updatePointA({lat,lng});
    }
  });
}

// --- 点描画 ---
function clearPoint(label){ if(circles[label]){ circles[label].setMap(null); delete circles[label]; } if(markersLabel[label]){ markersLabel[label].setMap(null); delete markersLabel[label]; } }
function drawPoint(label,pos,color,radius=12){
  if(!pos){ clearPoint(label); return; }
  clearPoint(label);
  const actualRadius = (label==='A')?radius+4:radius;
  circles[label]=new google.maps.Circle({ strokeColor:color, strokeOpacity:1, strokeWeight:2, fillColor:color, fillOpacity:0.85, map, center:pos, radius:actualRadius });
  markersLabel[label]=new google.maps.Marker({ position:pos, map, icon:{ path:google.maps.SymbolPath.CIRCLE, scale:0 }, label:{ text:label, color:"white", fontWeight:"bold", fontSize:"14px" } });
  circles[label].addListener('click',()=>shareCoords(label,pos));
  markersLabel[label].addListener('click',()=>shareCoords(label,pos));
}
function updatePointA(pos){ points.A=pos; drawPoint('A',pos,'#ff3b30'); map.panTo(pos); }
function setCurrentPositionA(){
  if(!navigator.geolocation){ alert("現在位置が取得できません"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude,lng=pos.coords.longitude;
    document.getElementById('latA').value=lat.toFixed(6);
    document.getElementById('lngA').value=lng.toFixed(6);
    updatePointA({lat,lng});
    calculatePort();
  },()=>{ alert("位置情報取得に失敗しました"); });
}

// --- 座標計算 ---
function movePoint(lat,lng,dist,bearing){
  const R=6378137, brng=(bearing%360)*Math.PI/180;
  const φ1=lat*Math.PI/180, λ1=lng*Math.PI/180, δ=dist/R;
  const φ2=Math.asin(Math.sin(φ1)*Math.cos(δ)+Math.cos(φ1)*Math.sin(δ)*Math.cos(brng));
  const λ2=λ1+Math.atan2(Math.sin(brng)*Math.sin(δ)*Math.cos(φ1), Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2));
  return {lat: φ2*180/Math.PI, lng: λ2*180/Math.PI};
}

function distanceBetween(p1,p2){ if(!p1||!p2) return 0; const R=6378137; const φ1=p1.lat*Math.PI/180, φ2=p2.lat*Math.PI/180; const dφ=(p2.lat-p1.lat)*Math.PI/180, dλ=(p2.lng-p1.lng)*Math.PI/180; const a=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }

// --- コース計算 ---
function calculatePort(){ currentIsPort=true; calculateCourse(); }
function calculateStarboard(){ currentIsPort=false; calculateCourse(); }

function calculateCourse(){
  const latA=parseFloat(document.getElementById('latA').value);
  const lngA=parseFloat(document.getElementById('lngA').value);
  if(isNaN(latA)||isNaN(lngA)){ alert("A点が未設定です"); return; }
  const wind=parseFloat(document.getElementById('wind').value)||0;
  const dist=parseFloat(document.getElementById('dist').value)||0;
  const theta=parseFloat(document.getElementById('theta').value)||0;
  const course=document.getElementById('courseSelect').value;
  points.A={lat:latA,lng:lngA};

  // 目標物T
  const tSel=document.getElementById('targetSelect').value;
  if(tSel && targetCoords[tSel]){
    points.T=targetCoords[tSel];
  } else {
    points.T=null;
  }

  // --- 補正風向に基づくB～E ---
  if(points.A && points.T){
    const delta = Math.atan2(points.T.lng-points.A.lng, points.T.lat-points.A.lat)*180/Math.PI;
    const correctedWind = (wind-(delta-currentHeading)+360)%360;
    // 自動入力
    document.getElementById('wind').value=Math.round(correctedWind);

    // B～E自動計算
    const bB = correctedWind+(currentIsPort?90+theta:270-theta);
    points.B=movePoint(points.A.lat,points.A.lng,dist,bB);
    const distBC = dist*Math.cos(theta*Math.PI/180);
    const bearingC = currentIsPort?correctedWind+270:correctedWind+90;
    points.C=movePoint(points.B.lat,points.B.lng,distBC,bearingC);
    points.D=movePoint(points.C.lat,points.C.lng,dist,bearingC+90);
    points.E=movePoint(points.D.lat,points.D.lng,dist,bearingC-90);
  }

  // 描画
  ['A','B','C','D','E'].forEach(l=>{ if(points[l]) drawPoint(l,points[l],{'A':'#ff3b30','B':'#0088ff','C':'#00aa00','D':'#ffaa00','E':'#9900ff'}[l]); else clearPoint(l); });

  // ポリライン描画
  if(polyline) polyline.setMap(null);
  const path=[];['A','B','C','D','E'].forEach(k=>{ if(points[k]) path.push(points[k]); });
  if(path.length>=2) polyline=new google.maps.Polyline({ path, geodesic:true, strokeColor:'#444', strokeOpacity:0.9, strokeWeight:2, map });
}

// --- コンパス許可 & 風向 ---
const compassBtn = document.getElementById('compassPermissionBtn');
function handleOrientation(e){
  let heading=null;
  if(e.webkitCompassHeading!==undefined) heading=e.webkitCompassHeading;
  else if(e.alpha!==null) heading=(360-e.alpha+360)%360;
  if(heading!==null) currentHeading=heading;
}
compassBtn.addEventListener('click', ()=>{
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(res=>{
      if(res==='granted'){
        window.addEventListener('deviceorientationabsolute',handleOrientation,true);
        window.addEventListener('deviceorientation',handleOrientation,true);
        compassBtn.style.display='none';
      } else alert('コンパスの使用が許可されませんでした。');
    }).catch(console.error);
  } else {
    window.addEventListener('deviceorientationabsolute',handleOrientation,true);
    window.addEventListener('deviceorientation',handleOrientation,true);
    compassBtn.style.display='none';
  }
});

const modalRoot=document.getElementById('windModal');
const headingReadEl=document.getElementById('headingRead');
const modalSetBtn=document.getElementById('modalSetBtn');
const modalCloseBtn=document.getElementById('modalCloseBtn');
let headingSamples=[], headingWatcher=null;
function openWindModal(){ headingSamples=[]; modalRoot.style.display='block'; startOrientationListening(); }
function closeWindModal(){ stopOrientationListening(); modalRoot.style.display='none'; }
function normalizeHeadingFromEvent(e){
  if(typeof e.webkitCompassHeading==='number') return e.webkitCompassHeading;
  if(e.alpha===null) return null;
  let heading=360-e.alpha;
  if(typeof window.screen.orientation!=='undefined' && typeof window.screen.orientation.angle==='number') heading=(heading+window.screen.orientation.angle)%360;
  else if(typeof window.orientation==='number') heading=(heading+window.orientation)%360;
  return (heading+360)%360;
}
function startOrientationListening(){ headingWatcher=e=>{ const h=normalizeHeadingFromEvent(e); if(h!==null){ headingSamples.push(h); if(headingSamples.length>10) headingSamples.shift(); headingReadEl.textContent=Math.round(headingSamples.reduce((a,b)=>a+b)/headingSamples.length); } }; window.addEventListener('deviceorientation', headingWatcher, true); }
function stopOrientationListening(){ window.removeEventListener('deviceorientation',headingWatcher,true); }
modalSetBtn.addEventListener('click', ()=>{
  if(headingSamples.length>0) { document.getElementById('wind').value=Math.round(headingSamples.reduce((a,b)=>a+b)/headingSamples.length); currentHeading=document.getElementById('wind').value; closeWindModal(); } });
modalCloseBtn.addEventListener('click', closeWindModal);

document.getElementById('btnWindSet').addEventListener('click', openWindModal);
document.getElementById('btnSetCurrent').addEventListener('click', setCurrentPositionA);
document.getElementById('btnStarboard').addEventListener('click', calculateStarboard);
document.getElementById('btnPort').addEventListener('click', calculatePort);
document.getElementById('calcBtn').addEventListener('click', calculateCourse);

// --- 座標送信 ---
function shareCoords(label,pos){ if(!pos) return; alert(label+"座標送信\nLat:"+pos.lat.toFixed(6)+" Lng:"+pos.lng.toFixed(6)); }
document.getElementById('btnA').addEventListener('click',()=>shareCoords('A',points.A));
document.getElementById('btnB').addEventListener('click',()=>shareCoords('B',points.B));
document.getElementById('btnC').addEventListener('click',()=>shareCoords('C',points.C));
document.getElementById('btnD').addEventListener('click',()=>shareCoords('D',points.D));
document.getElementById('btnE').addEventListener('click',()=>shareCoords('E',points.E));
document.getElementById('btnShareAll').addEventListener('click',()=>{
  let txt="全座標送信\n";
  ['A','B','C','D','E'].forEach(k=>{ if(points[k]) txt+=k+" Lat:"+points[k].lat.toFixed(6)+" Lng:"+points[k].lng.toFixed(6)+"\n"; });
  alert(txt);
});

// --- Google Maps API読み込み ---
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4tqxDKadoSP8XTNwzOGXwh9BprCiR9Zs&callback=initMap"></script>
</body>
</html>
